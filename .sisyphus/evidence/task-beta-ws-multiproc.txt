
========== [TASK] Beta QA Runner（多进程 WS + Celery 事件可达） ==========
repo_root=/root/1codes/1para
compose_project=qa-beta-ws-multiproc-1771174633-485599
ports: postgres=43997 redis=35185 server=57471
tmp_dir=/tmp/tmp.xVU6qAWdZj
evidence_file=/root/1codes/1para/.sisyphus/evidence/task-beta-ws-multiproc.txt

========== [STEP START] 启动依赖拓扑（deps） ==========
+ docker compose -p <project> up -d postgres redis  # COMPOSE_PROJECT_NAME=<project> POSTGRES_PORT=<dynamic> REDIS_PORT=<dynamic>
 Network qa-beta-ws-multiproc-1771174633-485599_default Creating 
 Network qa-beta-ws-multiproc-1771174633-485599_default Created 
 Volume qa-beta-ws-multiproc-1771174633-485599_pg_data Creating 
 Volume qa-beta-ws-multiproc-1771174633-485599_pg_data Created 
 Volume qa-beta-ws-multiproc-1771174633-485599_redis_data Creating 
 Volume qa-beta-ws-multiproc-1771174633-485599_redis_data Created 
 Container qa-beta-ws-multiproc-1771174633-485599-postgres Creating 
 Container qa-beta-ws-multiproc-1771174633-485599-redis Creating 
 Container qa-beta-ws-multiproc-1771174633-485599-postgres Created 
 Container qa-beta-ws-multiproc-1771174633-485599-redis Created 
 Container qa-beta-ws-multiproc-1771174633-485599-redis Starting 
 Container qa-beta-ws-multiproc-1771174633-485599-postgres Starting 
 Container qa-beta-ws-multiproc-1771174633-485599-postgres Started 
 Container qa-beta-ws-multiproc-1771174633-485599-redis Started 
NAME                                              IMAGE                    COMMAND                   SERVICE    CREATED          STATUS                    PORTS
qa-beta-ws-multiproc-1771174633-485599-postgres   pgvector/pgvector:pg16   "docker-entrypoint.s…"   postgres   12 seconds ago   Up 11 seconds (healthy)   0.0.0.0:43997->5432/tcp, [::]:43997->5432/tcp
qa-beta-ws-multiproc-1771174633-485599-redis      redis:7-alpine           "docker-entrypoint.s…"   redis      12 seconds ago   Up 11 seconds (healthy)   0.0.0.0:35185->6379/tcp, [::]:35185->6379/tcp

========== [STEP OK] 启动依赖拓扑（deps） ==========

========== [STEP START] 迁移（alembic upgrade head） ==========
+ cd server && DATABASE_URL=postgresql+psycopg://... uv run alembic upgrade head
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> 6db398364679, create auth tables
INFO  [alembic.runtime.migration] Running upgrade 6db398364679 -> f1dcf9f0abe6, create beta tables
INFO  [alembic.runtime.migration] Running upgrade f1dcf9f0abe6 -> 7eed360f132d, ws event store
INFO  [alembic.runtime.migration] Running upgrade 7eed360f132d -> b0d31c0c7a2e, auth rate limits
INFO  [alembic.runtime.migration] Running upgrade b0d31c0c7a2e -> c6c8f2a0a9d1, email case-insensitive uniqueness
INFO  [alembic.runtime.migration] Running upgrade c6c8f2a0a9d1 -> d2e4a7b5c1f0, password reset tokens
INFO  [alembic.runtime.migration] Running upgrade d2e4a7b5c1f0 -> e8a4c1b2d3f4, llm usage events
INFO  [alembic.runtime.migration] Running upgrade e8a4c1b2d3f4 -> 9c1f0b2a3d4e, review fields for ugc + plugin packages

========== [STEP OK] 迁移（alembic upgrade head） ==========

========== [STEP START] 启动服务（uvicorn multiproc） ==========
+ cd server && uv run uvicorn app.main:app --workers 2 --host 127.0.0.1 --port <dynamic>
ws_support_backend=wsproto
server_pgid=486633
server_log=/tmp/tmp.xVU6qAWdZj/uvicorn.log
server_ready_probe=tcp_ok=True

========== [STEP OK] 启动服务（uvicorn multiproc） ==========

========== [STEP START] 启动 Worker（celery non-eager） ==========
+ cd server && uv run celery -A app.workers.celery_app:celery_app worker -l INFO -c 1
worker_pgid=486644
worker_log=/tmp/tmp.xVU6qAWdZj/celery.log
worker_ready_probe=file_contains=True

========== [STEP OK] 启动 Worker（celery non-eager） ==========

========== [STEP START] 硬验收（WS + Celery 事件可达） ==========
+ node(ws) 连接 /ws/v1 并触发 /api/v1/dreams/trigger，等待 TIMELINE_EVENT
node_version=24.13.0
ws_url=ws://127.0.0.1:57471/ws/v1?save_id=8af5eac2-7dbd-499f-8ade-7527f42a3511&resume_from=0&device_id=qa_beta_eda1dbcf
qa_task_id=947d9288-d746-431a-9199-ec1033dcd9b9
ws_evidence={"email":"qa-beta-1771174656292-8c4ccc31@example.com","save_id":"8af5eac2-7dbd-499f-8ade-7527f42a3511","trigger_task_id":"947d9288-d746-431a-9199-ec1033dcd9b9","ws_frame_type":"TIMELINE_EVENT","ws_frame_seq":1,"ws_frame_server_event_id":"ca5643c2-0d9a-4dd3-9737-74b793c907f3:8af5eac2-7dbd-499f-8ade-7527f42a3511:1","ws_payload_event":"DREAM_ENTRY_CREATED","assert_ws_timeline_event":true,"assert_ws_payload_event_is_dream_entry_created":true}
assert_ws_timeline_event=True
assert_ws_payload_event=DREAM_ENTRY_CREATED
assert_task_id_from_trigger=947d9288-d746-431a-9199-ec1033dcd9b9
file_contains=True
assert_worker_processed_task_id=True

========== [STEP OK] 硬验收（WS + Celery 事件可达） ==========

========== [STEP START] 证据/日志摘要（evidence） ==========
+ 写入证据文件 + 输出 server/worker 日志尾部；最后由 trap 清理 docker/进程

--- uvicorn.log (tail) ---
INFO:     Uvicorn running on http://127.0.0.1:57471 (Press CTRL+C to quit)
INFO:     Started parent process [486638]
INFO:     Started server process [486641]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Started server process [486640]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     127.0.0.1:44398 - "POST /api/v1/auth/register HTTP/1.1" 201 Created
INFO:     127.0.0.1:44398 - "POST /api/v1/saves HTTP/1.1" 201 Created
INFO:     127.0.0.1:44402 - "WebSocket /ws/v1?save_id=8af5eac2-7dbd-499f-8ade-7527f42a3511&resume_from=0&device_id=qa_beta_eda1dbcf" [accepted]
INFO:     127.0.0.1:44398 - "POST /api/v1/dreams/trigger HTTP/1.1" 200 OK

--- celery.log (tail) ---
/root/1codes/1para/server/.venv/lib/python3.12/site-packages/celery/platforms.py:841: SecurityWarning: You're running the worker with superuser privileges: this is
absolutely not recommended!

Please specify a different user using the --uid option.

User information: uid=0 euid=0 gid=0 egid=0

  warnings.warn(SecurityWarning(ROOT_DISCOURAGED.format(
 
 -------------- celery@ps v5.6.2 (recovery)
--- ***** ----- 
-- ******* ---- Linux-6.8.0-100-generic-x86_64-with-glibc2.39 2026-02-16 00:57:34
- *** --- * --- 
- ** ---------- [config]
- ** ---------- .> app:         para:0x7ae06b1d0200
- ** ---------- .> transport:   redis://127.0.0.1:35185/0
- ** ---------- .> results:     redis://127.0.0.1:35185/0
- *** --- * --- .> concurrency: 1 (prefork)
-- ******* ---- .> task events: OFF (enable -E to monitor tasks in this worker)
--- ***** ----- 
 -------------- [queues]
                .> celery           exchange=celery(direct) key=celery
                

[tasks]
  . app.workers.tasks.dreams.task_12_generate_dream_entry
  . app.workers.tasks.dreams.task_12_generate_dreams_for_all_saves
  . app.workers.tasks.gallery.task_17_generate_gallery_image
  . app.workers.tasks.knowledge.task_13_index_knowledge_material
  . app.workers.tasks.timeline.task_18_generate_timeline_event
  . app.workers.tasks.timeline.task_18_generate_timeline_events_for_all_saves

2026-02-16 00:57:35 INFO [celery.worker.consumer.connection] [rid=-] Connected to redis://127.0.0.1:35185/0
2026-02-16 00:57:35 INFO [celery.worker.consumer.mingle] [rid=-] mingle: searching for neighbors
2026-02-16 00:57:36 INFO [celery.worker.consumer.mingle] [rid=-] mingle: all alone
2026-02-16 00:57:36 INFO [celery.apps.worker] [rid=-] celery@ps ready.
2026-02-16 00:57:36 INFO [celery.worker.strategy] [rid=-] Task app.workers.tasks.dreams.task_12_generate_dream_entry[947d9288-d746-431a-9199-ec1033dcd9b9] received
2026-02-16 00:57:36 INFO [celery.app.trace] [rid=-] Task app.workers.tasks.dreams.task_12_generate_dream_entry[947d9288-d746-431a-9199-ec1033dcd9b9] succeeded in 0.14475934799702372s: {'dream_entry_id': '98048cb5-26ce-468b-ad43-57e2740d3664', 'ws_frame': {'type': 'TIMELINE_EVENT', 'seq': 1, 'server_event_id': 'ca5643c2-0d9a-4dd3-9737-74b793c907f3:8af5eac2-7dbd-499f-8ade-7527f42a3511:1'}}

assert_evidence_file=/root/1codes/1para/.sisyphus/evidence/task-beta-ws-multiproc.txt

========== [STEP OK] 证据/日志摘要（evidence） ==========

========== [TASK] ALL GREEN ==========

========== [CLEANUP] 清理进程与 docker compose（project 仅本次） ==========
+ kill -TERM -- -486644  # celery worker process group
+ kill -TERM -- -486633  # uvicorn process group
+ docker compose -p qa-beta-ws-multiproc-1771174633-485599 down -v

--- uvicorn.log (tail, cleanup) ---
INFO:     Uvicorn running on http://127.0.0.1:57471 (Press CTRL+C to quit)
INFO:     Started parent process [486638]
INFO:     Started server process [486641]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Started server process [486640]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     127.0.0.1:44398 - "POST /api/v1/auth/register HTTP/1.1" 201 Created
INFO:     127.0.0.1:44398 - "POST /api/v1/saves HTTP/1.1" 201 Created
INFO:     127.0.0.1:44402 - "WebSocket /ws/v1?save_id=8af5eac2-7dbd-499f-8ade-7527f42a3511&resume_from=0&device_id=qa_beta_eda1dbcf" [accepted]
INFO:     127.0.0.1:44398 - "POST /api/v1/dreams/trigger HTTP/1.1" 200 OK
INFO:     Shutting down
INFO:     Shutting down
INFO:     Received SIGTERM, exiting.
INFO:     Received SIGTERM, exiting.
INFO:     Terminated child process [486640]
INFO:     Terminated child process [486641]
INFO:     Waiting for child process [486640]
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [486640]
INFO:     Waiting for child process [486641]
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [486641]
INFO:     Stopping parent process [486638]

--- celery.log (tail, cleanup) ---
/root/1codes/1para/server/.venv/lib/python3.12/site-packages/celery/platforms.py:841: SecurityWarning: You're running the worker with superuser privileges: this is
absolutely not recommended!

Please specify a different user using the --uid option.

User information: uid=0 euid=0 gid=0 egid=0

  warnings.warn(SecurityWarning(ROOT_DISCOURAGED.format(
 
 -------------- celery@ps v5.6.2 (recovery)
--- ***** ----- 
-- ******* ---- Linux-6.8.0-100-generic-x86_64-with-glibc2.39 2026-02-16 00:57:34
- *** --- * --- 
- ** ---------- [config]
- ** ---------- .> app:         para:0x7ae06b1d0200
- ** ---------- .> transport:   redis://127.0.0.1:35185/0
- ** ---------- .> results:     redis://127.0.0.1:35185/0
- *** --- * --- .> concurrency: 1 (prefork)
-- ******* ---- .> task events: OFF (enable -E to monitor tasks in this worker)
--- ***** ----- 
 -------------- [queues]
                .> celery           exchange=celery(direct) key=celery
                

[tasks]
  . app.workers.tasks.dreams.task_12_generate_dream_entry
  . app.workers.tasks.dreams.task_12_generate_dreams_for_all_saves
  . app.workers.tasks.gallery.task_17_generate_gallery_image
  . app.workers.tasks.knowledge.task_13_index_knowledge_material
  . app.workers.tasks.timeline.task_18_generate_timeline_event
  . app.workers.tasks.timeline.task_18_generate_timeline_events_for_all_saves

2026-02-16 00:57:35 INFO [celery.worker.consumer.connection] [rid=-] Connected to redis://127.0.0.1:35185/0
2026-02-16 00:57:35 INFO [celery.worker.consumer.mingle] [rid=-] mingle: searching for neighbors
2026-02-16 00:57:36 INFO [celery.worker.consumer.mingle] [rid=-] mingle: all alone
2026-02-16 00:57:36 INFO [celery.apps.worker] [rid=-] celery@ps ready.
2026-02-16 00:57:36 INFO [celery.worker.strategy] [rid=-] Task app.workers.tasks.dreams.task_12_generate_dream_entry[947d9288-d746-431a-9199-ec1033dcd9b9] received
2026-02-16 00:57:36 INFO [celery.app.trace] [rid=-] Task app.workers.tasks.dreams.task_12_generate_dream_entry[947d9288-d746-431a-9199-ec1033dcd9b9] succeeded in 0.14475934799702372s: {'dream_entry_id': '98048cb5-26ce-468b-ad43-57e2740d3664', 'ws_frame': {'type': 'TIMELINE_EVENT', 'seq': 1, 'server_event_id': 'ca5643c2-0d9a-4dd3-9737-74b793c907f3:8af5eac2-7dbd-499f-8ade-7527f42a3511:1'}}

worker: Warm shutdown (MainProcess)

worker: Warm shutdown (MainProcess)
+ rm -rf /tmp/tmp.xVU6qAWdZj
