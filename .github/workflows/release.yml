name: release

on:
  push:
    tags:
      - "v0.*.*"

permissions:
  contents: read

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  windows-nsis:
    name: windows-nsis
    needs: ci
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: client/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Version check (tag must match repo)
        run: python scripts/sync_versions.py --check

      - name: Install client dependencies (npm ci)
        run: npm -C client ci

      - name: Package (Windows NSIS)
        run: npm -C client run package:win

      - name: Verify fuses (packaged binary)
        run: npm -C client run verify:fuses

      - name: Resolve installer + sha256
        id: assets
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $distRoot = Join-Path $PWD 'client/dist-electron'
          if (!(Test-Path $distRoot)) {
            throw "dist directory not found: $distRoot"
          }

          $exeFiles = Get-ChildItem -Path $distRoot -Recurse -File -Filter '*.exe' |
            Where-Object {
              $_.FullName -notmatch '(?i)\\win-unpacked\\' -and
              $_.Name -notmatch '(?i)unpacked'
            }

          if (-not $exeFiles -or $exeFiles.Count -lt 1) {
            throw "No .exe files found under $distRoot (expected NSIS installer)"
          }

          $installer = $exeFiles |
            Where-Object { $_.Name -match '(?i)setup' } |
            Sort-Object Length -Descending |
            Select-Object -First 1

          if (-not $installer) {
            $installer = $exeFiles | Sort-Object Length -Descending | Select-Object -First 1
          }

          $hash = (Get-FileHash -Algorithm SHA256 -Path $installer.FullName).Hash.ToLower()
          $shaPath = "$($installer.FullName).sha256"
          "$hash  $($installer.Name)" | Out-File -FilePath $shaPath -Encoding ascii

          $workspace = $env:GITHUB_WORKSPACE.TrimEnd('\\') + '\\'
          $installerRel = $installer.FullName.Replace($workspace, '')
          $shaRel = $shaPath.Replace($workspace, '')

          "installer_path=$installerRel" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "sha256_path=$shaRel" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Verify silent install (NSIS data dir)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $installerRel = "${{ steps.assets.outputs.installer_path }}"
          if (-not $installerRel) {
            throw "installer_path output missing"
          }

          $installerPath = Join-Path $env:GITHUB_WORKSPACE $installerRel
          if (!(Test-Path $installerPath)) {
            throw "installer not found: $installerPath"
          }

          $id = [System.Guid]::NewGuid().ToString('N')
          $installDir = Join-Path $env:RUNNER_TEMP "para-install-$id"
          $dataDir = Join-Path $env:RUNNER_TEMP "para-data-$id"

          if (Test-Path $installDir) { Remove-Item -Recurse -Force $installDir }
          if (Test-Path $dataDir) { Remove-Item -Recurse -Force $dataDir }

          New-Item -ItemType Directory -Path $installDir | Out-Null
          New-Item -ItemType Directory -Path $dataDir | Out-Null

          # Note: NSIS requires /D= to be the last argument, and it must not be quoted.
          $args = @(
            '/S',
            "/DATA_DIR=$dataDir",
            "/D=$installDir"
          )

          $p = Start-Process -FilePath $installerPath -ArgumentList $args -Wait -PassThru
          if ($p.ExitCode -ne 0) {
            throw "installer exit code: $($p.ExitCode)"
          }

          $configDir = Join-Path $env:APPDATA 'Para Desktop'
          $configPath = Join-Path $configDir 'para.config.json'
          if (!(Test-Path $configPath)) {
            throw "config not written: $configPath"
          }

          $json = Get-Content -Path $configPath -Raw | ConvertFrom-Json
          $expected = ($dataDir -replace '\\', '/')
          if ($json.userDataDir -ne $expected) {
            throw "userDataDir mismatch. expected=$expected actual=$($json.userDataDir)"
          }

          foreach ($sub in @('logs', 'cache', 'plugins')) {
            $p = Join-Path $dataDir $sub
            if (!(Test-Path $p)) {
              throw "missing data subdir: $p"
            }
          }

          # 清理（避免污染后续步骤）
          if (Test-Path $installDir) { Remove-Item -Recurse -Force $installDir }
          if (Test-Path $dataDir) { Remove-Item -Recurse -Force $dataDir }
          if (Test-Path $configPath) { Remove-Item -Force $configPath }
          if (Test-Path $configDir) {
            try { Remove-Item -Recurse -Force $configDir } catch { }
          }

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            ${{ steps.assets.outputs.installer_path }}
            ${{ steps.assets.outputs.sha256_path }}
