name: deploy

on:
  workflow_run:
    workflows: ["ci"]
    types: [completed]

permissions:
  contents: read

concurrency:
  group: deploy-prod
  cancel-in-progress: true

jobs:
  deploy-prod:
    name: deploy-prod
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Write deploy SSH key file
        shell: bash
        run: |
          set -euo pipefail
          : "${RUNNER_TEMP:?RUNNER_TEMP 未设置}"
          key_file="${RUNNER_TEMP}/deploy_ssh_key"
          mkdir -p "$(dirname "$key_file")"
          # 用 heredoc 写入，避免 echo/printf 破坏私钥换行；严禁在日志中输出私钥内容。
          cat > "$key_file" <<'EOF'
          ${{ secrets.SSHKEY }}
          EOF
          chmod 600 "$key_file"
          echo "DEPLOY_KEY_FILE=$key_file" >> "$GITHUB_ENV"

      - name: Add SSH known_hosts (pscly.cc)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan -H pscly.cc >> ~/.ssh/known_hosts

      - name: Build release tarball
        shell: bash
        env:
          DEPLOY_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail
          # Keep output outside '.' so tar doesn't include its own output file.
          TARBALL="${RUNNER_TEMP:-/tmp}/release-${DEPLOY_SHA}.tgz"
          tar -czf "$TARBALL" \
            --exclude=.git \
            --exclude=.env \
            --exclude=.env.* \
            --exclude=.sisyphus \
            --exclude=node_modules \
            --exclude=.venv \
            --exclude=client/dist-electron \
            --exclude=.pytest_cache \
            --exclude=__pycache__ \
            .

      - name: Upload release tarball
        shell: bash
        env:
          DEPLOY_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail
          TARBALL="${RUNNER_TEMP:-/tmp}/release-${DEPLOY_SHA}.tgz"
          # 最小诊断：仅输出 runner 公网 IP，便于服务器侧对照 SSH 日志。
          RUNNER_PUBLIC_IP="$( (curl -fsS https://api.ipify.org || curl -fsS https://ifconfig.me/ip) 2>/dev/null || true )"
          if [ -n "$RUNNER_PUBLIC_IP" ]; then
            echo "$RUNNER_PUBLIC_IP"
          fi
          ssh -i "$DEPLOY_KEY_FILE" -o BatchMode=yes -o StrictHostKeyChecking=yes -o IdentitiesOnly=yes root@pscly.cc "mkdir -p /root/dockers/para/releases"
          scp -i "$DEPLOY_KEY_FILE" -o BatchMode=yes -o StrictHostKeyChecking=yes -o IdentitiesOnly=yes "$TARBALL" "root@pscly.cc:/root/dockers/para/releases/${DEPLOY_SHA}.tgz"

      - name: Remote deploy
        shell: bash
        env:
          DEPLOY_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -euo pipefail
          ssh -i "$DEPLOY_KEY_FILE" -o BatchMode=yes -o StrictHostKeyChecking=yes -o IdentitiesOnly=yes root@pscly.cc "bash -s -- ${DEPLOY_SHA}" < deploy/prod/remote_deploy.sh

      - name: Smoke test (public)
        shell: bash
        run: |
          set -euo pipefail
          url="https://para.pscly.cc/api/v1/health"
          for i in {1..30}; do
            if curl -fsS "$url" | python3 -c 'import json,sys; j=json.load(sys.stdin); s=j.get("status"); assert s=="ok", f"status={s}"' >/dev/null 2>&1; then
              echo "Smoke OK"
              exit 0
            fi
            echo "Waiting for health... (${i}/30)"
            sleep 2
          done
          echo "Smoke failed: $url" >&2
          exit 1
