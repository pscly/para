x-server-image: &server_image
  image: para-server:prod
  build:
    context: ../..
    dockerfile: server/Dockerfile

x-server-volumes: &server_volumes
  - /root/dockers/para/data/server/.data:/app/.data

x-server-env: &server_env
  ENV: ${ENV:-production}
  LOG_LEVEL: ${LOG_LEVEL:-INFO}
  HEALTH_TIMEOUT_S: ${HEALTH_TIMEOUT_S:-0.5}

  POSTGRES_HOST: postgres
  POSTGRES_PORT: 5432
  POSTGRES_DB: ${POSTGRES_DB:-para}
  POSTGRES_USER: ${POSTGRES_USER:-para}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-para}

  CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://redis:6379/0}
  CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND:-redis://redis:6379/0}
  WS_REDIS_URL: ${WS_REDIS_URL:-redis://redis:6379/0}
  CELERY_TASK_ALWAYS_EAGER: "0"

  AUTH_ACCESS_TOKEN_SECRET: ${AUTH_ACCESS_TOKEN_SECRET:-}
  ADMIN_ACCESS_TOKEN_SECRET: ${ADMIN_ACCESS_TOKEN_SECRET:-}

  OPENAI_MODE: ${OPENAI_MODE:-openai}
  KNOWLEDGE_EMBEDDING_PROVIDER: ${KNOWLEDGE_EMBEDDING_PROVIDER:-openai}
  OPENAI_BASE_URL: ${OPENAI_BASE_URL:-}
  OPENAI_API_KEY: ${OPENAI_API_KEY:-}
  OPENAI_MODEL: ${OPENAI_MODEL:-}
  OPENAI_API: ${OPENAI_API:-auto}
  OPENAI_EMBEDDINGS_MODEL: ${OPENAI_EMBEDDINGS_MODEL:-text-embedding-3-small}
  OPENAI_EMBEDDINGS_TIMEOUT_SECONDS: ${OPENAI_EMBEDDINGS_TIMEOUT_SECONDS:-10.0}

  PARA_APPENC_ENABLED: ${PARA_APPENC_ENABLED:-0}
  PARA_APPENC_KEYS: ${PARA_APPENC_KEYS:-{}}
  PARA_APPENC_TS_WINDOW_SEC: ${PARA_APPENC_TS_WINDOW_SEC:-120}

  CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-[]}
  TRUSTED_HOSTS: ${TRUSTED_HOSTS:-[]}

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: ${COMPOSE_PROJECT_NAME:-para}-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-para}
      POSTGRES_USER: ${POSTGRES_USER:-para}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-para}
    volumes:
      - /root/dockers/para/data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-para} -d ${POSTGRES_DB:-para}"]
      interval: 5s
      timeout: 5s
      retries: 30
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-para}-redis
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - /root/dockers/para/data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  migrate:
    <<: *server_image
    container_name: ${COMPOSE_PROJECT_NAME:-para}-migrate
    profiles: ["migrate"]
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      <<: *server_env
    volumes: *server_volumes
    command: ["sh", "-c", "alembic upgrade head"]
    restart: "no"

  api:
    <<: *server_image
    container_name: ${COMPOSE_PROJECT_NAME:-para}-api
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      <<: *server_env
    volumes: *server_volumes
    command:
      - sh
      - -c
      - uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers ${UVICORN_WORKERS:-2}
    ports:
      - "127.0.0.1:${API_PORT:-18080}:8000"
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - "import os, urllib.request; ht=float(os.getenv('HEALTH_TIMEOUT_S','0.5')); override=os.getenv('API_HEALTHCHECK_TIMEOUT_S'); t=float(override) if override else max(5.0, ht*4.0); urllib.request.urlopen('http://127.0.0.1:8000/api/v1/health', timeout=t).read()"
      interval: 10s
      timeout: 30s
      retries: 30
    restart: unless-stopped

  worker:
    <<: *server_image
    container_name: ${COMPOSE_PROJECT_NAME:-para}-worker
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      api:
        condition: service_started
    environment:
      <<: *server_env
    volumes: *server_volumes
    command:
      - sh
      - -c
      - celery -A app.workers.celery_app:celery_app worker -l INFO -c ${CELERY_CONCURRENCY:-1}
    restart: unless-stopped

  beat:
    <<: *server_image
    container_name: ${COMPOSE_PROJECT_NAME:-para}-beat
    profiles: ["beat"]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      <<: *server_env
      CELERY_BEAT_DEV_EVERY_MINUTE: ${CELERY_BEAT_DEV_EVERY_MINUTE:-0}
    volumes: *server_volumes
    command: ["sh", "-c", "celery -A app.workers.celery_app:celery_app beat -l INFO"]
    restart: unless-stopped

  admin-web:
    image: para-admin-web:prod
    build:
      context: ../..
      dockerfile: admin-web/Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-para}-admin-web
    ports:
      - "127.0.0.1:${ADMIN_WEB_PORT:-18081}:80"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1/ || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 30
    restart: unless-stopped
