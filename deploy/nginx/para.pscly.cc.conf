# para.pscly.cc - HTTPS 反向代理（aaPanel Nginx vhost 风格）
#
# 目标：
# - 80 -> 443 强制跳转
# - /api/ 与 /ws/ 反代到 API（127.0.0.1:18080）
# - /admin/ 反代到 admin-web（127.0.0.1:18081），并通过 proxy_pass 尾随 / 去掉 /admin 前缀
# - /assets/ 反代到 admin-web（Vite 默认 base='/' 时会请求绝对路径 /assets/...）
#
# 证书路径（沿用 pscly.cc 泛域/同证书）：
# - /root/ssl/pscly.cc.pem
# - /root/ssl/pscly.cc.key

server {
  listen 80;
  server_name para.pscly.cc;

  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name para.pscly.cc;

  ssl_certificate /root/ssl/pscly.cc.pem;
  ssl_certificate_key /root/ssl/pscly.cc.key;

  # 统一透传常用反代头
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # --- API ---
  # 保持路径不变：/api/* -> http://127.0.0.1:18080/api/*
  location /api/ {
    proxy_pass http://127.0.0.1:18080;
  }

  # --- WebSocket ---
  # /ws/* -> http://127.0.0.1:18080/ws/* + Upgrade/Connection
  location /ws/ {
    proxy_pass http://127.0.0.1:18080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

  # --- admin-web ---
  # 兼容 /admin 与 /admin/（避免相对路径解析问题）
  location = /admin {
    return 301 /admin/;
  }

  # 关键：proxy_pass 末尾的 / 会把匹配到的 /admin/ 前缀剥离。
  # 例：/admin/config/feature-flags -> 上游 /config/feature-flags
  location /admin/ {
    proxy_pass http://127.0.0.1:18081/;
  }

  # Vite 默认 base='/' 时，静态资源通常为绝对路径 /assets/*。
  # 在 /admin/ 下部署时，需要显式把 /assets/ 也指向 admin-web。
  location /assets/ {
    proxy_pass http://127.0.0.1:18081/assets/;
  }
}
