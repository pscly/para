## [2026-02-13 23:31] - 任务：初始化项目目录结构
- 原始需求：在当前仓库内按 client/server 方式划分客户端与后端；plan.md 保持当前位置不动；完全不开源。
- 实现目标/逻辑：采用单仓库（monorepo）降低接口/协议频繁调整时的协作与联调成本；根目录创建 client/ 与 server/ 作为两端代码入口。
- 核心变更：新增目录 client/、server/；未移动 plan.md。
- 遗留/约束：
  - 暂不拆分为多个 GitHub 仓库；待 MVP 稳定后再评估是否需要拆仓。
  - 后端 Python 环境后续使用 uv 管理（FastAPI + SQLAlchemy + PostgreSQL + pgvector）。

## [2026-02-14 00:12] - 任务：启动执行 ai-girlfriend-desktop-pet 计划
- 原始需求：桌面端与服务端同步开发；接口规范/协议/数据模型提前设计好；按总计划分波次推进。
- 实现目标/逻辑：遵循 `.sisyphus/plans/ai-girlfriend-desktop-pet.md`，从脚手架与契约流水线开始，逐步落地鉴权、WS 流式、存档/角色、长记忆、投喂、多模态、助手能力、相册、离线生活、社交/UGC/插件与最小管理后台；全程 TDD + 自动化验收产证据。
- 核心变更（预期）：将新增 docker-compose、本地开发脚本、server(FastAPI/SQLAlchemy/Alembic)、client(Electron/React/Playwright)、contracts(OpenAPI/WS schema) 等。
- 遗留/约束：
  - 本机缺少 `rg` 与 `pnpm`；执行阶段优先用 npm 与内置 grep/ast_grep 工具（或后续统一安装）。
  - 高风险能力（截图/插件/UGC/社交）默认关闭，启用必须显式同意且写审计。

## [2026-02-14 01:40] - 任务：完成 Wave1 Task2/Task3 脚手架与自动化验收
- 原始需求：并行推进 server/client，且具备可自动验收的测试与证据产出。
- 实现目标/逻辑：
  - 后端：FastAPI + uv + SQLAlchemy + Alembic，提供 `/api/v1/health`，并用 pytest 覆盖 health 与 DB 连通性（`SELECT 1`）。
  - 客户端：Electron + React + TS + vitest + Playwright Electron smoke，并强制 `data-testid` 稳定选择器。
  - Headless 环境：Linux 无 DISPLAY 时，e2e 通过 `xvfb-run -a` 自动兜底。
- 核心变更：
  - `server/` 新增脚手架与测试；证据：`.sisyphus/evidence/task-2-health.json`
  - `client/` 新增脚手架与测试；证据：`.sisyphus/evidence/task-3-electron-smoke.png`
- 遗留/约束：
  - `electron` 二进制下载偶发不完整：必要时手动运行 `ELECTRON_MIRROR=... node node_modules/electron/install.js`。

## [2026-02-14 00:22] - Task: Local deps + one-command bootstrap
- Original request: implement plan item "基础脚手架：本地依赖与一键启动".
- Goal/logic: provide a minimal Docker Compose stack (Postgres w/ pgvector + Redis) and Make targets that work from repo root.
- Core changes: add `docker-compose.yml`, `Makefile`, `.env.example`, `.gitignore`.
- Constraints: no real secrets committed; `.env` is gitignored; defaults are embedded so `docker compose config` works even without `.env`.

## [2026-02-14 01:35] - 任务：Client 脚手架（Electron + React + TS + 最小 UI）
- 原始需求：实现计划项 3，创建 `client/` 下 Electron+React+TS 的最小可运行工程；从 Day 1 固化 `data-testid`；提供 Vitest 单测与 Playwright Electron 冒烟 e2e（含截图产物）。
- 实现目标/逻辑：renderer 用 Vite+React（`client/src/renderer` 作为 root，build 输出到 `client/dist/renderer`）；主进程/预加载用 `tsc` 编译到 `client/dist/main` 与 `client/dist/preload`；dev 期用 `concurrently + tsc --watch + nodemon + wait-on` 一键启动。
- 核心变更：新增 `client/package.json`、`client/vite.config.ts`、`client/tsconfig*.json`、`client/src/main`、`client/src/preload`、`client/src/renderer`、`client/tests`、`client/playwright`；`client/src/renderer/app/testIds.ts` 提供稳定选择器常量。
- 遗留/约束：
  - 当前网络环境下 Electron 二进制下载可能不稳定；必要时用 `ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/ npm -C client install` 走镜像源。
  - `/// <reference types="vite/client" />` 属于 TS 类型指令，保留以确保 Vite 类型生效（不是“多余注释”）。
  - 已新增 `client/.gitignore` 忽略 `node_modules/`、`dist/`、`playwright-results/` 等生成目录，避免误提交。
  - dev 启动里 `wait-on` 等待本地文件需要 `file:` 前缀（已在 `client/package.json` 中使用 `file:dist/main/index.js` / `file:dist/preload/index.js`）。

## [2026-02-14 00:52] - Task: Server scaffold (FastAPI + uv + DB + Alembic + /health)
- Original request: implement plan checkbox "2. Server scaffold: FastAPI + uv + DB + Alembic + /health".
- Goal/logic: keep a minimal, env-driven FastAPI app with request-id middleware, SQLAlchemy(2.0)+psycopg3 wiring, Alembic scaffold for future migrations, and a single health endpoint for smoke tests.
- Core changes: add `server/pyproject.toml`, `server/app/*`, `server/alembic.ini`, `server/alembic/*`, `server/tests/*`.
- Notes: `uv run pytest` uses the `pytest` console script (sys.path[0] = `.venv/bin`), so `server/tests/conftest.py` ensures `import app` works.

## [2026-02-14 01:18] - Task: Headless e2e wrapper for Electron/Playwright
- Original request: fix `npm -C client run e2e` failing on Linux without $DISPLAY (Electron "Missing X server" crash).
- Goal/logic: keep e2e command stable by conditionally wrapping Playwright with `xvfb-run -a` only when `process.platform==='linux'` and no `DISPLAY`.
- Core changes: add `client/scripts/run-e2e.mjs`; update `client/package.json` e2e script to call the wrapper.
- Constraints: no new npm deps; do not change test logic; only touch `client/`.

## [2026-02-14 01:34] - Task: Task 3 验收证据（Electron smoke 成功截图）
- 原始需求：修改 `client/playwright/electron-smoke.spec.ts`，让 e2e 成功通过时自动输出截图到 `.sisyphus/evidence/task-3-electron-smoke.png`。
- 实现目标/逻辑：在关键断言通过后写入固定证据路径；必要时创建目录；保持 smoke test 轻量且不引入新依赖。
- 核心变更：更新 `client/playwright/electron-smoke.spec.ts`，使用 `path.resolve(process.cwd(), '..', '.sisyphus', 'evidence', ...)` + `fs.promises.mkdir(..., { recursive: true })` + `page.screenshot(...)`。
- 遗留/约束：默认 e2e 通过 `npm -C client run e2e` 运行（cwd 为 `client/`）；若从其他 cwd 运行，证据路径可能需要调整为更稳健的仓库根定位逻辑。

## [2026-02-14 01:55] - Task: Contract pipeline (OpenAPI export + TS gen + drift check)
- Original request: implement plan item "4. Contract pipeline: OpenAPI export + TS SDK gen + drift check".
- Goal/logic: make OpenAPI JSON a first-class artifact at `contracts/openapi.json`, generate TS types into `client/src/gen/`, and provide a deterministic drift check suitable for CI.
- Core changes:
  - `server/app/api/v1/auth.py` adds placeholder auth endpoints (501) so schema includes `/api/v1/auth/*`.
  - `server/app/scripts/export_openapi.py` exports `app.openapi()` with stable JSON formatting.
  - `client/package.json` adds `gen:api` using `openapi-typescript`; output is `client/src/gen/openapi.ts`.
  - `scripts/generate-contracts.sh` regenerates artifacts and optionally enforces `git diff --exit-code`.
- Notes/constraints: keep generated outputs committed to avoid drift; `pyrightconfig.json` added at repo root so LSP resolves server venv deps.

## [2026-02-14 08:34] - 任务：完成 Task 6 Client 登录闭环
- 原始需求：补齐 Client 端登录 UI 与 token 安全存储，并提供 `/auth/me` 验证与 e2e 证据，形成“登录闭环”。
- 实现目标/逻辑：主进程负责 token 的安全存储与 REST 调用（login/me/logout），renderer 通过 preload 暴露的 `window.desktopApi.auth` 仅获取用户信息（me）并渲染状态/错误，避免在 renderer 直接持有敏感 token。
- 核心变更：
  - `client/src/main/index.ts`（新增 `auth:login`/`auth:me`/`auth:logout`，并引入 `PARA_SERVER_BASE_URL`/`PARA_USER_DATA_DIR` 相关配置）
  - `client/src/preload/index.ts`（暴露 `window.desktopApi.auth`）
  - `client/src/renderer/app/App.tsx`（显示“已登录：{email}”并处理错误态）
  - `client/playwright/electron-login.spec.ts`（使用本地 stub server 做登录 e2e）
  - `.sisyphus/evidence/task-6-login-success.png`（登录成功截图）
  - `.sisyphus/evidence/task-6-login-fail.png`（登录失败截图）
- 遗留/约束：
  - plan.md 未明确确认的变更不应提交（避免把未达成共识的试验性改动带入主线）。
  - WS 相关的 Task 7 尚未开始（避免把登录与 WS 串流耦合在同一次改动中）。

## [2026-02-14 10:12] - 任务：WS 协议 v1（Server）：HELLO/ACK/PING + 断线重连骨架
- 原始需求：实现 `/ws/v1?save_id=<string>&resume_from=<int>` WebSocket；用 `Authorization: Bearer <access_token>` 鉴权并解析 `user_id=sub`；支持 HELLO/ACK/PING(PONG) 与断线重连回放。
- 实现目标/逻辑：以 `(user_id, save_id)` 为维度维护 in-memory 事件日志与单调递增 `seq`；控制帧统一 `seq=0`/`server_event_id=null`，可回放事件才分配 `seq>=1` 且 `server_event_id=f"{user_id}:{save_id}:{seq}"`；重连仅回放 `seq > resume_from` 的事件，确保 `server_event_id` 不重复。
- 核心变更：
  - `server/app/ws/v1.py`：新增 stream 状态模型与 `append_event`/`get_events_after`，并实现 WS endpoint。
  - `server/app/main.py`：挂载 WS router，确保路径严格为 `/ws/v1`（不走 `/api/v1` 前缀）。
- 遗留/约束：当前仅 in-memory 骨架，未引入 DB/持久化；后续扩展需补齐事件落盘/裁剪策略与更严格的消息校验。

## [2026-02-14 14:26] - 任务：Task 8 流式聊天（Server 侧最小实现）
- 原始需求：在现有 `/ws/v1` 上支持 `CHAT_SEND` -> `CHAT_TOKEN`/`CHAT_DONE` 的流式推送，并支持 `INTERRUPT` 中断；事件帧写入 events log，断线后可 `resume_from` 回放。
- 实现目标/逻辑：
  - 保持 Task7 的 `append_event()` 旧行为不变（仍产出固定 `type="EVENT"`），新增内部 `_append_typed_event()` 生成可回放的不同事件类型。
  - 通过 `asyncio.create_task` + `asyncio.Event` 跑后台生成任务；主 receive loop 继续处理 `ACK/PING/INTERRUPT/CHAT_SEND`，避免“单线程循环”导致中断收不到。
  - 发送侧增加 `asyncio.Lock` 串行化 `send_json`，避免并发 send 破坏 Starlette WebSocket 状态。
  - 先实现确定性 fake streaming：把输入回声为 `AI: {text}`，按字符拆分为 token，多帧推送。
- 核心变更：
  - `server/app/ws/v1.py`：新增 `_append_typed_event()`；新增处理 `CHAT_SEND`/`INTERRUPT`；新增事件帧 `CHAT_TOKEN`/`CHAT_DONE`（均写入 events log 以支持断线回放）。
  - `server/app/ws/chat_fake.py`：新增 `fake_chat_tokens()`，按字符异步产出 token，并在每个 token 间 `await asyncio.sleep(0)` 让出调度。
- 遗留/约束：本阶段不落库、不改 DB schema；事件仍为 in-memory，后续需要补持久化与裁剪策略。

## [2026-02-14 15:08] - 任务：Task 8 后端测试（WS 流式 CHAT_SEND/INTERRUPT）
- 原始需求：为 `/ws/v1` 增加 pytest，覆盖 `CHAT_SEND` 流式输出 `CHAT_TOKEN/CHAT_DONE`，以及中途 `INTERRUPT` 能停止并返回 `CHAT_DONE.payload.interrupted=true`。
- 实现目标/逻辑：
  - 复用现有 REST 注册逻辑获取 `access_token`，并通过 `Authorization: Bearer <token>` 建立 WS 连接。
  - 连接后先读取并忽略 `HELLO`；收帧时允许夹杂控制帧（如 `PONG`），通过循环过滤到目标 `type`。
  - 用例 1：断言至少 1 条 `CHAT_TOKEN`（`seq>=1` 且 `server_event_id` 非空）并最终收到 `CHAT_DONE`（`interrupted=false`）。
  - 用例 2：收到首条 `CHAT_TOKEN` 后立刻发送 `INTERRUPT`，随后断言 `CHAT_DONE.payload.interrupted=true`。
- 核心变更：新增 `server/tests/test_ws_v1_chat_stream.py`（仅新增该测试文件，不改 WS 实现）。
- 遗留/约束：测试为减少竞态，第二用例使用较长输入文本以确保中断窗口足够；后续若引入真实模型流式，需根据新节奏调整等待/过滤策略。

## [2026-02-14 12:45] - 任务：Task 11 长记忆：生活记忆写入/检索 + 遗忘（pgvector）
- 原始需求：新增 memory ingest/search/delete API；按 save 隔离且必须鉴权；使用 pgvector `<->` 做相似度检索；删除为软删；pytest 覆盖 ingest→search→delete→search，并落盘证据 JSON。
- 实现目标/逻辑：
  - 数据模型：`MemoryItem` 保存文本与来源/可信标记，`MemoryEmbedding` 保存 `vector(64)` embedding；两者 1:1 关联，软删字段 `deleted_at` 在 `MemoryItem` 上。
  - embedding：实现确定性本地 embedding（按字符 sha256 hash 到固定维度桶计数并归一化），保证无外部依赖且可复现。
  - 检索：用 pgvector 距离运算符 `<->` 排序取 top-k，并返回 `distance` 与 `score=1/(1+distance)`；查询显式 `.cast(Float)` 避免类型推断误用向量 result processor。
  - 扩展启用：在 API 与测试里用 `CREATE EXTENSION IF NOT EXISTS vector` 确保 DB 已安装 pgvector（镜像包含扩展但 DB 默认未 install）。
- 核心变更：
  - `server/app/db/models.py`：新增 `Vector`（pgvector 类型声明）、`MemoryItem`、`MemoryEmbedding`；`Save` 增加 `memory_items` 关系。
  - `server/app/api/v1/memory.py`：新增 `POST /api/v1/memory/ingest`、`GET /api/v1/memory/search`、`DELETE /api/v1/memory/{memory_id}`（delete 需 `save_id` 参数）。
  - `server/app/api/v1/router.py`：挂载 memory router。
  - `server/tests/test_task_11_memory_search.py`：新增用例并写入证据 `.sisyphus/evidence/task-11-memory-search.json`。
- 遗留/约束：严格不修改 `.sisyphus/plans/ai-girlfriend-desktop-pet.md`（该文件存在非预期 diff 风险，需 orchestrator 统一管理）。

## [2026-02-14 12:40] - 任务：Task 11 长记忆（pgvector）
- 原始需求：实现“生活记忆写入/检索 + 遗忘（pgvector）”，并能用自动化验收证明：写入“我喜欢蓝色”后搜索“喜欢的颜色”能命中，删除后不可命中。
- 实现目标/逻辑：
  - REST 新增 `/api/v1/memory/ingest`、`/api/v1/memory/search`、`/api/v1/memory/{id}`（DELETE），全部 Bearer JWT 鉴权，并按 `save_id` 隔离且校验 save 归属当前 user。
  - pgvector：不新增依赖，使用 SQLAlchemy `UserDefinedType` 声明 `vector(64)` 列；本地 embedding 采用字符 hash 到固定维度桶 + 归一化，保证可复现与离线测试。
  - 检索使用 pgvector 距离运算 `<->` 排序；删除采用软删 `deleted_at`（墓碑），查询过滤掉已删除项。
- 核心变更：
  - `server/app/db/models.py`（新增 `Vector` 类型与 `MemoryItem`/`MemoryEmbedding` 模型）
  - `server/app/api/v1/memory.py`（新增 memory API + 本地 embedding）
  - `server/app/api/v1/router.py`（挂载 memory router）
  - `server/tests/test_task_11_memory_search.py`（新增用例 + 写入证据）
  - 证据：`.sisyphus/evidence/task-11-memory-search.json`
- 遗留/约束：当前在请求路径里 `CREATE EXTENSION IF NOT EXISTS vector` 属于偏重操作；后续应迁移化/启动时一次性确保扩展。

## [2026-02-14 13:15] - 任务：Task 12 日记/梦境/总结（Celery + 定时）
- 原始需求：建立 Celery worker/beat 骨架；支持触发一次任务生成“梦境/日记”产物入库，并通过 WS 推送（或可重连回放）；提供自动化证据。
- 实现目标/逻辑：
  - Celery：新增 `server/app/workers/celery_app.py`，使用 Redis 作为 broker/backend；测试通过 `celery_app.conf.task_always_eager = True` 同步执行避免依赖真实 worker。
  - 产物入库：新增 `DreamEntry`（按 `save_id` 隔离），最小字段 `id/save_id/kind/content/created_at`。
  - 触发入口：新增 `POST /api/v1/dreams/trigger`（Bearer JWT 鉴权 + save 归属校验），调用 Celery task 生成 dream entry。
  - WS 推送：Celery task 执行后向 `(user_id, save_id)` 的 in-memory events log 追加可回放事件帧 `TIMELINE_EVENT`（`seq>=1`）。
- 核心变更：
  - `server/app/workers/celery_app.py`
  - `server/app/workers/tasks/dreams.py`
  - `server/app/api/v1/dreams.py`
  - `server/app/api/v1/router.py`
  - `server/app/db/models.py`
  - `server/tests/test_task_12_dream_event.py`
  - 证据：`.sisyphus/evidence/task-12-dream-event.txt`
- 遗留/约束：WS 事件日志目前是进程内内存结构；Celery 真正多进程/多实例部署时需要把事件落到 Redis/DB 或走专门的 push 通道，否则 worker 无法直接影响 API 进程内的 events log。

## [2026-02-14 05:20] - 任务：Task 13 学习投喂（上传→解析→切片→向量化→检索问答含引用）
- 原始需求：新增 knowledge 资料上传（md/txt/pdf）与异步索引；完成后可用 pgvector 检索并返回 answer + citations；所有 API 需 JWT 鉴权且按 save_id 隔离。
- 实现目标/逻辑：
  - 抽取可复现本地 embedding(64) 到共享模块，memory/knowledge 复用同一算法；
  - 上传后落盘到 `server/.data/knowledge/<material_id>/original.<ext>` 并创建 material(status=pending)，随后触发 Celery task 解析→切片→向量化→入库→更新 status；
  - query 用 `<->` 距离检索 top-k chunk，并返回 citations（含 chunk_id/material_id/chunk_index/distance/score/snippet）。
- 核心变更：
  - `server/app/services/embedding_local.py`（共享 embedding 逻辑），`server/app/api/v1/memory.py` 改为复用；
  - `server/app/db/models.py` 新增 `KnowledgeMaterial`/`KnowledgeChunk`（含 `save_id` 隔离、`Vector(64)` embedding）；
  - `server/app/workers/tasks/knowledge.py` 新增 Celery 索引任务；
  - `server/app/api/v1/knowledge.py` 新增 materials/query REST，并在 `server/app/api/v1/router.py` 挂载；
  - `server/tests/test_task_13_knowledge_query.py` 新增 pytest 闭环并落盘证据 `.sisyphus/evidence/task-13-knowledge-query.json`。
- 依赖/验证：新增 `pypdf` 与 `python-multipart`；`uv run pytest`（server/）全绿。

## [2026-02-14 11:55] - 任务：Task 9 存档/Persona（server CRUD + persona 绑定 + 状态隔离 + client 最小 UI）
- 原始需求：实现存档切换与 persona 绑定；每个 save 的聊天/记忆/知识隔离；提供自动化证据“两个 save 历史不串”。
- 实现目标/逻辑：
  - Server 新增 `Save/Persona/SavePersonaBinding` 模型；REST 提供 saves CRUD、personas list/get、save persona bind；鉴权复用 Bearer JWT。
  - WS 隔离基于既有 `(user_id, save_id)` 事件日志 key；通过两条 save 分别流式 chat 并在重连 replay 中断言 token 文本不串。
  - Client 在调试面板中加入“存档/Persona”最小 UI（加载/创建/切换/绑定）；WS connect 使用当前选中 saveId，默认仍为 `default`。
- 核心变更：
  - `server/app/db/models.py`、`server/app/api/v1/saves.py`、`server/app/api/v1/personas.py`、`server/app/api/v1/router.py`
  - `server/tests/test_task_9_save_isolation.py` 输出证据 `.sisyphus/evidence/task-9-save-isolation.txt`
  - `client/src/main/index.ts`、`client/src/preload/index.ts`、`client/src/renderer/app/App.tsx`
- 证据：`.sisyphus/evidence/task-9-save-isolation.txt`
- 遗留/约束：当前 personas 没有“创建 persona”REST；测试里通过 DB 直接插入 persona。后续可加管理端/种子数据。

## [2026-02-14 12:25] - 任务：Task 10 桌宠 UI（透明置顶/穿透/托盘/唤醒/环形菜单）
- 原始需求：Windows 优先的桌宠窗口：透明置顶、默认鼠标穿透；托盘与快捷键唤醒进入可交互态；提供最小环形菜单；自动化验收截图。
- 实现目标/逻辑：
  - main 进程新增 pet BrowserWindow（320x320、transparent/frame-less、alwaysOnTop、skipTaskbar、默认 setIgnoreMouseEvents(true,{forward:true})）。
  - renderer 通过 `?window=pet` 切换渲染 `PetApp`（占位 sprite + 环形菜单 DOM），菜单由点击 sprite 打开。
  - Tray + globalShortcut（`CommandOrControl+Shift+P`）切换可交互态（ignoreMouse true/false）；tray 菜单支持显示/隐藏、打开调试面板、退出。
  - e2e 因多窗口存在，不能依赖 `firstWindow()`；改为按 `window.innerWidth` 选目标窗口。
- 核心变更：
  - `client/src/main/index.ts`
  - `client/src/renderer/main.tsx`
  - `client/src/renderer/pet/PetApp.tsx`
  - `client/playwright/electron-pet-ui.spec.ts`
- 证据：`.sisyphus/evidence/task-10-pet-ui.png`

## [2026-02-14 13:23] - 任务：Task 14 Client：拖拽投喂 UI + 索引进度气泡
- 原始需求：在调试面板中提供拖拽 .md 文件投喂知识的最小 UI；上传必须走 main 进程；轮询 material status 并展示空闲/索引中/完成(或失败)；新增 Playwright Electron e2e 且内置 stub server，不依赖真实后端；通过时落盘证据截图。
- 实现目标/逻辑：
  - renderer 读取 `File.arrayBuffer()` 得到 bytes，通过 preload 暴露的 `window.desktopApi.knowledge` 调用 main IPC；renderer 不直接持有敏感 token。
  - main 通过 `fetch + FormData` 以 multipart 上传到 `/api/v1/knowledge/materials`，并提供 `GET /api/v1/knowledge/materials/{id}` 查询；base url 复用 `PARA_SERVER_BASE_URL`。
  - e2e 在 spec 内起本地 http stub：POST 返回 pending；GET 先 pending 后 indexed，确保进度态可观测；成功后写 `.sisyphus/evidence/task-14-feed-progress.png`。
- 核心变更：
  - `client/src/renderer/app/testIds.ts`（新增 `feed-dropzone`/`feed-progress`/`feed-done`）
  - `client/src/preload/index.ts`（新增 `desktopApi.knowledge`）
  - `client/src/main/index.ts`（新增 IPC handlers：`knowledge:uploadMaterial`/`knowledge:materialStatus`）
  - `client/src/renderer/app/App.tsx`（新增投喂 UI + 轮询逻辑）
  - `client/playwright/electron-feed-knowledge.spec.ts`（新增 e2e stub + 拖拽 + 截图）
- 证据：`.sisyphus/evidence/task-14-feed-progress.png`
- 遗留/约束：当前 e2e stub 不鉴权；真实环境如需要鉴权应在 main 侧复用现有 token 读取与 authed fetch（仍不把 token 暴露给 renderer）。

## [2026-02-14 16:20] - 任务：Task 15 多模态截图理解（强隐私开关 + 最小可用）
- 原始需求：新增 `POST /api/v1/sensors/screenshot`（Bearer 鉴权、校验 save 归属、payload 大小限制），返回稳定 JSON `{ "suggestion": "..." }`；实现保持离线，不调用外部模型。
- 实现目标/逻辑：对截图仅做最小校验（base64 解码 + 体积限制 + 可选 PNG 宽高提取），产出固定提示文案；提供强隐私开关 `privacy_mode`：默认 `strict` 不写 WS，可选 `standard`/`emit_ws_event` 才写入一条 `SUGGESTION` 事件（不包含截图内容）。
- 核心变更：
  - `server/app/api/v1/sensors.py`：新增 screenshot endpoint + 限制与隐私开关 + 可选写 WS typed event
  - `server/app/api/v1/router.py`：挂载 sensors router
  - `server/tests/test_task_15_vision_screenshot.py`：新增 200/401/404 三用例
- 遗留/约束：当前建议文案为占位（不做真实“理解”）；后续如接入真实多模态，需要再次评审隐私策略（默认关闭/显式同意/审计）与存储策略。

## [2026-02-14 14:07] - 任务：Task 15 Client 多模态截图理解（强隐私开关 + 最小闭环 + e2e 证据）
- 原始需求：Client 侧完成最小闭环（toggle + 明确授权 UI + 上传 1 张测试截图 + 显示建议），默认关闭；发送必须在主进程发起网络请求；新增 Electron Playwright e2e，stub server 计数断言并落盘证据截图。
- 实现目标/逻辑：
  - renderer 默认关闭（`aria-pressed=false`），点击 toggle 弹出自定义授权面板，同意后才真正启用；随时可关闭撤回。
  - 启用后点击“发送测试截图”调用 preload IPC `vision:uploadScreenshot`，由 main 进程携带 token 调用 `POST /api/v1/sensors/screenshot`（JSON：`save_id` + `image_base64` + `privacy_mode`），并把 `{ suggestion }` 回传给 renderer 展示。
  - e2e 在 spec 内启动本地 http stub：关闭状态点击发送，hit 计数保持 0；授权开启后点击发送，hit 计数变为 1 且 UI 出现 suggestion；成功时写入固定证据截图。
- 核心变更：
  - `client/src/renderer/app/testIds.ts`（新增 vision 相关 testids）
  - `client/src/renderer/app/App.tsx`（新增 toggle/授权 UI/发送测试截图/展示建议）
  - `client/src/preload/index.ts`（新增 `desktopApi.vision.uploadScreenshot`）
  - `client/src/main/index.ts`（新增 IPC handler `vision:uploadScreenshot`，主进程 POST `/api/v1/sensors/screenshot`）
  - `client/src/renderer/vite-env.d.ts`（补齐 `DesktopApi.vision` typings）
  - `client/playwright/electron-vision-screenshot.spec.ts`（新增 stub server + e2e 断言）
- 证据：`.sisyphus/evidence/task-15-vision-suggestion.png`
- 遗留/约束：renderer 不直接接触 token；测试截图为内置 1x1 PNG base64（仅用于闭环验证，避免引入真实截屏权限/采集逻辑）。

## [2026-02-14 14:31] - 任务：Task 16 Client 系统助手（开关 UI + IPC + suggestion 展示）
- 原始需求：Client 侧新增“系统助手”开关 UI + IPC 通道；主进程周期读取剪贴板，检测变化且“看起来像英文”时调用 `POST /api/v1/sensors/event` 获取 `{suggestion, category}` 并推送到 renderer 展示；新增“闲置关怀”子开关（默认关闭）与最后一次 suggestion 展示；不写 e2e。
- 实现目标/逻辑：
  - renderer：新增“系统助手”卡片与稳定 `data-testid`（主开关/闲置开关/复制英文按钮/建议展示），并订阅 `assistant:suggestion` 推送更新 UI。
  - preload：暴露 `desktopApi.assistant`（`setEnabled`/`setIdleEnabled`/`onSuggestion`/`writeClipboardText`），renderer 不直接持 token。
  - main：实现 `AssistantManager`，仅在开启时轮询剪贴板；idle 子开关启用时启动一次性计时器（默认 5 分钟，可用 `PARA_ASSISTANT_IDLE_MS` 覆盖）；所有事件调用复用 `fetchAuthedJson`，建议通过 `safeSendToRenderer('assistant:suggestion', ...)` 推送。
- 核心变更：
  - `client/src/renderer/app/testIds.ts`（新增 assistant 相关 testids）
  - `client/src/renderer/app/App.tsx`（新增系统助手卡片 + 订阅/展示）
  - `client/src/preload/index.ts`（新增 `desktopApi.assistant`）
  - `client/src/main/index.ts`（新增 assistant IPC + 剪贴板/idle 逻辑 + 推送）
  - `client/src/renderer/vite-env.d.ts`（补齐 typings）
- 遗留/约束：默认关闭（关闭时不轮询剪贴板、不触发 idle）；不输出剪贴板内容日志；本任务未新增/修改 Playwright 测试。
