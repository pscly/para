## [2026-02-15 00:00] - 任务：收尾清理（提交证据/笔记 + 忽略 .serena）
- 原始需求：处理未提交的 `.sisyphus/evidence/**`、`.sisyphus/notepads/**`、`.sisyphus/boulder.json`、`.ai_session.md`，并让 `.serena/` 不再出现在 `git status`，最终工作区干净；不 push。
- 实现目标/逻辑：
  - 将本轮产生的 `task-*.{png,txt,json}` 证据与 notepads 归档为单个 chore 提交（便于审阅与追溯）。
  - 通过 `.gitignore` 最小增量忽略 `/.serena/`，避免本地工具状态污染工作区。
  - 提交前检查文本/json 证据不包含真实 token/密钥（允许 `[REDACTED]`/stub 占位）。
- 核心变更：
  - `.gitignore`：追加 `/.serena/`。
  - `.sisyphus/*`：更新/新增 task evidence 与 notepads。
- 遗留/约束：不提交 `.serena/` 内容；不提交任何真实密钥（`AGENTS.md` 保持忽略）。

## [2026-02-14 22:46] - 任务：修复 DoD QA runner 回归（qa_alpha + plugin e2e feature flags）
- 原始需求：
  - `scripts/qa_alpha.sh` 任一步失败必须整体 exit 非 0（不能出现 step fail 仍继续并最终 rc=0/ALL GREEN）。
  - `client/playwright/electron-plugin.spec.ts` 补齐 `GET /api/v1/feature_flags` stub（`plugins_enabled=true`），否则引入远端 kill-switch 后插件 host 无法启动导致 `plugins-menu-item` 不出现。
- 实现目标/逻辑：
  - QA runner 继续用 `tee` 写 evidence，并用 `PIPESTATUS` 捕获 `run_all` 的真实返回码；但 `run_all()` 内部必须在每个 `run_step` 失败时立刻 `return 1`，避免后续步骤与最终 `ALL GREEN` 误报。
  - 插件 e2e 的 stub server 增加 `GET /api/v1/feature_flags`，返回 JSON `{ feature_flags: { plugins_enabled: true } }`（与 main 侧解析器兼容 `plugins_enabled/pluginsEnabled`）。
  - 并发/慢机下 plugins consent 面板可能异步出现：在 e2e 中对 consent panel 做短暂等待再点击 accept，避免漏点导致插件未真正启用。
- 核心变更：
  - `scripts/qa_alpha.sh`：`run_all()` 中每个 `run_step ...` 改为 `run_step ... || return 1`。
  - `client/playwright/electron-plugin.spec.ts`：stub 增加 `GET /api/v1/feature_flags`，并增强 consent panel 的等待/处理。
- 遗留/约束：不新增依赖；不降低既有断言标准；e2e stub 需在 Electron 启动后即可被轮询命中。

## [2026-02-13 23:31] - 任务：初始化项目目录结构
- 原始需求：在当前仓库内按 client/server 方式划分客户端与后端；plan.md 保持当前位置不动；完全不开源。
- 实现目标/逻辑：采用单仓库（monorepo）降低接口/协议频繁调整时的协作与联调成本；根目录创建 client/ 与 server/ 作为两端代码入口。
- 核心变更：新增目录 client/、server/；未移动 plan.md。
- 遗留/约束：
  - 暂不拆分为多个 GitHub 仓库；待 MVP 稳定后再评估是否需要拆仓。
  - 后端 Python 环境后续使用 uv 管理（FastAPI + SQLAlchemy + PostgreSQL + pgvector）。

## [2026-02-14 00:12] - 任务：启动执行 ai-girlfriend-desktop-pet 计划
- 原始需求：桌面端与服务端同步开发；接口规范/协议/数据模型提前设计好；按总计划分波次推进。
- 实现目标/逻辑：遵循 `.sisyphus/plans/ai-girlfriend-desktop-pet.md`，从脚手架与契约流水线开始，逐步落地鉴权、WS 流式、存档/角色、长记忆、投喂、多模态、助手能力、相册、离线生活、社交/UGC/插件与最小管理后台；全程 TDD + 自动化验收产证据。
- 核心变更（预期）：将新增 docker-compose、本地开发脚本、server(FastAPI/SQLAlchemy/Alembic)、client(Electron/React/Playwright)、contracts(OpenAPI/WS schema) 等。
- 遗留/约束：
  - 本机缺少 `rg` 与 `pnpm`；执行阶段优先用 npm 与内置 grep/ast_grep 工具（或后续统一安装）。
  - 高风险能力（截图/插件/UGC/社交）默认关闭，启用必须显式同意且写审计。

## [2026-02-14 01:40] - 任务：完成 Wave1 Task2/Task3 脚手架与自动化验收
- 原始需求：并行推进 server/client，且具备可自动验收的测试与证据产出。
- 实现目标/逻辑：
  - 后端：FastAPI + uv + SQLAlchemy + Alembic，提供 `/api/v1/health`，并用 pytest 覆盖 health 与 DB 连通性（`SELECT 1`）。
  - 客户端：Electron + React + TS + vitest + Playwright Electron smoke，并强制 `data-testid` 稳定选择器。
  - Headless 环境：Linux 无 DISPLAY 时，e2e 通过 `xvfb-run -a` 自动兜底。
- 核心变更：
  - `server/` 新增脚手架与测试；证据：`.sisyphus/evidence/task-2-health.json`
  - `client/` 新增脚手架与测试；证据：`.sisyphus/evidence/task-3-electron-smoke.png`
- 遗留/约束：
  - `electron` 二进制下载偶发不完整：必要时手动运行 `ELECTRON_MIRROR=... node node_modules/electron/install.js`。

## [2026-02-14 00:22] - Task: Local deps + one-command bootstrap
- Original request: implement plan item "基础脚手架：本地依赖与一键启动".
- Goal/logic: provide a minimal Docker Compose stack (Postgres w/ pgvector + Redis) and Make targets that work from repo root.
- Core changes: add `docker-compose.yml`, `Makefile`, `.env.example`, `.gitignore`.
- Constraints: no real secrets committed; `.env` is gitignored; defaults are embedded so `docker compose config` works even without `.env`.

## [2026-02-14 01:35] - 任务：Client 脚手架（Electron + React + TS + 最小 UI）
- 原始需求：实现计划项 3，创建 `client/` 下 Electron+React+TS 的最小可运行工程；从 Day 1 固化 `data-testid`；提供 Vitest 单测与 Playwright Electron 冒烟 e2e（含截图产物）。
- 实现目标/逻辑：renderer 用 Vite+React（`client/src/renderer` 作为 root，build 输出到 `client/dist/renderer`）；主进程/预加载用 `tsc` 编译到 `client/dist/main` 与 `client/dist/preload`；dev 期用 `concurrently + tsc --watch + nodemon + wait-on` 一键启动。
- 核心变更：新增 `client/package.json`、`client/vite.config.ts`、`client/tsconfig*.json`、`client/src/main`、`client/src/preload`、`client/src/renderer`、`client/tests`、`client/playwright`；`client/src/renderer/app/testIds.ts` 提供稳定选择器常量。
- 遗留/约束：
  - 当前网络环境下 Electron 二进制下载可能不稳定；必要时用 `ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/ npm -C client install` 走镜像源。
  - `/// <reference types="vite/client" />` 属于 TS 类型指令，保留以确保 Vite 类型生效（不是“多余注释”）。
  - 已新增 `client/.gitignore` 忽略 `node_modules/`、`dist/`、`playwright-results/` 等生成目录，避免误提交。
  - dev 启动里 `wait-on` 等待本地文件需要 `file:` 前缀（已在 `client/package.json` 中使用 `file:dist/main/index.js` / `file:dist/preload/index.js`）。

## [2026-02-14 00:52] - Task: Server scaffold (FastAPI + uv + DB + Alembic + /health)
- Original request: implement plan checkbox "2. Server scaffold: FastAPI + uv + DB + Alembic + /health".
- Goal/logic: keep a minimal, env-driven FastAPI app with request-id middleware, SQLAlchemy(2.0)+psycopg3 wiring, Alembic scaffold for future migrations, and a single health endpoint for smoke tests.
- Core changes: add `server/pyproject.toml`, `server/app/*`, `server/alembic.ini`, `server/alembic/*`, `server/tests/*`.
- Notes: `uv run pytest` uses the `pytest` console script (sys.path[0] = `.venv/bin`), so `server/tests/conftest.py` ensures `import app` works.

## [2026-02-14 01:18] - Task: Headless e2e wrapper for Electron/Playwright
- Original request: fix `npm -C client run e2e` failing on Linux without $DISPLAY (Electron "Missing X server" crash).
- Goal/logic: keep e2e command stable by conditionally wrapping Playwright with `xvfb-run -a` only when `process.platform==='linux'` and no `DISPLAY`.
- Core changes: add `client/scripts/run-e2e.mjs`; update `client/package.json` e2e script to call the wrapper.
- Constraints: no new npm deps; do not change test logic; only touch `client/`.

## [2026-02-14 01:34] - Task: Task 3 验收证据（Electron smoke 成功截图）
- 原始需求：修改 `client/playwright/electron-smoke.spec.ts`，让 e2e 成功通过时自动输出截图到 `.sisyphus/evidence/task-3-electron-smoke.png`。
- 实现目标/逻辑：在关键断言通过后写入固定证据路径；必要时创建目录；保持 smoke test 轻量且不引入新依赖。
- 核心变更：更新 `client/playwright/electron-smoke.spec.ts`，使用 `path.resolve(process.cwd(), '..', '.sisyphus', 'evidence', ...)` + `fs.promises.mkdir(..., { recursive: true })` + `page.screenshot(...)`。
- 遗留/约束：默认 e2e 通过 `npm -C client run e2e` 运行（cwd 为 `client/`）；若从其他 cwd 运行，证据路径可能需要调整为更稳健的仓库根定位逻辑。

## [2026-02-14 01:55] - Task: Contract pipeline (OpenAPI export + TS gen + drift check)
- Original request: implement plan item "4. Contract pipeline: OpenAPI export + TS SDK gen + drift check".
- Goal/logic: make OpenAPI JSON a first-class artifact at `contracts/openapi.json`, generate TS types into `client/src/gen/`, and provide a deterministic drift check suitable for CI.
- Core changes:
  - `server/app/api/v1/auth.py` adds placeholder auth endpoints (501) so schema includes `/api/v1/auth/*`.
  - `server/app/scripts/export_openapi.py` exports `app.openapi()` with stable JSON formatting.
  - `client/package.json` adds `gen:api` using `openapi-typescript`; output is `client/src/gen/openapi.ts`.
  - `scripts/generate-contracts.sh` regenerates artifacts and optionally enforces `git diff --exit-code`.
- Notes/constraints: keep generated outputs committed to avoid drift; `pyrightconfig.json` added at repo root so LSP resolves server venv deps.

## [2026-02-14 08:34] - 任务：完成 Task 6 Client 登录闭环
- 原始需求：补齐 Client 端登录 UI 与 token 安全存储，并提供 `/auth/me` 验证与 e2e 证据，形成“登录闭环”。
- 实现目标/逻辑：主进程负责 token 的安全存储与 REST 调用（login/me/logout），renderer 通过 preload 暴露的 `window.desktopApi.auth` 仅获取用户信息（me）并渲染状态/错误，避免在 renderer 直接持有敏感 token。
- 核心变更：
  - `client/src/main/index.ts`（新增 `auth:login`/`auth:me`/`auth:logout`，并引入 `PARA_SERVER_BASE_URL`/`PARA_USER_DATA_DIR` 相关配置）
  - `client/src/preload/index.ts`（暴露 `window.desktopApi.auth`）
  - `client/src/renderer/app/App.tsx`（显示“已登录：{email}”并处理错误态）
  - `client/playwright/electron-login.spec.ts`（使用本地 stub server 做登录 e2e）
  - `.sisyphus/evidence/task-6-login-success.png`（登录成功截图）
  - `.sisyphus/evidence/task-6-login-fail.png`（登录失败截图）
- 遗留/约束：
  - plan.md 未明确确认的变更不应提交（避免把未达成共识的试验性改动带入主线）。
  - WS 相关的 Task 7 尚未开始（避免把登录与 WS 串流耦合在同一次改动中）。

## [2026-02-14 10:12] - 任务：WS 协议 v1（Server）：HELLO/ACK/PING + 断线重连骨架
- 原始需求：实现 `/ws/v1?save_id=<string>&resume_from=<int>` WebSocket；用 `Authorization: Bearer <access_token>` 鉴权并解析 `user_id=sub`；支持 HELLO/ACK/PING(PONG) 与断线重连回放。
- 实现目标/逻辑：以 `(user_id, save_id)` 为维度维护 in-memory 事件日志与单调递增 `seq`；控制帧统一 `seq=0`/`server_event_id=null`，可回放事件才分配 `seq>=1` 且 `server_event_id=f"{user_id}:{save_id}:{seq}"`；重连仅回放 `seq > resume_from` 的事件，确保 `server_event_id` 不重复。
- 核心变更：
  - `server/app/ws/v1.py`：新增 stream 状态模型与 `append_event`/`get_events_after`，并实现 WS endpoint。
  - `server/app/main.py`：挂载 WS router，确保路径严格为 `/ws/v1`（不走 `/api/v1` 前缀）。
- 遗留/约束：当前仅 in-memory 骨架，未引入 DB/持久化；后续扩展需补齐事件落盘/裁剪策略与更严格的消息校验。

## [2026-02-14 14:26] - 任务：Task 8 流式聊天（Server 侧最小实现）
- 原始需求：在现有 `/ws/v1` 上支持 `CHAT_SEND` -> `CHAT_TOKEN`/`CHAT_DONE` 的流式推送，并支持 `INTERRUPT` 中断；事件帧写入 events log，断线后可 `resume_from` 回放。
- 实现目标/逻辑：
  - 保持 Task7 的 `append_event()` 旧行为不变（仍产出固定 `type="EVENT"`），新增内部 `_append_typed_event()` 生成可回放的不同事件类型。
  - 通过 `asyncio.create_task` + `asyncio.Event` 跑后台生成任务；主 receive loop 继续处理 `ACK/PING/INTERRUPT/CHAT_SEND`，避免“单线程循环”导致中断收不到。
  - 发送侧增加 `asyncio.Lock` 串行化 `send_json`，避免并发 send 破坏 Starlette WebSocket 状态。
  - 先实现确定性 fake streaming：把输入回声为 `AI: {text}`，按字符拆分为 token，多帧推送。
- 核心变更：
  - `server/app/ws/v1.py`：新增 `_append_typed_event()`；新增处理 `CHAT_SEND`/`INTERRUPT`；新增事件帧 `CHAT_TOKEN`/`CHAT_DONE`（均写入 events log 以支持断线回放）。
  - `server/app/ws/chat_fake.py`：新增 `fake_chat_tokens()`，按字符异步产出 token，并在每个 token 间 `await asyncio.sleep(0)` 让出调度。
- 遗留/约束：本阶段不落库、不改 DB schema；事件仍为 in-memory，后续需要补持久化与裁剪策略。

## [2026-02-14 15:08] - 任务：Task 8 后端测试（WS 流式 CHAT_SEND/INTERRUPT）
- 原始需求：为 `/ws/v1` 增加 pytest，覆盖 `CHAT_SEND` 流式输出 `CHAT_TOKEN/CHAT_DONE`，以及中途 `INTERRUPT` 能停止并返回 `CHAT_DONE.payload.interrupted=true`。
- 实现目标/逻辑：
  - 复用现有 REST 注册逻辑获取 `access_token`，并通过 `Authorization: Bearer <token>` 建立 WS 连接。
  - 连接后先读取并忽略 `HELLO`；收帧时允许夹杂控制帧（如 `PONG`），通过循环过滤到目标 `type`。
  - 用例 1：断言至少 1 条 `CHAT_TOKEN`（`seq>=1` 且 `server_event_id` 非空）并最终收到 `CHAT_DONE`（`interrupted=false`）。
  - 用例 2：收到首条 `CHAT_TOKEN` 后立刻发送 `INTERRUPT`，随后断言 `CHAT_DONE.payload.interrupted=true`。
- 核心变更：新增 `server/tests/test_ws_v1_chat_stream.py`（仅新增该测试文件，不改 WS 实现）。
- 遗留/约束：测试为减少竞态，第二用例使用较长输入文本以确保中断窗口足够；后续若引入真实模型流式，需根据新节奏调整等待/过滤策略。

## [2026-02-14 12:45] - 任务：Task 11 长记忆：生活记忆写入/检索 + 遗忘（pgvector）
- 原始需求：新增 memory ingest/search/delete API；按 save 隔离且必须鉴权；使用 pgvector `<->` 做相似度检索；删除为软删；pytest 覆盖 ingest→search→delete→search，并落盘证据 JSON。
- 实现目标/逻辑：
  - 数据模型：`MemoryItem` 保存文本与来源/可信标记，`MemoryEmbedding` 保存 `vector(64)` embedding；两者 1:1 关联，软删字段 `deleted_at` 在 `MemoryItem` 上。
  - embedding：实现确定性本地 embedding（按字符 sha256 hash 到固定维度桶计数并归一化），保证无外部依赖且可复现。
  - 检索：用 pgvector 距离运算符 `<->` 排序取 top-k，并返回 `distance` 与 `score=1/(1+distance)`；查询显式 `.cast(Float)` 避免类型推断误用向量 result processor。
  - 扩展启用：在 API 与测试里用 `CREATE EXTENSION IF NOT EXISTS vector` 确保 DB 已安装 pgvector（镜像包含扩展但 DB 默认未 install）。
- 核心变更：
  - `server/app/db/models.py`：新增 `Vector`（pgvector 类型声明）、`MemoryItem`、`MemoryEmbedding`；`Save` 增加 `memory_items` 关系。
  - `server/app/api/v1/memory.py`：新增 `POST /api/v1/memory/ingest`、`GET /api/v1/memory/search`、`DELETE /api/v1/memory/{memory_id}`（delete 需 `save_id` 参数）。
  - `server/app/api/v1/router.py`：挂载 memory router。
  - `server/tests/test_task_11_memory_search.py`：新增用例并写入证据 `.sisyphus/evidence/task-11-memory-search.json`。
- 遗留/约束：严格不修改 `.sisyphus/plans/ai-girlfriend-desktop-pet.md`（该文件存在非预期 diff 风险，需 orchestrator 统一管理）。

## [2026-02-14 12:40] - 任务：Task 11 长记忆（pgvector）
- 原始需求：实现“生活记忆写入/检索 + 遗忘（pgvector）”，并能用自动化验收证明：写入“我喜欢蓝色”后搜索“喜欢的颜色”能命中，删除后不可命中。
- 实现目标/逻辑：
  - REST 新增 `/api/v1/memory/ingest`、`/api/v1/memory/search`、`/api/v1/memory/{id}`（DELETE），全部 Bearer JWT 鉴权，并按 `save_id` 隔离且校验 save 归属当前 user。
  - pgvector：不新增依赖，使用 SQLAlchemy `UserDefinedType` 声明 `vector(64)` 列；本地 embedding 采用字符 hash 到固定维度桶 + 归一化，保证可复现与离线测试。
  - 检索使用 pgvector 距离运算 `<->` 排序；删除采用软删 `deleted_at`（墓碑），查询过滤掉已删除项。
- 核心变更：
  - `server/app/db/models.py`（新增 `Vector` 类型与 `MemoryItem`/`MemoryEmbedding` 模型）
  - `server/app/api/v1/memory.py`（新增 memory API + 本地 embedding）
  - `server/app/api/v1/router.py`（挂载 memory router）
  - `server/tests/test_task_11_memory_search.py`（新增用例 + 写入证据）
  - 证据：`.sisyphus/evidence/task-11-memory-search.json`
- 遗留/约束：当前在请求路径里 `CREATE EXTENSION IF NOT EXISTS vector` 属于偏重操作；后续应迁移化/启动时一次性确保扩展。

## [2026-02-14 13:15] - 任务：Task 12 日记/梦境/总结（Celery + 定时）
- 原始需求：建立 Celery worker/beat 骨架；支持触发一次任务生成“梦境/日记”产物入库，并通过 WS 推送（或可重连回放）；提供自动化证据。
- 实现目标/逻辑：
  - Celery：新增 `server/app/workers/celery_app.py`，使用 Redis 作为 broker/backend；测试通过 `celery_app.conf.task_always_eager = True` 同步执行避免依赖真实 worker。
  - 产物入库：新增 `DreamEntry`（按 `save_id` 隔离），最小字段 `id/save_id/kind/content/created_at`。
  - 触发入口：新增 `POST /api/v1/dreams/trigger`（Bearer JWT 鉴权 + save 归属校验），调用 Celery task 生成 dream entry。
  - WS 推送：Celery task 执行后向 `(user_id, save_id)` 的 in-memory events log 追加可回放事件帧 `TIMELINE_EVENT`（`seq>=1`）。
- 核心变更：
  - `server/app/workers/celery_app.py`
  - `server/app/workers/tasks/dreams.py`
  - `server/app/api/v1/dreams.py`
  - `server/app/api/v1/router.py`
  - `server/app/db/models.py`
  - `server/tests/test_task_12_dream_event.py`
  - 证据：`.sisyphus/evidence/task-12-dream-event.txt`
- 遗留/约束：WS 事件日志目前是进程内内存结构；Celery 真正多进程/多实例部署时需要把事件落到 Redis/DB 或走专门的 push 通道，否则 worker 无法直接影响 API 进程内的 events log。

## [2026-02-14 05:20] - 任务：Task 13 学习投喂（上传→解析→切片→向量化→检索问答含引用）
- 原始需求：新增 knowledge 资料上传（md/txt/pdf）与异步索引；完成后可用 pgvector 检索并返回 answer + citations；所有 API 需 JWT 鉴权且按 save_id 隔离。
- 实现目标/逻辑：
  - 抽取可复现本地 embedding(64) 到共享模块，memory/knowledge 复用同一算法；
  - 上传后落盘到 `server/.data/knowledge/<material_id>/original.<ext>` 并创建 material(status=pending)，随后触发 Celery task 解析→切片→向量化→入库→更新 status；
  - query 用 `<->` 距离检索 top-k chunk，并返回 citations（含 chunk_id/material_id/chunk_index/distance/score/snippet）。
- 核心变更：
  - `server/app/services/embedding_local.py`（共享 embedding 逻辑），`server/app/api/v1/memory.py` 改为复用；
  - `server/app/db/models.py` 新增 `KnowledgeMaterial`/`KnowledgeChunk`（含 `save_id` 隔离、`Vector(64)` embedding）；
  - `server/app/workers/tasks/knowledge.py` 新增 Celery 索引任务；
  - `server/app/api/v1/knowledge.py` 新增 materials/query REST，并在 `server/app/api/v1/router.py` 挂载；
  - `server/tests/test_task_13_knowledge_query.py` 新增 pytest 闭环并落盘证据 `.sisyphus/evidence/task-13-knowledge-query.json`。
- 依赖/验证：新增 `pypdf` 与 `python-multipart`；`uv run pytest`（server/）全绿。

## [2026-02-14 11:55] - 任务：Task 9 存档/Persona（server CRUD + persona 绑定 + 状态隔离 + client 最小 UI）
- 原始需求：实现存档切换与 persona 绑定；每个 save 的聊天/记忆/知识隔离；提供自动化证据“两个 save 历史不串”。
- 实现目标/逻辑：
  - Server 新增 `Save/Persona/SavePersonaBinding` 模型；REST 提供 saves CRUD、personas list/get、save persona bind；鉴权复用 Bearer JWT。
  - WS 隔离基于既有 `(user_id, save_id)` 事件日志 key；通过两条 save 分别流式 chat 并在重连 replay 中断言 token 文本不串。
  - Client 在调试面板中加入“存档/Persona”最小 UI（加载/创建/切换/绑定）；WS connect 使用当前选中 saveId，默认仍为 `default`。
- 核心变更：
  - `server/app/db/models.py`、`server/app/api/v1/saves.py`、`server/app/api/v1/personas.py`、`server/app/api/v1/router.py`
  - `server/tests/test_task_9_save_isolation.py` 输出证据 `.sisyphus/evidence/task-9-save-isolation.txt`
  - `client/src/main/index.ts`、`client/src/preload/index.ts`、`client/src/renderer/app/App.tsx`
- 证据：`.sisyphus/evidence/task-9-save-isolation.txt`
- 遗留/约束：当前 personas 没有“创建 persona”REST；测试里通过 DB 直接插入 persona。后续可加管理端/种子数据。

## [2026-02-14 12:25] - 任务：Task 10 桌宠 UI（透明置顶/穿透/托盘/唤醒/环形菜单）
- 原始需求：Windows 优先的桌宠窗口：透明置顶、默认鼠标穿透；托盘与快捷键唤醒进入可交互态；提供最小环形菜单；自动化验收截图。
- 实现目标/逻辑：
  - main 进程新增 pet BrowserWindow（320x320、transparent/frame-less、alwaysOnTop、skipTaskbar、默认 setIgnoreMouseEvents(true,{forward:true})）。
  - renderer 通过 `?window=pet` 切换渲染 `PetApp`（占位 sprite + 环形菜单 DOM），菜单由点击 sprite 打开。
  - Tray + globalShortcut（`CommandOrControl+Shift+P`）切换可交互态（ignoreMouse true/false）；tray 菜单支持显示/隐藏、打开调试面板、退出。
  - e2e 因多窗口存在，不能依赖 `firstWindow()`；改为按 `window.innerWidth` 选目标窗口。
- 核心变更：
  - `client/src/main/index.ts`
  - `client/src/renderer/main.tsx`
  - `client/src/renderer/pet/PetApp.tsx`
  - `client/playwright/electron-pet-ui.spec.ts`
- 证据：`.sisyphus/evidence/task-10-pet-ui.png`

## [2026-02-14 13:23] - 任务：Task 14 Client：拖拽投喂 UI + 索引进度气泡
- 原始需求：在调试面板中提供拖拽 .md 文件投喂知识的最小 UI；上传必须走 main 进程；轮询 material status 并展示空闲/索引中/完成(或失败)；新增 Playwright Electron e2e 且内置 stub server，不依赖真实后端；通过时落盘证据截图。
- 实现目标/逻辑：
  - renderer 读取 `File.arrayBuffer()` 得到 bytes，通过 preload 暴露的 `window.desktopApi.knowledge` 调用 main IPC；renderer 不直接持有敏感 token。
  - main 通过 `fetch + FormData` 以 multipart 上传到 `/api/v1/knowledge/materials`，并提供 `GET /api/v1/knowledge/materials/{id}` 查询；base url 复用 `PARA_SERVER_BASE_URL`。
  - e2e 在 spec 内起本地 http stub：POST 返回 pending；GET 先 pending 后 indexed，确保进度态可观测；成功后写 `.sisyphus/evidence/task-14-feed-progress.png`。
- 核心变更：
  - `client/src/renderer/app/testIds.ts`（新增 `feed-dropzone`/`feed-progress`/`feed-done`）
  - `client/src/preload/index.ts`（新增 `desktopApi.knowledge`）
  - `client/src/main/index.ts`（新增 IPC handlers：`knowledge:uploadMaterial`/`knowledge:materialStatus`）
  - `client/src/renderer/app/App.tsx`（新增投喂 UI + 轮询逻辑）
  - `client/playwright/electron-feed-knowledge.spec.ts`（新增 e2e stub + 拖拽 + 截图）
- 证据：`.sisyphus/evidence/task-14-feed-progress.png`
- 遗留/约束：当前 e2e stub 不鉴权；真实环境如需要鉴权应在 main 侧复用现有 token 读取与 authed fetch（仍不把 token 暴露给 renderer）。

## [2026-02-14 16:20] - 任务：Task 15 多模态截图理解（强隐私开关 + 最小可用）
- 原始需求：新增 `POST /api/v1/sensors/screenshot`（Bearer 鉴权、校验 save 归属、payload 大小限制），返回稳定 JSON `{ "suggestion": "..." }`；实现保持离线，不调用外部模型。
- 实现目标/逻辑：对截图仅做最小校验（base64 解码 + 体积限制 + 可选 PNG 宽高提取），产出固定提示文案；提供强隐私开关 `privacy_mode`：默认 `strict` 不写 WS，可选 `standard`/`emit_ws_event` 才写入一条 `SUGGESTION` 事件（不包含截图内容）。
- 核心变更：
  - `server/app/api/v1/sensors.py`：新增 screenshot endpoint + 限制与隐私开关 + 可选写 WS typed event
  - `server/app/api/v1/router.py`：挂载 sensors router
  - `server/tests/test_task_15_vision_screenshot.py`：新增 200/401/404 三用例
- 遗留/约束：当前建议文案为占位（不做真实“理解”）；后续如接入真实多模态，需要再次评审隐私策略（默认关闭/显式同意/审计）与存储策略。

## [2026-02-14 14:07] - 任务：Task 15 Client 多模态截图理解（强隐私开关 + 最小闭环 + e2e 证据）
- 原始需求：Client 侧完成最小闭环（toggle + 明确授权 UI + 上传 1 张测试截图 + 显示建议），默认关闭；发送必须在主进程发起网络请求；新增 Electron Playwright e2e，stub server 计数断言并落盘证据截图。
- 实现目标/逻辑：
  - renderer 默认关闭（`aria-pressed=false`），点击 toggle 弹出自定义授权面板，同意后才真正启用；随时可关闭撤回。
  - 启用后点击“发送测试截图”调用 preload IPC `vision:uploadScreenshot`，由 main 进程携带 token 调用 `POST /api/v1/sensors/screenshot`（JSON：`save_id` + `image_base64` + `privacy_mode`），并把 `{ suggestion }` 回传给 renderer 展示。
  - e2e 在 spec 内启动本地 http stub：关闭状态点击发送，hit 计数保持 0；授权开启后点击发送，hit 计数变为 1 且 UI 出现 suggestion；成功时写入固定证据截图。
- 核心变更：
  - `client/src/renderer/app/testIds.ts`（新增 vision 相关 testids）
  - `client/src/renderer/app/App.tsx`（新增 toggle/授权 UI/发送测试截图/展示建议）
  - `client/src/preload/index.ts`（新增 `desktopApi.vision.uploadScreenshot`）
  - `client/src/main/index.ts`（新增 IPC handler `vision:uploadScreenshot`，主进程 POST `/api/v1/sensors/screenshot`）
  - `client/src/renderer/vite-env.d.ts`（补齐 `DesktopApi.vision` typings）
  - `client/playwright/electron-vision-screenshot.spec.ts`（新增 stub server + e2e 断言）
- 证据：`.sisyphus/evidence/task-15-vision-suggestion.png`
- 遗留/约束：renderer 不直接接触 token；测试截图为内置 1x1 PNG base64（仅用于闭环验证，避免引入真实截屏权限/采集逻辑）。

## [2026-02-14 14:31] - 任务：Task 16 Client 系统助手（开关 UI + IPC + suggestion 展示）
- 原始需求：Client 侧新增“系统助手”开关 UI + IPC 通道；主进程周期读取剪贴板，检测变化且“看起来像英文”时调用 `POST /api/v1/sensors/event` 获取 `{suggestion, category}` 并推送到 renderer 展示；新增“闲置关怀”子开关（默认关闭）与最后一次 suggestion 展示；不写 e2e。
- 实现目标/逻辑：
  - renderer：新增“系统助手”卡片与稳定 `data-testid`（主开关/闲置开关/复制英文按钮/建议展示），并订阅 `assistant:suggestion` 推送更新 UI。
  - preload：暴露 `desktopApi.assistant`（`setEnabled`/`setIdleEnabled`/`onSuggestion`/`writeClipboardText`），renderer 不直接持 token。
  - main：实现 `AssistantManager`，仅在开启时轮询剪贴板；idle 子开关启用时启动一次性计时器（默认 5 分钟，可用 `PARA_ASSISTANT_IDLE_MS` 覆盖）；所有事件调用复用 `fetchAuthedJson`，建议通过 `safeSendToRenderer('assistant:suggestion', ...)` 推送。
- 核心变更：
  - `client/src/renderer/app/testIds.ts`（新增 assistant 相关 testids）
  - `client/src/renderer/app/App.tsx`（新增系统助手卡片 + 订阅/展示）
  - `client/src/preload/index.ts`（新增 `desktopApi.assistant`）
  - `client/src/main/index.ts`（新增 assistant IPC + 剪贴板/idle 逻辑 + 推送）
  - `client/src/renderer/vite-env.d.ts`（补齐 typings）
- 遗留/约束：默认关闭（关闭时不轮询剪贴板、不触发 idle）；不输出剪贴板内容日志；本任务未新增/修改 Playwright 测试。

## [2026-02-14 16:25] - 任务：Task 17 生成式相册端到端可验收
- 原始需求：触发生成任务 → job 完成 → 客户端 UI 出现新图片，并产出固定证据截图 `.sisyphus/evidence/task-17-gallery.png`。
- 实现目标/逻辑：renderer 仅通过 preload 暴露的 `desktopApi.gallery` 调用 IPC；所有 HTTP 请求与鉴权 token 均留在 main 进程（复用 `fetchAuthedJson`）。e2e 沿用 spec 内 stub server 策略，避免依赖真实后端与网络波动。
- 核心变更：
  - `client/src/renderer/app/App.tsx` 新增“生成式相册”区块（prompt → generate → refresh/auto-refresh → masonry 展示）。
  - `client/src/renderer/styles.css` 新增 `.gallery-masonry/.gallery-item/.gallery-img` 等轻量样式。
  - 新增 `client/playwright/electron-gallery.spec.ts`，成功后截图写入 `.sisyphus/evidence/task-17-gallery.png`。
- 遗留/约束：
  - Electron e2e 依赖 `client/node_modules/electron/dist/`；缺失时需运行 `ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/ node client/node_modules/electron/install.js`。
  - 不修改 `plan.md` 与 `.sisyphus/plans/ai-girlfriend-desktop-pet.md`。

## [2026-02-14 18:10] - 任务：Task 18 客户端验收证据（时间轴：离线模拟）
- 原始需求：补齐 Electron Playwright E2E，用 spec 内 stub server 驱动“时间轴（离线模拟）”卡片点击“模拟一次”后生成并展示事件，并落盘截图证据。
- 实现目标/逻辑：沿用既有 E2E 模式（spec 内 `http.createServer` + env 注入 `PARA_SERVER_BASE_URL`/`PARA_USER_DATA_DIR` + 写入 `auth.tokens.json`），并在多窗口场景下按 `window.innerWidth` 选择调试面板窗口；仅用 `data-testid` 选择器等待 `timeline-item` 可见后截图。
- 核心变更：
  - `client/playwright/electron-timeline.spec.ts`：stub `POST /api/v1/timeline/simulate` 与 `GET /api/v1/timeline?...`，点击 `timeline-simulate` 后断言至少 1 个 `timeline-item` 并截图。
  - 证据：`.sisyphus/evidence/task-18-timeline.png`
- 遗留/约束：
  - 选择器仅允许 `data-testid`（`timeline-card`/`timeline-simulate`/`timeline-list`/`timeline-item`），避免文本/结构选择器导致脆弱。
  - 证据路径固定以仓库根为基准（运行时 cwd=client）：`path.resolve(process.cwd(), '..', '.sisyphus', 'evidence', ...)`。

## [2026-02-14 18:07] - 任务：Task 19 社交房间（Room REST + WS ROOM_EVENT 重连回放）
- 原始需求：在 server 端新增房间创建/邀请/加入 REST；并通过现有 WS 事件流追加 `ROOM_EVENT`（可通过重连 replay 收到）；补齐 pytest 验收与证据 `.sisyphus/evidence/task-19-room-event.txt`。
- 实现目标/逻辑：
  - 数据模型：新增 `Room`（`id/room_type/created_by_user_id/created_at`）与 `RoomMember`（`(room_id,user_id)` 唯一；`role/status/created_at/joined_at`），保持最小可演进。
  - REST：新增 `/api/v1/social/rooms`、`/api/v1/social/rooms/{room_id}/invite`、`/api/v1/social/rooms/{room_id}/join`，全部 Bearer JWT 鉴权；invite 校验 room 存在且邀请者为 creator 或已 joined 成员；join 仅允许被邀请用户自己加入。
  - WS：复用 `append_typed_event((user_id, save_id), frame_type='ROOM_EVENT', payload=...)` 追加事件到“相关用户的所有 saves”；验收采用“先触发 REST，再通过 `/ws/v1?...&resume_from=0` 重连回放”模式，断言两边至少收到 `ROOM_JOINED`。
- 核心变更：
  - `server/app/db/models.py`：新增 `Room`/`RoomMember` ORM。
  - `server/app/api/v1/social.py`：新增 rooms create/invite/join REST，并在 create/invite/join 时写入 `ROOM_EVENT`。
  - `server/app/api/v1/router.py`：挂载 social router。
  - `server/tests/test_task_19_room_event.py`：双 WS 客户端 replay 验收 + 证据落盘。
- 证据：`.sisyphus/evidence/task-19-room-event.txt`
- 遗留/约束：当前 WS 事件日志仍为进程内内存结构；未来若引入多进程/多实例，需要把事件存储/广播迁移到 Redis/DB 或专门 push 通道。

## [2026-02-14 18:31] - 任务：Task 19 客户端：社交房间最小 UI + IPC 打通
- 原始需求：在调试面板新增“社交房间”最小 UI（输入好友 user_id、创建房间、邀请、加入、展示房间事件文本），并打通 renderer -> preload -> main 的 IPC 调用到现有 server social endpoints（`/api/v1/social/rooms`、`/invite`、`/join`）。
- 实现目标/逻辑：renderer 严格不直接 fetch/不接触 token；所有 REST 调用均在 main 侧通过 `fetchAuthedJson` 完成；renderer 只通过 preload 暴露的 `window.desktopApi.social.*` 发起 `ipcRenderer.invoke`；WS 事件流在既有 `ws.onEvent` handler 中新增 `ROOM_EVENT` 分支，将 payload 以可读文本形式追加到列表。
- 核心变更：
  - `client/src/main/index.ts`：新增 IPC 常量与 `registerSocialIpcHandlers`（create/invite/join），内部调用 `/api/v1/social/*` 并对 403/404/422 映射可读错误码。
  - `client/src/preload/index.ts`：暴露 `desktopApi.social`（createRoom/invite/join，全部 `ipcRenderer.invoke`）。
  - `client/src/renderer/app/testIds.ts`：新增 social room 相关 testids。
  - `client/src/renderer/app/App.tsx`：新增 Social Room 卡片与状态管理；监听 WS `ROOM_EVENT` 并展示事件列表。
  - `client/src/renderer/vite-env.d.ts`：补齐 `DesktopApi.social` typings（并补齐 saves/personas，减少 renderer 的 `as unknown`）。
- 遗留/约束：
  - WS v1 事件偏“重连 replay”语义；UI 侧只展示收到的 `ROOM_EVENT`，若未连接/未重连则不会自动出现。
  - 事件列表做了长度裁剪（仅保留最近 N 条）以避免调试面板长时间运行时无限增长。

## [2026-02-14 19:10] - 任务：Task 19 客户端最小 UI 补齐（Social Room 卡片 + IPC + ROOM_EVENT 展示）
- 原始需求：客户端补齐最小可操作 UI：创建房间/邀请/加入；并能在调试面板中看到 `ROOM_EVENT`（来自 WS 重连 replay）。
- 实现目标/逻辑：
  - renderer：在 `client/src/renderer/app/App.tsx` 新增 Social Room 卡片，按钮调用 preload 暴露的 `window.desktopApi.social`；UI 全部用 `client/src/renderer/app/testIds.ts` 常量作为稳定 `data-testid`。
  - IPC + REST：renderer 不直接接触 token；Social REST 请求全部由 main 进程 handler 发起，并复用 main 侧的 `fetchAuthedJson`（把鉴权与敏感信息留在主进程）。
  - WS 展示：监听 ws 事件流中的 `ROOM_EVENT`，将 payload 追加到列表用于可视化；由于事件来自“重连 replay + 多 save fan-out”可能重复，按 `server_event_id` 去重。
- 核心变更：
  - `client/src/renderer/app/App.tsx`
  - `client/src/renderer/app/testIds.ts`
  - `client/src/preload/index.ts`
  - `client/src/main/index.ts`
  - `client/src/renderer/vite-env.d.ts`
- 遗留/约束：
  - `ROOM_EVENT` 可能需要先连接/重连 WS 才能收到（依赖 server 侧 replay 语义），UI 文案需明确提示“可能需要先连接/重连”。
  - renderer 侧不读取/不缓存 token；所有 authed REST 仍必须走 main。

## [2026-02-14 18:43] - 任务：Task 20 计划任务（UGC 工坊骨架）
- 原始需求：实现 UGC 资源上传（pending）+ Admin 审核通过/拒绝（带审计）+ Client 仅拉取 approved 资源列表（本次仅做 server list endpoint + pytest 证据）。
- 实现目标/逻辑：
  - UGC 上传：`POST /api/v1/ugc/assets`（Bearer JWT）接收 multipart：`file` + `manifest_json` + `asset_type`；服务端创建 `ugc_assets(status='pending')`，并将文件落盘到 `server/.data/ugc/<asset_id>/original`（路径由服务端生成，不信任用户文件名）。
  - UGC 列表：`GET /api/v1/ugc/assets` 默认仅返回 `approved`（client 拉取安全默认）；支持 `?status=approved`，其他 status 直接 400。
  - Admin 审核：`POST /api/v1/admin/review/ugc/{asset_id}:approve|reject` 通过 `X-Admin-Secret` 保护（`settings.admin_review_secret`）；改写资源 `status` 并写入 `audit_logs`（actor/action/target_id/created_at，metadata 记录 from/to）。
  - 默认 admin secret：本地/测试用随机默认值；生产环境必须显式设置环境变量（避免误用默认值）。
- 核心变更：
  - `server/app/db/models.py`：新增 `UgcAsset`、`AuditLog`
  - `server/app/core/config.py`：新增 `admin_review_secret`
  - `server/app/api/v1/ugc.py`：新增 UGC upload + list
  - `server/app/api/v1/admin_review.py`：新增审核 approve/reject
  - `server/app/api/v1/router.py`：挂载 ugc + admin_review routers
  - `server/tests/test_task_20_ugc_approve.py`：pytest 闭环 + evidence 落盘 `.sisyphus/evidence/task-20-ugc-approve.txt`
- 遗留/约束：
  - 本任务不做 Admin RBAC/login（后续 Task 22）；审计 actor 当前固定为 `admin` 字符串。
  - 客户端 UI/IPC 拉取 approved 列表后续单独任务补齐。

## [2026-02-14 21:40] - 任务：Task 21 插件系统 alpha（Server 侧）
- 原始需求：实现插件包上传（pending）→ 管理员审核 approve/reject（写审计）→ 客户端仅 list/download approved。
- 实现目标/逻辑：
  - 数据模型：新增 `PluginPackage`（`plugin_id/version/name/entry/permissions_json/manifest_json/code_text/sha256/status/created_at/updated_at`），并对 `(plugin_id, version)` 做唯一约束。
  - Manifest 规则：`manifest_json` 必须是 JSON object，且包含 `id/version/name/entry/permissions`；其中 `entry` 必须为 `index.js`；`permissions` 必须显式声明（object 或 list），为空表示默认 deny。
  - Admin 上传：`POST /api/v1/plugins`（`X-Admin-Secret: <settings.admin_review_secret>`），body 为 `{manifest_json: string, code: string}`；服务端校验并将 manifest/permissions 做 canonical JSON（`ensure_ascii=True, separators=(",",":"), sort_keys=True`），并计算 `sha256(code)`；创建 `status='pending'`。
  - Admin 审核：`POST /api/v1/admin/review/plugins/{plugin_id}/{version}:approve|reject`（同样用 `X-Admin-Secret` 保护）；更新 status 并写 `AuditLog`：`action='plugin.approve'|'plugin.reject'`，`target_type='plugin_package'`，metadata 记录 from/to。
  - Client 拉取：`GET /api/v1/plugins`（Bearer JWT，复用 `require_user_id`）仅返回 approved 列表（`id/version/name/sha256/permissions`）；`GET /api/v1/plugins/{plugin_id}/{version}` 仅允许下载 approved（未批准一律 404）。
- 核心变更：
  - `server/app/db/models.py`：新增 `PluginPackage`
  - `server/app/api/v1/plugins.py`：新增 plugins router（upload/list/download）
  - `server/app/api/v1/admin_review.py`：扩展插件包 approve/reject + 审计
  - `server/app/api/v1/router.py`：挂载 plugins router
  - `server/tests/test_task_21_plugins.py`：pytest 闭环（upload→approve→list→download）
- 遗留/约束：本任务只落库与下发 permissions，不实现“权限执行/沙箱/运行时拦截”；Admin 仍为共享密钥模式（不做 RBAC/login）。

## [2026-02-14 21:10] - 任务：Task 20 客户端补齐（仅拉取 approved 资源列表）
- 原始需求：补齐 Task 20 的客户端部分：调试面板新增“UGC 工坊（只拉取 approved）”卡片；renderer 不直接 fetch/不接触 token；走 main 侧 authed fetch 拉取 `GET /api/v1/ugc/assets?status=approved` 并渲染列表（至少显示 id + asset_type），失败显示 `.danger`。
- 实现目标/逻辑：
  - UI：新增 UGC 卡片（刷新按钮 + 列表容器 + item），新增元素全部使用 `data-testid`，并集中维护在 `client/src/renderer/app/testIds.ts`。
  - IPC：renderer -> preload -> main 走 `ipcRenderer.invoke('ugc:listApproved')`；main 侧复用 `fetchAuthedJson`（携带 token）请求固定 endpoint，并用 `throwApiErrorForStatus` 统一映射错误码。
  - 数据：主进程返回最小字段 `{ id, asset_type }[]`（过滤空值），renderer 仅展示不做编辑。
- 核心变更：
  - `client/src/renderer/app/testIds.ts`（新增 UGC 相关 testids）
  - `client/src/renderer/app/App.tsx`（新增 UGC 卡片：刷新 + approved 列表展示 + danger 错误）
  - `client/src/preload/index.ts`（暴露 `desktopApi.ugc.listApproved()`）
  - `client/src/main/index.ts`（新增 IPC handler：`ugc:listApproved` → GET `/api/v1/ugc/assets?status=approved`）
  - `client/src/renderer/vite-env.d.ts`（补齐 `DesktopApi.ugc` typings）
- 遗留/约束：客户端暂不做上传/审核 UI（后续 Task 22 做 admin）；UGC 列表当前固定只拉取 `approved`（避免误展示未审核内容）。

## [2026-02-14 22:40] - 任务：Task 21 客户端 core（插件运行时 + feature flag + Debug Panel + IPC）
- 原始需求：实现插件系统 alpha 的客户端核心：默认关闭；主进程负责 list/download/sha256 校验与落盘；插件在独立子进程中用 vm 执行，并通过 IPC 回传菜单项；renderer 只通过 preload API 驱动调试卡片，不直接 fetch。
- 实现目标/逻辑：
  - Feature flag：插件执行 `enabled` 默认 `false`（首次启动不创建/不拉起任何插件 host）。状态持久化到 userData（支持 `PARA_USER_DATA_DIR` 覆盖）。
  - IPC：新增 `desktopApi.plugins`：`getStatus/setEnabled/listApproved/install/getMenuItems`；renderer 不碰 token，所有网络请求在主进程复用 `fetchAuthedJson`/Bearer token 完成。
  - 安装与校验：`GET /api/v1/plugins` 拉取 approved 列表（字段 `id/version/name/sha256/permissions`），选择后 `GET /api/v1/plugins/{id}/{version}` 下载 code text；主进程计算 `sha256(code)` 校验一致后写入 `userData/plugins/bundles/<id>/<version>/index.js`。
  - 隔离执行：主进程 `child_process.fork(dist/main/plugin_host.js)` 拉起 host；host 内用 `vm.createContext`（尽量禁用 `codeGeneration.strings/wasm`）+ `runInContext(timeout=...)` 执行插件代码。
  - 插件 API（alpha deny-all 权限模型）：插件必须显式带 `permissions`（允许 `{}` / `[]` 代表 deny-all），但 alpha 阶段不授予额外能力，仅提供 `say(text)` / `suggestion(text)` / `addMenuItem({id,label})`；并在 host 侧做文本长度与菜单项数量上限。
- 核心变更：
  - `client/src/main/index.ts`（PluginManager + 持久化 + IPC handlers + fork host + menu items 缓存）
  - `client/src/main/plugin_host.ts`（子进程入口：vm 执行 + API 限流）
  - `client/src/preload/index.ts`（暴露 `desktopApi.plugins`）
  - `client/src/renderer/app/testIds.ts`（新增 plugins 相关 testids）
  - `client/src/renderer/app/App.tsx`（Debug Panel 新增 Plugins 卡片）
  - `client/src/renderer/vite-env.d.ts`（补齐 `DesktopApi.plugins` typings）
- 遗留/约束：
  - `say/suggestion` 目前仅做“从插件到主进程”的管道与长度裁剪，暂未接入桌宠气泡/主 UI 展示（后续接入 Pet radial menu 与气泡系统）。
  - `vm` 不是安全边界；当前实现只做 alpha 级别隔离与限流（子进程 + 禁用字符串代码生成尽力而为 + 同步执行 timeout）。

## [2026-02-14 20:00] - 任务：Task 21 插件运行时/协议链路打通（Client）
- 原始需求：对齐 server download JSON 协议，打通“菜单点击回路”与“插件输出 push 到 renderer（至少桌宠窗口可订阅）”，并保持默认关闭。
- 实现目标/逻辑：
  - 下载：`GET /api/v1/plugins/{id}/{version}` 按 JSON `{manifest_json, code, sha256}` 解析；用 `sha256(code)` 校验（同时对比 list 返回的 sha256 与 download 返回的 sha256），再把 `code` 落盘到 `userData/plugins/bundles/<id>/<version>/index.js`。
  - 点击：plugin host 支持 `onMenuClick(id, fn)` 注册回调；主进程新增 `plugins:menuClick` IPC，把点击请求转发给 host（带 requestId），host 在 vm 内执行并回传 `menu:click:result`；两侧均做超时与 pending 数量上限。
  - 输出：主进程把插件 `say/suggestion` 通过 `plugins:output` 广播到所有窗口；preload 暴露 `desktopApi.plugins.onOutput` 供 renderer/pet 订阅。
  - 多窗口：push 走广播函数（`safeSendToAllRenderers`），避免原 `safeSendToRenderer` 只偏向 mainWindow 导致桌宠收不到。
- 核心变更：`client/src/main/index.ts`、`client/src/main/plugin_host.ts`、`client/src/preload/index.ts`、`client/src/renderer/vite-env.d.ts`；并按要求追加更新 notepads。
- 遗留/约束：未实现 ESM export/模块系统；仍为“脚本式插件”；`vm` 非安全边界，仅做 alpha 级别限流与超时。

## [2026-02-14 20:21] - 任务：Task 21 插件系统验收证据补齐（Electron Playwright e2e）
- 原始需求：只补齐 Task 21 的“自动化验收证据”部分：新增 Playwright Electron e2e + 证据截图；不改 plan 勾选、不新增依赖。
- 实现目标/逻辑：沿用现有 e2e 模式（spec 内 stub server + 临时 userData + 写入 `auth.tokens.json` + 双窗口选择），覆盖“默认关闭→开启→安装→桌宠菜单点击→气泡输出”闭环。
- 核心变更：
  - 新增 `client/playwright/electron-plugin.spec.ts`：stub `/api/v1/plugins` 与 `/api/v1/plugins/{id}/{version}` 返回 1 个 approved 插件；sha256 由 spec 内对 code 真实计算；并 stub `/api/v1/auth/me` 维持登录态。
  - 成功时截图证据写入：`.sisyphus/evidence/task-21-plugin.png`（从 `client/` cwd 回到 repo root）。
- 遗留/约束：Electron e2e 在无 `$DISPLAY` 的 Linux 上仍需 `xvfb-run -a`（仓库已有 wrapper）；测试依赖 `client/dist/main/index.js` 已构建。

## [2026-02-14 22:30] - 任务：Task 22 Server：最小管理后台 API（Admin RBAC + Config + Feature Flags + Metrics）
- 原始需求：落地最小管理后台 server 侧 API：admin 登录（Bearer token）+ RBAC（super_admin/operator）+ 配置与 feature flags 持久化 + metrics summary；并提供 pytest 验收（login + put flags + user get flags）。
- 实现目标/逻辑：
  - Admin 登录：新增 `admin_users` 表，复用 `core.security` 的 PBKDF2 hash/verify 与 JWT HS256 编码/解码；admin token 用独立 settings secret（避免与用户 token 混用）。
  - RBAC：`super_admin` 可 `PUT`，`operator` 仅 `GET`；鉴权通过 `Authorization: Bearer <admin_token>`。
  - 配置/flags：新增 `admin_kv`（namespace+key 唯一），`value_json` 存储 canonical JSON（`ensure_ascii=True, separators=(",",":"), sort_keys=True`）；feature flags 最小字段 `plugins_enabled: bool`，默认 false。
  - Metrics：`GET /api/v1/admin/metrics/summary` 返回稳定结构（含 `generated_at`、`audit_log_count_24h`、`admin_user_count`）。
- 核心变更：
  - `server/app/db/models.py`：新增 `AdminUser`、`AdminKV`
  - `server/app/core/config.py`：新增 `admin_access_token_secret`、`admin_access_token_ttl_seconds`
  - `server/app/api/v1/admin_auth.py`：`POST /api/v1/admin/auth/login`
  - `server/app/api/v1/admin_deps.py`：admin bearer 解析 + RBAC 依赖
  - `server/app/api/v1/admin_config.py`：config/models/prompts/feature_flags GET/PUT
  - `server/app/api/v1/admin_metrics.py`：metrics summary
  - `server/app/api/v1/feature_flags.py`：普通用户拉取生效 flags
  - `server/app/api/v1/router.py`：挂载新增 routers
  - `server/tests/test_task_22_admin_flags.py`：pytest 覆盖 login + RBAC + flags 下发 + canonical JSON
- 遗留/约束：暂不提供“创建第一个 admin”的生产化 bootstrap 通道；不改动既有 `admin_review.py` 的 `X-Admin-Secret` 守卫。

## [2026-02-14 20:57] - 任务：Task 22 Client：feature flags 轮询驱动插件实时启停（plugins_enabled）
- 原始需求：实现“修改一个开关 → 客户端实时生效”的客户端侧最小闭环：主进程轮询 `GET /api/v1/feature_flags`，并用 `feature_flags.plugins_enabled` 实时启停插件执行；当关闭时插件菜单项必须为空且 plugin host 停止；当从 false->true 且本地 enabled=true 且已安装插件存在时应自动启动 host。
- 实现目标/逻辑：
  - 仅改 main：在主进程新增保守轮询（1200ms，带错误吞吐），按 `PARA_SERVER_BASE_URL` 拼出 `/api/v1/feature_flags` 请求；不新增依赖。
  - 将 `PluginManager` 的“本地 enabled=true”与“远端 plugins_enabled=true”做 AND 组合为唯一执行条件；任何一侧关闭都立即 stop host + 清空 menu。
  - 远端从 false->true 时触发一次 reconcile：若本地 enabled=true 且 installed 存在则自动启动 host 并重新产出菜单项。
- 核心变更：
  - `client/src/main/index.ts`：新增 `FeatureFlagsPoller`（轮询 + 变更检测）与 `PluginManager.setRemotePluginsEnabled()`（远端 kill-switch + 统一 reconcile），并让 `desktopApi.plugins.getMenuItems()` 在 flags 关闭时稳定返回空数组。
- 遗留/约束：
  - 目前 feature flags 拉取先按 public/无 token 实现；若未来变为 bearer，可在 main 侧增加“401 时尝试 authed fetch”的兼容分支。
  - 默认安全策略：首次成功拉到 flags 前视为 `plugins_enabled=false`，因此在离线/endpoint 缺失时插件不会运行。

## [2026-02-14 21:09] - 任务：Task 22 验收证据（Admin 登录 -> 修改 feature flag -> 客户端实时生效）
- 原始需求：补齐 Task 22 的验收证据：Playwright Electron e2e 自动化闭环“登录 admin → 修改一个开关 → 客户端实时生效”，并生成截图 `.sisyphus/evidence/task-22-admin-flag.png`。
- 实现目标/逻辑：
  - e2e 仍采用“spec 内 stub server”策略：用 `http.createServer` 提供 `/api/v1/plugins` + `/api/v1/feature_flags` + admin login/PUT flags，避免依赖真实后端。
  - 初始 `plugins_enabled=false`：即使本地插件执行已开启且已安装插件，桌宠 pet 环形菜单也必须没有插件入口（远端 kill-switch 生效）。
  - 通过 `POST /api/v1/admin/auth/login` 获取 stub token，再 `PUT /api/v1/admin/config/feature_flags` 切到 `plugins_enabled=true`；等待 client 侧 `FeatureFlagsPoller(1200ms)` 拉到新值并自动启动 plugin host；最终在 pet 菜单断言插件入口出现，点击后出现 `pet-plugin-bubble`。
- 核心变更：
  - 新增 `client/playwright/electron-admin-flag.spec.ts`（stub server + 双窗口选择 + pet 断言 + evidence 截图）。
  - 证据：`.sisyphus/evidence/task-22-admin-flag.png`
- 遗留/约束：Electron e2e 需要先构建 `client/dist/main/index.js`（已由 `npm -C client run e2e` 自动执行 build）；Linux 无 DISPLAY 时依赖 `xvfb-run -a`（已有 wrapper 自动兜底）。

## [2026-02-14 22:10] - 任务：Task 23 隐私/安全基线（同意弹窗、数据保留、日志脱敏、审计）
- 原始需求：为“敏感能力”补齐客户端同意 UI（插件执行开关需与 vision 同模式，可拒绝/可撤回）；服务端对截图与 admin feature flags 变更写入 `audit_logs`；提供最小可执行的数据保留策略；并做日志脱敏兜底（Authorization/token/base64/插件 code 等不出现在最终日志输出）。
- 实现目标/逻辑：
  - Client：在 `plugins` toggle 从关闭->开启时弹出同意面板；同意后才调用 `desktopApi.plugins.setEnabled(true)`；拒绝保持关闭；开启后点击按钮可撤回关闭。
  - Server 审计：
    - 截图：`POST /api/v1/sensors/screenshot` 成功调用写 `AuditLog(action='sensors.screenshot', target_type='save', target_id=<save_id>, actor='user:<user_id>')`，metadata 仅记录 bytes/宽高/隐私模式/是否 emit。
    - Feature flags：`PUT /api/v1/admin/config/feature_flags` 当 `plugins_enabled` 发生变化时写 `AuditLog(action='feature_flags.update', target_type='feature_flags', target_id='global', actor='admin:<admin_id>')`，metadata 记录 changes.from/to。
    - 插件 approve/reject：沿用 Task 21 已有 `plugin.approve`/`plugin.reject` 审计（不改语义）。
  - 日志脱敏兜底：在 logging formatter 层对最终输出字符串做 regex 替换（Bearer token、image_base64、data URL base64、code/manifest_json、长 base64 串等）。

## [2026-02-14 22:19] - 任务：Task 24 CI/本地一键验收脚本（契约漂移 + 测试全绿）
- 原始需求：实现计划勾选项 Task 24：契约漂移检查 + server/client 测试全绿；任一步失败需要输出“哪一步失败 + 命令”；成功/失败都要写固定证据 `.sisyphus/evidence/task-24-ci.txt`。
- 实现目标/逻辑：新增 `scripts/ci.sh`，从脚本位置稳健定位 repo root，串行执行：`./scripts/generate-contracts.sh --check`（复用既有契约导出/TS 生成与 drift 检测逻辑）-> `(cd server && uv run pytest)` -> `npm -C client test`；每步前后打印稳定 marker；整体 stdout/stderr 通过 `tee` 写入证据文件。
- 核心变更：新增 `scripts/ci.sh`；证据路径固定为 `.sisyphus/evidence/task-24-ci.txt`（从仓库根定位）。
- 遗留/约束：不修改计划文件、不新增依赖；该证据文件每次运行会覆盖写入（确保单次验收日志完整、可追溯）。
  - Data retention：新增 settings `audit_log_retention_days`（默认 90），并提供最小清理入口 `POST /api/v1/admin/config/audit_logs:cleanup?days=N`（super_admin）。
- 核心变更：
  - `client/src/renderer/app/App.tsx`：抽出轻量 `ConsentPanel`，复用到 vision 与 plugins；plugins toggle 增加同意 gate。
  - `client/src/renderer/app/testIds.ts`：新增 `pluginsConsentPanel/pluginsConsentAccept/pluginsConsentDecline`。
  - `client/playwright/electron-plugin.spec.ts`、`client/playwright/electron-admin-flag.spec.ts`：兼容 plugins consent panel（若出现则点击 accept）。
  - `server/app/core/logging.py`：新增 `RedactingFormatter` 并在 `configure_logging()` 中启用。
  - `server/app/api/v1/sensors.py`：截图 endpoint 写审计（metadata 不含截图内容）并仅记录元信息日志。
  - `server/app/api/v1/admin_config.py`：feature flags 变更写审计；新增 audit_logs cleanup endpoint。
  - `server/app/core/config.py`：新增 `audit_log_retention_days`。
  - `server/tests/test_task_23_privacy_audit.py`：覆盖脱敏 formatter + screenshot/admin flags 审计入库 + retention cleanup；并生成证据 `.sisyphus/evidence/task-23-audit.txt`。
- 遗留/约束：脱敏为“兜底层”，仍应遵守“不打印 body/token/base64/prompt/plugin code”的编码纪律；脱敏可能会对含长 base64 的调试输出做过度替换（属于预期的安全优先）。

## [2026-02-14 23:10] - 任务：Task 23 服务端校正（脱敏收敛 + 审计规范 + retention helper）
- 原始需求：按 Task23 验收补齐“无敏感日志 + 审计表有记录 + 可执行保留策略 + 证据文件”，并避免脱敏规则误伤 WS `CHAT_TOKEN`。
- 实现目标/逻辑：
  - 脱敏：移除对通用 key `token` 的正则匹配；增加 `access_token/refresh_token` 的 key=value 形式脱敏，以及 JSON/pydict 的 `authorization: "Bearer ..."` 形式脱敏；保留 `Authorization: Bearer`、`image_base64`、`data:image/*;base64,` 与长 base64 串兜底。
  - 审计：截图 action 统一为 `vision.screenshot`；feature flags 审计 metadata 改为 `namespace/key/changed_keys + prev/next sha256+len`，不写入完整 flags JSON。
  - 保留：抽出 `purge_old_audit_logs(db, now, retention_days)` helper，并让 `POST /api/v1/admin/config/audit_logs:cleanup` 复用；测试直接调用 helper 验证。
- 核心变更：
  - `server/app/core/logging.py`：收敛 token 脱敏规则，补齐 JSON 与 key=value 模式。
  - `server/app/api/v1/sensors.py`：action 改为 `vision.screenshot`。
  - `server/app/api/v1/admin_config.py`：feature flags 审计 metadata 变更为 hash/len 摘要；cleanup 调用 helper。
  - `server/app/core/audit.py`：新增 `purge_old_audit_logs`。
  - `server/tests/test_task_23_privacy_audit.py`：更新断言与证据输出，避免写入真实 token/base64。
- 遗留/约束：长 base64 串兜底正则可能对某些长随机字符串做过度脱敏（安全优先）；仍需遵守编码纪律避免打印 body/token/base64。

## [2026-02-14 22:29] - 任务：Task 25 Alpha E2E QA Runner（端到端证据产出）
- 原始需求：新增 `./scripts/qa_alpha.sh` 一键跑通 CI + Electron e2e，并在 `.sisyphus/evidence/` 产出与校验证据；输出稳定 marker；失败指出缺少哪些证据。
- 实现目标/逻辑：
  - 复用 `scripts/ci.sh` 作为后端/合同/单测主链路，避免重复实现 curl/鉴权。
  - 复用 Playwright Electron specs 作为 UI 端到端截图证据来源（登录/聊天流/投喂/相册/时间轴）。
  - 以“关键文件存在性检查”作为强约束（比单纯计数更抗误报），并保留最小证据数量阈值（>=10）。
  - 用外层 `tee` 写 `.sisyphus/evidence/task-25-qa-alpha.txt`，并通过 `PIPESTATUS` 保留真实 exit code（避免 pipe 吞掉失败）。
- 核心变更：新增 `scripts/qa_alpha.sh`；证据 `.sisyphus/evidence/task-25-qa-alpha.txt`。
- 遗留/约束：不修改计划文件、不新增依赖；required evidence 列表需保持与 DoD 链路绑定，未来改动 e2e/pytest 输出名时需要同步更新脚本。
