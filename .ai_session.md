## [2026-02-18 20:12] - 任务：Task 3（admin-web：Feature Flags 增加 invite_registration_enabled + e2e stub 覆盖）
- 原始需求：完成计划 `.sisyphus/plans/first-user-admin-lockdown.md` 第 3 项：在 `admin-web` 的 Feature Flags 页面加入 `invite_registration_enabled` 开关；文案必须明确“开启仅表示允许邀请码注册，不代表开放无邀请码注册”；保存时允许 partial update（仅提交变更字段，不要求同时提交 `plugins_enabled`）；同步更新 Playwright web-admin stub 覆盖该开关。
- 实现目标/逻辑：
  - UI：在 `FeatureFlagsPage` 增加第二个开关（邀请码注册），dirty 由两个字段的 diff 共同决定；保存按钮只在 dirty 时启用，且保存时仅发送发生变化的 key。
  - API：`AdminFeatureFlags` 类型增加 `invite_registration_enabled?: boolean`；PUT wrapper 改为接收 `AdminFeatureFlagsUpdate`（partial payload）。
  - E2E：`client/playwright/web-admin-feature-flags.spec.ts` 的 stub backend 支持 GET/PUT `/api/v1/admin/config/feature_flags` 的 `invite_registration_enabled`，并断言“仅切换该开关时 PUT body 只包含该字段”。
- 核心变更：`admin-web/src/pages/FeatureFlagsPage.tsx`、`admin-web/src/lib/api.ts`、`client/playwright/web-admin-feature-flags.spec.ts`。
- 验证：对改动文件运行 `lsp_diagnostics` 无报错；`npm --prefix admin-web run build` 通过。

## [2026-02-18 20:25] - 任务：修复 e2e flaky（web-admin-feature-flags：Electron 菜单项偶发不出现）
- 原始需求：修复 `client/playwright/web-admin-feature-flags.spec.ts` 的失败：Electron 步骤偶发找不到 `plugins-menu-item`；保持覆盖目标不变，并在本机可稳定通过。
- 根因：plugins consent panel 可能在点击 toggle 后延迟出现；旧用例只做“立即可见”判断，偶发漏点 accept，导致 plugins 仍 disabled，菜单项不会渲染。
- 修复策略：
  - 等待 consent panel 在短窗口内变为 visible（或已 visible），再点击 accept；
  - 使用 `desktopApi.plugins.getStatus()` 的 `expect.poll` 等待 `enabled=true`、installedKey 匹配且 menuCount>0（并且 lastError 为 null），最后再断言 DOM 的 `plugins-menu-item` 可见。
- 核心变更：仅修改 `client/playwright/web-admin-feature-flags.spec.ts`。
- 验证：`npm --prefix client run e2e -- playwright/web-admin-feature-flags.spec.ts` 通过。

## [2026-02-18 20:45] - 任务：修复 e2e 并行互相干扰（web-admin shared dist 被覆盖）
- 原始需求：让 `client/playwright/web-admin-feature-flags.spec.ts` 与 `client/playwright/web-admin-invites.spec.ts` 在 2 workers 并行运行也稳定通过；不改业务代码，只改 e2e build/serve 方式。
- 根因：两个 spec 都通过不同的 `VITE_SERVER_BASE_URL` 构建 `admin-web` 到同一个 `admin-web/dist`，并行时产物互相覆盖，导致页面与 stub backend 不一致。
- 修复策略：
  - 两个 spec 均改用 `npm exec -- vite build --outDir <tmp>/dist` 进行构建（避免 `tsc -b` 并发写入与共享 dist），并设置 `cwd` 为 `admin-web` 目录；
  - 每个 spec 使用自己独立的 tmp outDir，并沿用原有静态 server（SPA fallback）去 serve；
  - 在 `finally` 清理 tmp outDir。
- 核心变更：`client/playwright/web-admin-feature-flags.spec.ts`、`client/playwright/web-admin-invites.spec.ts`。
- 验证：`npm --prefix client run e2e -- playwright/web-admin-feature-flags.spec.ts playwright/web-admin-invites.spec.ts` 通过（2 workers）。

## [2026-02-18 21:05] - 任务：Task 4（admin-web：邀请码管理页 + web-admin Playwright e2e）
- 原始需求：完成计划 `.sisyphus/plans/first-user-admin-lockdown.md` 第 4 项：在 `admin-web` 新增“邀请码管理”页面（生成/列表/撤销/查看 redemptions），并新增 Playwright web-admin e2e 用例覆盖核心链路（stub backend + 静态 dist server）。
- 实现目标/逻辑：
  - UI：新页面 `InvitesPage` 按 admin-web 现有 card/table/pagination 风格实现；列表只显示 `code_prefix` 等元信息不回显 `code`；创建成功后在页面内以明显 warn alert 展示一次性 `code` 并要求保存，用户点击“我已保存，关闭”后从状态清除，刷新后自然不可再见。
  - RBAC：operator 只读（创建/撤销禁用 + 提示），super_admin 可创建/撤销；列表与 redemptions 在两种角色下均可查看（与后端依赖一致）。
  - API：在 `admin-web/src/lib/api.ts` 增加 invites client（list/create/revoke/redemptions）与类型，所有请求走 `apiRequestJson` 复用既有 ApiError 脱敏策略。
  - E2E：新增 `client/playwright/web-admin-invites.spec.ts`，自建 stub backend 覆盖登录与 invites 相关 5 个端点；用例覆盖 登录 -> 进入邀请码页 -> 创建 -> 列表不回显 code -> 撤销 -> 查看 redemptions，并额外覆盖 operator 只读。
- 核心变更：`admin-web/src/pages/InvitesPage.tsx`、`admin-web/src/lib/routes.tsx`、`admin-web/src/lib/api.ts`、`client/playwright/web-admin-invites.spec.ts`、`.sisyphus/notepads/first-user-admin-lockdown/learnings.md`。
- 验证：
  - LSP：对改动文件 `lsp_diagnostics` 无报错
  - Build：`npm --prefix admin-web run build` 通过
  - E2E：`npm --prefix client run e2e -- playwright/web-admin-invites.spec.ts` 通过

## [2026-02-18 18:31] - 任务：Task 2（首用户 bootstrap 管理员 + invite-only 注册开关 + 并发互斥）
- 原始需求：执行计划 `.sisyphus/plans/first-user-admin-lockdown.md` 的第 2 项；实现 `/api/v1/auth/register` 的 bootstrap admin（空库首用户可无邀请码）、非 bootstrap invite-only（由 `invite_registration_enabled` 控制）、403 `registration_closed`，并证明并发首注册只成功一次；同时修复“注册失败但邀请码被消耗”的一致性风险；为 pytest 引入稳定的数据隔离策略。
- 实现目标/逻辑：
  - Bootstrap 优先级最高：当 `users` 表为空时，允许不带 `invite_code` 注册，并在同一事务内创建 `User` + `AdminUser(role=super_admin,is_active=true)`（同邮箱同密码可登录 admin-web）。
  - 非 bootstrap：读取 `AdminKV(feature_flags/global)` 中 `invite_registration_enabled`（仅认可 bool；缺省 true），关闭时无条件 403 `registration_closed`；开启时强制邀请码，缺失 403 `invite_code_required`。
  - 并发互斥：采用 `AdminKV(namespace='bootstrap', key='first_user')` 哨兵行并在事务中 `SELECT ... FOR UPDATE` 序列化首用户判断；并发请求在锁释放后只能有一个进入 bootstrap。
  - 邀请码一致性：仅在确认用户可创建且不会再走 rate-limit failure path 后才递增 `InviteCode.uses_count`，避免限速逻辑内部 commit 提前提交邀请码消耗。
  - 测试隔离：在 `server/tests/conftest.py` 增加 function-scope autouse fixture，于每个测试前按 `Base.metadata.sorted_tables` 逆序逐表 `DELETE`（单事务），避免“全套 pytest 共享脏库”导致的回归，并规避 Postgres `TRUNCATE ... CASCADE` 的锁冲突风险。
- 核心变更：`server/app/api/v1/auth.py`、`server/tests/conftest.py`、`server/tests/test_task_20_invite_codes.py`、新增 bootstrap/并发专项测试。
- 验证：`cd server && uv run pytest -q` -> 90 passed。
- 遗留/约束：不改 `admin-web/`、`client/`、`contracts/`；不新增依赖；不做 git 操作；不写入任何真实账号/密码/DSN。

## [2026-02-18 12:42] - 任务：Task 17（生产正式迁移与切流：停机 1-2 小时窗口）
- 原始需求：执行计划 Task 17，补齐生产切流 runbook（冻结写入->dump->传输->restore->migrations->smoke->cutover->rollback），完成远端 preflight，并输出可复制粘贴的停机窗口命令清单；仅在明确同意后执行真实迁移/切流并在服务器留证据。
- 实现目标/逻辑：
  - 文档：新增 `deploy/prod/migration/PROD_CUTOVER_RUNBOOK.md`，包含 copy/paste 命令清单与 `CHECKPOINT` gate；明确 staging-only 禁用开关（`DST_DROP_SCHEMA=1`/`ASSETS_DELETE=1`）及“演练脚本禁止指向生产”。
  - 验收：runbook 内置 smoke 流程（health + 登录 + WS 聊天 + 知识检索 + 附件下载），并用容器内 Python 交互脚本避免把 token 暴露到 shell history/进程列表。
  - 远端 preflight（非破坏）：验证 `https://para.pscly.cc/api/v1/health` 为 ok；确认 `docker compose ps` 全部 healthy；确认生产目录与既有 `task-16/task-18` evidence 目录存在。
- 核心变更：`deploy/prod/migration/PROD_CUTOVER_RUNBOOK.md`、`deploy/prod/migration/README.md`。
- 遗留/约束：尚未执行任何破坏性步骤；正式覆盖生产 DB/assets 与切流必须用户显式 Go-ahead；所有证据仅落在服务器目录（例如 `/root/dockers/para/backups/evidence/task-17/<timestamp>/`），禁止写入仓库。

## [2026-02-18 02:25] - 任务：Release v0.1.9（tag 发布工作流 + Windows NSIS 资产校验修复）
- 原始需求：新增 tag 驱动的 GitHub Release 工作流；修复 `v0.1.8` Release 资产 `.sha256` 校验失败（sha 文件引用文件名与实际 exe 资产名不一致）；并把 repo 版本从 `0.1.8` bump 到 `0.1.9`（client/admin-web/server/OpenAPI），确保 `./scripts/ci.sh` 与 `python scripts/sync_versions.py --check` 在 tag 场景通过。
- 实现目标/逻辑：
  - 复现根因：下载 `v0.1.8` 后 `sha256sum -c *.sha256` 失败，因 `.exe.sha256` 第二列写的是 `Para Desktop Setup 0.1.8.exe`（空格）而实际资产名是 `Para.Desktop.Setup.0.1.8.exe`（点）。
  - 修复策略：在 release workflow 的 `Resolve installer + sha256` 中先把选中的 NSIS installer copy/rename 成稳定名 `Para.Desktop.Setup.<version>.exe`（无空格），再对该规范化文件生成同名 `.sha256`（第二列写同名），并上传这两个规范化产物到 GitHub Release，保证机器验收 `sha256sum -c` 直接通过。
  - 版本对齐：使用 `scripts/sync_versions.py --write --export-openapi --version 0.1.9` 对齐 `client/admin-web/server` 版本与 `contracts/openapi.json` 的 `info.version`，确保 tag 环境变量解析场景下 `--check` 通过。
- 核心变更：`.github/workflows/release.yml`、`client/package.json`、`admin-web/package.json`、`server/pyproject.toml`、`contracts/openapi.json`、`server/uv.lock`。
- 验证：
  - 本机 `./scripts/ci.sh` -> `ALL GREEN`；`GITHUB_REF_NAME=v0.1.9 python scripts/sync_versions.py --check` 通过。
  - LSP：对 `.github/workflows/release.yml`、`client/package.json`、`admin-web/package.json`、`contracts/openapi.json` 运行 `lsp_diagnostics` 无报错；由于当前环境未配置 TOML/lock LSP，额外用 `tomllib` 校验 `server/pyproject.toml` 与 `server/uv.lock` 语法 OK。
- 遗留/约束：不覆写任何既有 tag（如 `v0.1.8`）；Release 需要 push 新 tag `v0.1.9` 触发；严禁将任何 secrets 写入仓库或日志。

## [2026-02-17 22:54] - 任务：生产 bootstrap 第一个 AdminUser（创建/重置）
- 原始需求：为生产环境补齐“创建/重置第一个 AdminUser”的安全 bootstrap 工具，以便后续完成计划 Task 10（`/admin` 可登录）。
- 实现目标/逻辑：新增 `python -m app.scripts.bootstrap_admin_user` 脚本，按 `normalize_email(email)` 幂等 create/update；密码来源优先 `--password-stdin`，其次 `BOOTSTRAP_ADMIN_PASSWORD`，否则生成随机密码（长度>=12、字母+数字、无空白）并只打印一次；创建默认 `role=super_admin` 且 `is_active=true`；更新默认重置密码（`--no-reset-password` 可禁用），可选更新 `role/is_active`。
- 核心变更：`server/app/scripts/bootstrap_admin_user.py`、`server/tests/test_bootstrap_admin_user_script.py`、`deploy/prod/README.md`、`.sisyphus/notepads/para-completion/learnings.md`。
- 验证：待跑 `./scripts/ci.sh`。
- 遗留/约束：不新增依赖；不改 DB schema；不把任何真实账号/密码写入仓库或日志。

## [2026-02-17 22:32] - 任务：Task 25（默认隐藏 Gallery/Timeline/Social 入口）
- 原始需求：完成计划 `.sisyphus/plans/para-completion.md` 的 Task 25 未勾选验收项：默认配置下 UI 不暴露 stub/次要模块入口；选择“默认隐藏”路线，并保证现有 e2e 不回归。
- 实现目标/逻辑：
  - Preload：暴露只读开关 `desktopApi.labsEnabled`（显式 opt-in：仅当 env `PARA_LABS=1` 时为 true；缺省/异常均视为 false）。
  - Renderer：`client/src/renderer/app/App.tsx` 依据 `labsEnabled` 条件渲染，默认不渲染 Gallery/Timeline/Social 的卡片入口（fail-closed）。
  - E2E：gallery/timeline 用例在 `electron.launch({ env: ... })` 显式注入 `PARA_LABS=1`；smoke 用例显式清理 `PARA_LABS` 并断言相关入口不存在。
- 核心变更：
  - `client/src/preload/index.ts`（新增 `desktopApi.labsEnabled`）
  - `client/src/renderer/app/App.tsx`（隐藏 Gallery/Timeline/Social 入口的条件渲染）
  - `client/src/renderer/vite-env.d.ts`（补齐 `DesktopApi.labsEnabled` 类型）
  - `client/playwright/electron-gallery.spec.ts`、`client/playwright/electron-timeline.spec.ts`（显式注入 `PARA_LABS=1`）
  - `client/playwright/electron-smoke.spec.ts`（默认隐藏断言）
  - `.sisyphus/plans/para-completion.md`、`.sisyphus/notepads/para-completion/learnings.md`（任务验收与证据补齐）
- 验证：
  - `npm -C client run e2e -- electron-smoke.spec.ts`
  - `npm -C client run e2e -- electron-gallery.spec.ts`
  - `npm -C client run e2e -- electron-timeline.spec.ts`
  - `./scripts/ci.sh`
- 遗留/约束：不新增依赖；不改动 server API/contracts；默认 UI 不出现任何“引导开启实验功能”的入口。

## [2026-02-17 22:18] - 任务：Task 4（版本在产物中可见：About/日志/响应头）
- 原始需求：计划 `.sisyphus/plans/para-completion.md` 的 Task 4 未勾选验收项：tag `v0.1.0` 构建出的客户端 About/日志/接口 header 能打印 `0.1.0`。
- 实现目标/逻辑：
  - Renderer：顶部 meta 区域在保留 Electron/Node 版本展示的同时，额外展示 App 版本（例如 `App: 0.1.0`），并提供稳定 `data-testid` 便于 e2e 断言。
  - Preload/Main：通过 IPC `app:getVersion` 向 renderer 暴露 `desktopApi.getAppVersion()`；主进程启动时打印 `[main] app_version=<version>`。
  - 版本来源：优先使用 `PARA_APP_VERSION` 覆盖；在 e2e/开发态（`electron <dist/main/index.js>`）避免 `app.getVersion()` 返回 Electron 本身版本，兜底读取 `client/package.json` 的 `version`。
  - Server：HTTP middleware 给任意响应增加 `X-Para-Version`，值来自 `get_app_version()`，并与 FastAPI 的 `app.version` 一致。
- 核心变更：
  - `client/src/preload/index.ts`（新增 `desktopApi.getAppVersion()`）
  - `client/src/main/index.ts`（新增 `app:getVersion` handler + 启动日志）
  - `client/src/renderer/app/App.tsx`（顶部 meta 展示 App 版本 + `data-testid`）
  - `client/src/renderer/app/testIds.ts`（新增 `appMetaVersions`）
  - `client/src/renderer/vite-env.d.ts`（补齐 typings）
  - `client/playwright/electron-version.spec.ts`（新增 e2e：断言版本展示 == client/package.json version）
  - `server/app/main.py`（middleware 增加 `X-Para-Version`）
  - `server/tests/test_task_4_version_header.py`（新增 pytest：断言 header == get_app_version()）
- 验证：
  - `npm -C client run e2e -- electron-version.spec.ts` 通过
  - `cd server && uv run pytest -q` 通过
  - `./scripts/ci.sh` 通过
- 遗留/约束：不引入新依赖；不写入任何 secrets/DSN/key。

## [2026-02-17 21:29] - 任务：修复 qa_beta（uvicorn multiproc WS 404 / missing_ws_dependency_for_uvicorn）
- 原始需求：`./scripts/qa_beta.sh` 失败：uvicorn `--workers 2` 启动后 WS 路径 `/ws/v1` 握手降级为 404，日志提示 `No supported WebSocket library detected` / `missing_ws_dependency_for_uvicorn`。
- 实现目标/逻辑：uvicorn 的 WS 支持依赖可选库 `websockets` 或 `wsproto`；当前 server 仅声明 `uvicorn`，导致 upgrade 被拒绝。选择最小增量方案：在 `server/pyproject.toml` 显式增加 `websockets` 依赖（不切换到 `uvicorn[standard]`，避免引入更多 extras）。
- 核心变更：`server/pyproject.toml`、`server/uv.lock`、`.sisyphus/notepads/para-completion/issues.md`、`.sisyphus/notepads/para-completion/learnings.md`。
- 验证：`cd server && uv run uvicorn app.main:app --workers 2` 可正常启动且不再提示缺失 ws lib；`./scripts/qa_beta.sh` 与 `./scripts/ci.sh` 均 exit 0。
- 遗留/约束：不修改任何业务逻辑；不写入任何 secrets/DSN。

## [2026-02-17 21:30] - 任务：Task 19（Desktop：para_appenc 持久化开关 + 端到端加密 req/resp + 离线 e2e）
- 原始需求：桌面端 appenc 默认关闭，由“持久化开关”控制；keys 仅从 env `PARA_APPENC_KEYS` + `PARA_APPENC_PRIMARY_KID` 读取且不落盘；开关打开但 keys 缺失/非法时不 crash，fail-closed 并让 renderer 可见错误；仅对 `application/json` 且非空 body 的请求加密；新增离线可复现的 Electron Playwright 用例，显式断言 stub server 观测到 `X-Para-Enc: v1`。
- 实现目标/逻辑：
  - 主进程：把 appenc 启用逻辑从 env-only 改为持久化开关；启用时才尝试解析 keys/env 并对 JSON body 请求封装 envelope；解密响应时若服务端返回加密响应但本地未启用则直接报错（避免 silent downgrade）。
  - 配置持久化：使用 appData 下独立小文件 `Para Desktop/para.security.json`，原子写入（tmp + rename），字段 `appEncEnabled`。
  - Fail-closed：开关打开但 keys 缺失/非法时不抛出导致崩溃；自动回退关闭并通过 IPC 返回稳定错误码给 renderer 展示。
  - E2E：本地 Node http stub server 同时支持明文 JSON 与 appenc envelope，覆盖关闭/开启/关闭回退三段流程。
- 核心变更：`client/src/main/index.ts`、`client/src/preload/index.ts`、`client/src/renderer/app/App.tsx`、`client/src/renderer/app/testIds.ts`、`client/src/renderer/vite-env.d.ts`、`client/playwright/electron-appenc.spec.ts`。
- 验证：由用户执行 `npm -C client run e2e -- electron-appenc.spec.ts` 与 `./scripts/ci.sh`。
- 遗留/约束：不新增依赖；不写入真实 keys；测试 keys 仅在 e2e 运行时通过 Electron env 注入且不打印。

## [2026-02-17 20:05] - 任务：修复 CI flaky（Task 9 admin llm channels 测试残留污染）
- 原始需求：`./scripts/ci.sh` 失败：`server/tests/test_task_9_admin_llm_channels.py` 期望 channels 列表为空，但重复运行/本机残留 `AdminLLMChannel` 导致断言失败。
- 实现目标/逻辑：让测试不依赖“全局 DB 天生干净”——在测试开始阶段使用 `SessionLocal()` 自清理：清空 `admin_llm_channels`、删除 `AdminKV(namespace='llm_routing', key='global')`，并显式 `commit()`；同时增强 `_admin_chat_channel_routing` 的 finally 清理逻辑，清理/提交失败直接 raise，避免静默污染后续。
- 核心变更：`server/tests/test_task_9_admin_llm_channels.py`、`server/tests/test_ws_v1_openai_streaming_stub.py`。
- 验证：`cd server && uv run pytest tests/test_task_9_admin_llm_channels.py` 通过。

## [2026-02-16 19:42] - 任务：Task 12 最小落地（稳定 HNSW 索引名）
- 原始需求：新增 Alembic 迁移，仅为 `memory_embeddings.embedding` 与 `knowledge_chunks.embedding` 创建 pgvector ANN 索引（HNSW），并与 `<->`（L2）匹配使用 `vector_l2_ops`；索引名稳定为 `idx_*`。
- 实现目标/逻辑：新增迁移 `b7c3a1d9e4f2_vector_hnsw_indexes.py`：先尝试将历史命名 `ix_*` 的索引无损重命名为 `idx_*`（避免同列重复索引），再用 `CREATE INDEX IF NOT EXISTS ... USING hnsw (embedding vector_l2_ops)` 兜底创建。
- 核心变更：`server/alembic/versions/b7c3a1d9e4f2_vector_hnsw_indexes.py`、`.sisyphus/notepads/para-completion/learnings.md`。
- 遗留/约束：不修改任何 API 代码；不引入新依赖；不改动历史迁移。
- 验证：`./scripts/ci.sh` 通过。
- 证据：
  - sha: f506b3903bb1053a51fef47e000fc1eccabb0ec4
  - CI run: https://github.com/pscly/para/actions/runs/22061056673
  - deploy run: https://github.com/pscly/para/actions/runs/22061098181
  - health ok: `curl -fsS https://para.pscly.cc/api/v1/health` -> status ok

## [2026-02-17 12:30] - 任务：Task 16（迁移演练 dry-run：DB+资产复制 + 一致性校验）
- 原始需求：提供一套“可重复、可审计、无 secrets 入库”的迁移演练工具链：
  - DB：`pg_dump/pg_restore`（custom 或 directory）把源库恢复到 staging 目标库
  - 资产：同步/恢复 server 文件资产（`knowledge/ugc/gallery`）到 staging 的 `/app/.data`
  - 校验：关键表行数对比（可配置）、孤儿检测（安全查询）、资产抽样存在性与可读性（并强制路径前缀在 `/app/.data`）
  - Smoke：`curl -fsS http://127.0.0.1:<port>/api/v1/health` 断言 `status==ok`
- 实现目标/逻辑：
  - 入口脚本支持 `--help`/`--dry-run`，且对 DSN 做脱敏输出（隐藏 password），所有连接信息只通过环境变量注入（`SRC_DATABASE_URL/DST_DATABASE_URL`）。
  - DB restore 默认用 `--single-transaction`；并行 `--jobs` 仅在 directory 格式启用，避免与事务模式互斥造成隐式失败。
  - 校验脚本不引入新依赖：通过 `psql` 执行 SQL 并输出 TSV 报告。
- 核心变更：`deploy/prod/migration/README.md`、`deploy/prod/migration/dry_run.sh`、`deploy/prod/migration/validate_db.py`、`deploy/prod/migration/validate_assets.py`、`.sisyphus/notepads/para-completion/learnings.md`。
- 遗留/约束：已于 2026-02-17 在 `pscly.cc` 真实 staging 上执行并留存证据：`/root/dockers/para/backups/evidence/task-16/20260217182905/`；计划文件 Task 16 可勾选完成。

## [2026-02-17 18:10] - 任务：Task 16（远端 dry-run：旧环境 -> staging 导入演练 + 证据留存）
- 原始需求：在 `pscly.cc` 上跑一次“旧环境 -> staging”导入演练（DB + 文件资产），并完成一致性校验与 health smoke；证据留存在服务器目录且不得泄露任何明文口令/内网 IP/主机名。
- 实现目标/逻辑：
  - 证据目录固定在 `/root/dockers/para/backups/evidence/task-16/20260217175922/`（logs/outputs/src_artifacts/staging 分层）。
  - staging 必须隔离：独立 compose project + 独立数据目录 + 非生产端口（本次 API 为 `127.0.0.1:28086`，避免误指向 `18080`）。
  - 源库导出不走 DSN 回显：直接在旧环境的 Postgres 容器内执行 `pg_dump -Fc --serializable-deferrable --no-owner --no-acl`，并通过 SSH stream 写入新环境 evidence 目录。
  - 资产保持 `/app/.data` 语义：staging 将宿主机 `.data` bind-mount 到容器 `/app/.data`，避免 DB path 漂移导致校验失真。
- 核心变更（服务器侧，不入 git）：
  - `pscly.cc:/root/dockers/para/backups/evidence/task-16/20260217175922/`（完整日志、rowcount/orphan diff、assets 报告、health JSON）。
  - `pscly.cc:/root/dockers/para/app/deploy/prod/{migration,backup}/`（若远端缺失则从本地仓库完整复制，仅同步不改内容）。
- 结果摘要（证据见服务器目录）：
  - staging restore + `alembic upgrade head` + health smoke 全绿（health status=ok）。
  - rowcount 与 orphan checks：src/dst diff=0，orphan 全为 0；`vector` 扩展存在。
  - assets 抽样：该批数据 DB 中相关路径字段为空，因此抽样为 0；仍保留挂载约束与报告落盘。
  - 日志已做脱敏：无 `.env`、无 DSN 明文口令、无内网地址；并清理了意外的 shell 环境 dump 行。

## [2026-02-17 18:15] - 任务：Task 18（生产备份与回滚：PG dump + 资产快照 + 恢复演练）
- 原始需求：提供在 `pscly.cc` 可执行的备份脚本（PG dump + assets 快照）以及恢复演练脚本（隔离 staging，restore 后 health smoke），支持 `--help` 与 `--dry-run`，且严禁 secrets 入库/明文输出。
- 实现目标/逻辑：
  - PG dump：通过 `docker compose exec -T postgres ...` 在容器内执行（适配生产 PG 不 publish 5432）；dump 产物落在宿主机 `$BACKUP_ROOT/pg/<timestamp>/`。
  - Assets：直接读取宿主机 `/root/dockers/para/data/server/.data`（可 env 覆盖），生成 tar（或 rsync 镜像）到 `$BACKUP_ROOT/assets/<timestamp>/`。
  - Restore 演练：自动生成隔离的 staging compose（独立 project + 独立数据目录），restore DB + 解压 assets + `alembic upgrade head`，最后对 `http://127.0.0.1:<port>/api/v1/health` 断言 `status==ok`。
  - 安全：脚本输出不打印 `POSTGRES_PASSWORD` 或带 password 的 DSN；需要密码时仅在容器内部通过 `PGPASSWORD` 传递，不在日志中回显。
- 核心变更：
  - `deploy/prod/backup/README.md`
  - `deploy/prod/backup/backup_pg_dump.sh`
  - `deploy/prod/backup/backup_assets.sh`
  - `deploy/prod/backup/restore_to_staging.sh`
  - `deploy/prod/backup/systemd/para-backup.service`
  - `deploy/prod/backup/systemd/para-backup.timer`
  - `.sisyphus/plans/para-completion.md`
  - `.sisyphus/notepads/para-completion/learnings.md`
- 遗留/约束：已于 2026-02-17 在 `pscly.cc` 上实际跑一轮“真实备份 + restore 演练”并留存证据：`/root/dockers/para/backups/evidence/task-18/20260217181938/`；计划文件 Task 18 可勾选完成。

## [2026-02-17 18:14] - 任务：修复工具链脚本在 PG16 下的 pg_dump 参数（Task 16/18）
- 原始需求：`deploy/prod/backup/backup_pg_dump.sh` 与 `deploy/prod/migration/dry_run.sh` 使用了 `pg_dump --single-transaction`，但该参数在 `pg_dump` 中不存在，导致生产备份与迁移演练在 Postgres 16 下因 unknown option 失败。
- 实现目标/逻辑：仅移除 `pg_dump` 侧非法参数；保留 `pg_restore --single-transaction`（该参数存在）不变；并在脚本中加入极小注释说明一致性由 pg_dump 一致性快照机制保障。
- 核心变更：`deploy/prod/backup/backup_pg_dump.sh`、`deploy/prod/migration/dry_run.sh`、`deploy/prod/migration/README.md`、`.sisyphus/notepads/para-completion/learnings.md`。
- 验证：
  - `bash deploy/prod/backup/backup_pg_dump.sh --help` exit 0
  - `bash deploy/prod/migration/dry_run.sh --help` exit 0
  - `bash deploy/prod/migration/dry_run.sh --dry-run` exit 0

## [2026-02-17 18:45] - 任务：Task 16/18（真实演练证据补齐：计划勾选）
- 原始需求：在计划文件中推进 Task 16/18 勾选完成，并补齐“服务器侧真实执行证据目录 + 关键 smoke 结果”；同步更新 problems 记录与本会话证据状态（不写入任何 secrets/DSN/password）。
- 实现目标/逻辑：仅修改 `.sisyphus/plans/para-completion.md` 的 Task 16/18 区块（顶层/验收项/证据）以及对应 notepad/.ai_session 状态；证据路径仅引用服务器绝对路径。
- 核心变更：`.sisyphus/plans/para-completion.md`、`.sisyphus/notepads/para-completion/problems.md`、`.ai_session.md`。
- 证据：
  - Task16：`/root/dockers/para/backups/evidence/task-16/20260217182905/`（rowcount/orphan/assets sample/staging health JSON：均 OK）
  - Task18：`/root/dockers/para/backups/evidence/task-18/20260217181938/`（restore staging：`health_url=http://127.0.0.1:28080/api/v1/health` 断言 OK）

## [2026-02-17 15:05] - 任务：Task 20（邀请制注册：InviteCode 注册 UI + auth:register IPC + 离线 e2e）
- 原始需求：Renderer 提供“注册（邮箱/密码/邀请码）”表单并通过 `window.desktopApi.auth.register(...)` 注册；Main 新增 `auth:register` IPC 调用 `/api/v1/auth/register` 写入 tokens（与 login 同一安全存储路径），再调用 `/api/v1/auth/me` 返回 `{ user_id, email }`；新增稳定 testIds；e2e 用离线 stub 覆盖邀请码必填与一次性耗尽。
- 实现目标/逻辑：复用 `registerAuthIpcHandlers()` 的 payload 校验/错误码风格与 `writeAuthTokensToDisk()` 的 fail-closed 安全策略；注册失败时优先透传后端 `detail` 作为稳定错误 code，由 renderer 做中文映射。
- 核心变更：
  - `client/src/main/index.ts`（新增 `auth:register`，实现 `registerAndGetMe()` 并写入 tokens + /auth/me）
  - `client/src/preload/index.ts`（暴露 `desktopApi.auth.register`）
  - `client/src/renderer/vite-env.d.ts`（补齐 DesktopApi.auth.register 类型）
  - `client/src/renderer/app/testIds.ts`（新增 register 相关 testIds，不改旧 key）
  - `client/src/renderer/app/App.tsx`（新增注册表单 + 错误映射，成功后复用已登录展示）
  - `client/playwright/electron-register.spec.ts`（离线 stub：register/login/me + 邀请码一次性耗尽；证据截图）
- 验证（本机已通过）：
  - `npm -C client test`
  - `npm -C client run e2e -- electron-register.spec.ts`
- 证据：`.sisyphus/evidence/task-20-register-*.png`

## [2026-02-16 19:18] - 任务：Task 12（pgvector ANN 索引 + 向量检索走索引）
- 原始需求：为 `memory_embeddings.embedding` 与 `knowledge_chunks.embedding` 补齐 pgvector 向量索引（HNSW/IVFFLAT），并确保向量检索在生产数据量下能利用索引（保持 API contract 与语义）。
- 实现目标/逻辑：
  - 算子保持 `<->`（L2 distance）；索引 opclass 使用 `vector_l2_ops`（与算子匹配）。
  - `memory_embeddings` 增加冗余 `save_id`（回填 + NOT NULL），让按 `save_id` 过滤的 KNN 查询可在 embedding 表上直接执行；`memory_search` 改为“先 KNN candidates，再 join 取内容”。
  - `knowledge_query` 用 `EXISTS` 约束 material 状态（indexed），避免在 KNN 主表上做显式 join 影响 planner 选 ANN 索引的概率。
  - `memory_delete` 继续 soft delete `memory_items`，但同时物理删除 `memory_embeddings` 行，避免 deleted 条目进入向量检索候选集。
- 核心变更：
  - `server/alembic/versions/959e03e01f0b_task_12_pgvector_ann_indexes.py`
  - `server/app/db/models.py`
  - `server/app/api/v1/memory.py`
  - `server/app/api/v1/knowledge.py`
  - `server/tests/conftest.py`
  - `server/tests/test_task_12_pgvector_ann_indexes.py`
- 验证：`./scripts/ci.sh` 通过（包含 `cd server && uv run pytest`）。

## [2026-02-16 18:38] - 任务：修复 CI flaky（WS chat DONE 后 usage 行不可观测）
- 原始需求：GitHub Actions 上 `server/tests/test_task_4_2_llm_usage_metrics.py::test_task_4_2_ws_chat_persists_llm_usage_row_and_metrics_exposed` 偶发在 2s 内查不到 usage 行，导致 CI 失败；本地不复现。
- 实现目标/逻辑：将 `CHAT_DONE` 作为“完成同步点”对齐真实语义——当客户端收到 `CHAT_DONE` 时，`llm_usage_events` 需已落库可被查询（避免连接断开触发 cleanup 取消导致落库被打断）。
- 核心变更：`server/app/ws/v1.py` 调整顺序：先落库 usage 行（commit），再发送 `CHAT_DONE`。
- 遗留/约束：不改 workflow、不引入依赖；仍保持 metrics 记录与 event stream 落库行为；避免输出任何 secrets。
- 证据：
  - sha: 218655dedb442fe72932cc1ea6431823994bd1e8
  - ci run: 22059716191 (success) https://github.com/pscly/para/actions/runs/22059716191
  - deploy run: 22059761473 (success) https://github.com/pscly/para/actions/runs/22059761473
  - health: curl -fsS https://para.pscly.cc/api/v1/health -> status ok

## [2026-02-16 17:30] - 任务：Deploy（显式 key 文件 + ssh/scp 使用 -i，修复 publickey 失败）
- 原始需求：GitHub Actions runner 上 `scp/ssh` 偶发 `publickey` 认证失败；需要显式写入私钥文件并在 `ssh/scp` 使用 `-i`，同时启用 `BatchMode`，触发新一轮 CI->deploy 验证。
- 实现目标/逻辑：
  - workflow 内把 `${{ secrets.SSHKEY }}` 写到 `$RUNNER_TEMP/deploy_ssh_key`，`chmod 600`，并通过 `$GITHUB_ENV` 导出 `DEPLOY_KEY_FILE`。
  - 所有 `ssh/scp` 调用统一增加 `-i "$DEPLOY_KEY_FILE" -o BatchMode=yes -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes`，避免交互式提示并强制使用目标 identity。
- 核心变更：`.github/workflows/deploy.yml`
- 遗留/约束：严禁在日志中输出私钥内容；需要在 GitHub Actions 上实际跑通一次“CI -> deploy”链路确认修复生效。

## [2026-02-16 18:05] - 任务：Task 11（Embedding：admin-managed channel + routing + 可重算/可断点重嵌入）
- 原始需求：Embedding 从 env-only 切换为“admin-managed channel + routing”；Memory ingest/search 与 Knowledge 索引不再硬编码 local_embed；提供可重算/可断点的重嵌入任务（至少覆盖 memory_embeddings 与 knowledge_chunks）；保持离线可测与 CI 全绿。
- 实现目标/逻辑：
  - Provider：`provider=openai` 时优先读取 `AdminKV(namespace='llm_routing', key='global')` 的 `default_embedding_channel_id`，加载 `AdminLLMChannel(purpose='embedding', enabled)` 并解密 `api_key_enc`；若 routing 未配置或 channel 无 key 则回退 env（`OPENAI_BASE_URL/OPENAI_API_KEY`），两者都不可用则抛清晰错误；调用 `POST /v1/embeddings` 并继续按 `fold64-v1` 策略折叠到 `Vector(64)`。
  - 字段约束：`embedding_model` 仍保持 `String(50)`，过长 model 名会做确定性缩写（不拼 channel_id），避免超长。
  - Memory/Knowledge：Memory 的 ingest/search 与 knowledge query、索引任务统一走 embedding_provider，并在 worker 里传入 db 以启用 admin routing。
  - 重嵌入：新增 Celery tasks 支持 `start_after_*` + `limit` 分页断点，幂等更新 `memory_embeddings` 与 `knowledge_chunks` 的 `embedding_model/embedding_dim/embedding`。
  - 离线测试：pytest 内置 `ThreadingHTTPServer` stub `/v1/embeddings`，断言 Authorization header（通过请求成功计数）与 model 选择（channel.default_model）生效，同时覆盖重嵌入分页/断点。
- 核心变更：
  - `server/app/services/embedding_provider.py`
  - `server/app/api/v1/memory.py`
  - `server/app/api/v1/knowledge.py`
  - `server/app/workers/tasks/knowledge.py`
  - `server/app/workers/tasks/embeddings.py`
  - `server/app/workers/tasks/__init__.py`
  - `server/app/core/config.py`
  - `server/tests/test_task_11_embedding_routing_and_reembed.py`
- 验证：`./scripts/ci.sh` 通过（contracts check + server pytest + client vitest）。

## [2026-02-16 15:50] - 任务：Task 9（Admin LLM Channels：base_url 非法输入避免 500）
- 原始需求：`_normalize_openai_base_url()` 可能抛 ValueError；create/update/test 未捕获会导致 500，需要补齐异常路径并避免 contract 漂移。
- 实现目标/逻辑：保持 `_normalize_openai_base_url()` 私有；在调用处捕获 ValueError。
  - create/update：转换为 `HTTP 400`，detail 固定为 `base_url_invalid`。
  - test：不抛异常，返回 `ok=false` 且 detail=`base_url_invalid`（HTTP 200），同时仍写入审计。
- 核心变更：`server/app/api/v1/admin_llm.py`、`server/tests/test_task_9_admin_llm_channels.py`（新增 not-a-url 的 400 回归断言）。
- 遗留/约束：不改 contracts；不引入依赖。

## [2026-02-16 16:20] - 任务：Task 10（Admin Web：渠道/模型路由管理页面）
- 原始需求：在 `admin-web` 增加 `/admin` 下的 AI Channels 与 AI Routing 管理页面，对接后端 `/api/v1/admin/llm/channels` 与 `/api/v1/admin/llm/routing`；operator 只读（但允许 test 连接），super_admin 可写；API key 永不回显明文且编辑轮换需要二次确认。
- 实现目标/逻辑：
  - API：在 `admin-web/src/lib/api.ts` 追加 channels CRUD + `:test` 与 routing get/put 的类型与封装，错误提示仅使用 `ApiError.message`（脱敏），不在 console 输出 token/响应体。
  - UI：新增 `LlmChannelsPage`（列表/新建/编辑/启停/测试/删除）与 `LlmRoutingPage`（默认 chat/embedding channel 选择与保存），统一 loading/success/error alert；RBAC 下禁用写操作并提示 Requires super_admin。
  - Key 安全：列表仅展示 `api_key_present/api_key_masked`；新建/编辑 key 输入默认空；编辑时输入新 key 必须勾选“确认轮换 API Key”才允许保存。
  - 路由/导航：在 sidebar 增加 `/ai/channels` 与 `/ai/routing` 两个入口，并注册对应 routes children（兼容 `/` 与 `/admin` basename 运行时推导）。
- 核心变更：
  - `admin-web/src/lib/api.ts`
  - `admin-web/src/pages/LlmChannelsPage.tsx`
  - `admin-web/src/pages/LlmRoutingPage.tsx`
  - `admin-web/src/lib/routes.tsx`
- 遗留/约束：不引入新依赖；不修改后端 API；不写入任何真实 key/base_url；UI 仅使用现有 card/table/form/alert 视觉语言。

## [2026-02-16 14:57] - 任务：Task 8（自动部署：deploy release tarball 瘦身，避免 scp 超时）
- 原始需求：push main 后（CI 全绿）触发 deploy；release tarball 需要排除不必要的大目录（如 `.sisyphus/`、`node_modules/`、`.venv/`、`client/dist-electron/`、`.pytest_cache/`、`__pycache__/`），显著降低包体与传输时间。
- 实现目标/逻辑：仅改 `.github/workflows/deploy.yml` 的 `tar -czf ...` 命令，追加多条 `--exclude=`；不改触发条件/SSH 上传/远端部署逻辑。
- 关键细节：GNU tar 的 `--exclude=NAME`（不含 `/`）会按“路径组件”匹配，效果等价于排除任意深度的 `**/NAME/`。
- 核心变更：`.github/workflows/deploy.yml`（Build release tarball 步骤的 tar exclude 列表）。
- 遗留/约束：不引入新 workflow/脚本；不把任何凭据写入仓库。

## [2026-02-16 16:21] - 任务：Task 8（自动部署：CI 成功后部署同一 head_sha + 原子化目录切换 + smoke + 回滚）
- 原始需求：push main 后（CI 全绿）自动 SSH 部署到 `root@pscly.cc`；部署必须对应 CI 验证过的同一提交；远端部署尽量原子并具备失败回滚；部署后对 `https://para.pscly.cc/api/v1/health` 做 smoke。
- 实现目标/逻辑：
  - Deploy workflow：`workflow_run` 监听 `ci`，并额外要求 `event==push && head_branch==main && conclusion==success`；checkout/ref 以及 tarball/scp/远端参数均用 `head_sha`。
  - 远端脚本：目录切换 `app -> app_prev` + `app_new -> app`；先 `docker compose build` 再跑迁移（避免迁移使用旧镜像）；失败或收到 INT/TERM 时回滚到上一版目录，并重启 compose。
  - Smoke：远端与 Actions runner 均对 `/api/v1/health` 断言 `status==ok`，失败即让 workflow 失败。
- 核心变更：`.github/workflows/deploy.yml`、`deploy/prod/remote_deploy.sh`。
- 遗留/约束：仍需在 GitHub Actions 上实际跑一次“CI -> deploy”链路来形成线上绿灯证据；生产 `.env` 必须固定在 `/root/dockers/para/.env` 且不可写入仓库。

## [2026-02-16 13:00] - 任务：Task 5（Release：tag v0.x.y -> CI 门禁 -> Windows NSIS -> GitHub Release）
- 原始需求：新增 tag 发布工作流；push tag `v0.x.y` 时先跑权威 CI gate，绿灯后在 Windows 构建 NSIS 安装包并发布 GitHub Release（含 installer + SHA256）。
- 实现目标/逻辑：
  - 触发：`.github/workflows/release.yml` 监听 `on.push.tags: ["v0.*.*"]`。
  - 门禁复用：为 `.github/workflows/ci.yml` 增加 `workflow_call`，release 中通过 `jobs.ci.uses: ./.github/workflows/ci.yml` 复用 `./scripts/ci.sh`（不在 release job 内重复跑长测试）。
  - 版本一致性：Windows job 里执行 `python scripts/sync_versions.py --check`，确保 tag 与 `client/admin-web/server` 版本以及 OpenAPI 版本一致。
  - 构建与资产：`npm -C client ci` + `npm -C client run package:win` 产物落在 `client/dist-electron/**`；PowerShell 选择 installer `.exe`（优先匹配 `Setup` 且排除 `win-unpacked`），生成 `<exe>.sha256` 并随 installer 一起上传。
  - 发布：使用 `softprops/action-gh-release`（pin 到 commit SHA）通过 `GITHUB_TOKEN` 创建 Release 并上传资产。
- 核心变更：`.github/workflows/release.yml`（新增）、`.github/workflows/ci.yml`（增加 `workflow_call`）。
- 遗留/约束：不启用 in-app 自动更新；不要求代码签名；不引入任何 secrets/内网地址；不做部署/迁移。

## [2026-02-16 15:26] - 任务：Task 9（Admin：OpenAI 兼容渠道/Key/模型路由）
- 原始需求：Admin API 可 CRUD OpenAI 兼容渠道（base_url + api_key 加密存储）并提供离线可测的连通性测试；路由配置用 AdminKV 保存 JSON（不含 secrets）；关键动作写入 AuditLog；生成 OpenAPI/TS 合同；`./scripts/ci.sh` 全绿。
- 实现目标/逻辑：
  - Settings：新增 `ADMIN_SECRETS_MASTER_KEY`（base64url 32 bytes）解析为 bytes；非 prod 缺省时从 `ADMIN_ACCESS_TOKEN_SECRET` sha256 确定性派生；prod 缺省 fail-fast。
  - 加密：新增 admin secrets 工具，AES-GCM 加密明文 api_key，密文以 `v1:` 前缀 + base64url(nonce+ciphertext) 存储；响应永不回显明文，仅返回 `api_key_present/api_key_masked`。
  - DB：新增 `admin_llm_channels` 表（name 唯一、purpose chat|embedding、enabled/default_model/timeout_ms/weight 等最小字段，`api_key_enc` 可空）。
  - API：新增 `/api/v1/admin/llm`：channels CRUD、`POST :test` 调 `GET /v1/models` 返回 `{ok, latency_ms, detail}`；routing `GET/PUT` 读写 `AdminKV(namespace='llm_routing', key='global')`。
  - 审计：create/update/delete/test/routing.update 写入 `AuditLog(actor='admin:{admin.id}', action=..., target_type/target_id/metadata_json)`；metadata 禁止包含明文 key。
  - 离线测试：pytest 内启动本地 `ThreadingHTTPServer` stub `/v1/models`，验证 connectivity test 不依赖外网且 Authorization header 正确。
- 核心变更：
  - `server/app/core/config.py`（master key 解析 + prod 校验 + dev 派生）
  - `server/app/core/admin_secrets.py`（AES-GCM v1 加解密 + masked）
  - `server/app/db/models.py`（`AdminLLMChannel`）
  - `server/alembic/versions/4b8d1a2c3e4f_admin_llm_channels.py`（迁移创建表）
  - `server/app/api/v1/admin_llm.py`、`server/app/api/v1/router.py`（新 router + 挂载）
  - `server/tests/test_task_9_admin_llm_channels.py`（CRUD/RBAC/审计/连通性 stub）
  - `contracts/openapi.json`、`client/src/gen/openapi.ts`（合同生成物）
- 遗留/约束：禁止把真实 key/base_url 写入仓库；测试 key 禁止匹配 `sk-`；任何日志/错误信息不得输出明文 api_key。

## [2026-02-16 15:35] - 任务：Task 9（补记：prod guard 对历史测试的影响）
- 现象：新增 `ADMIN_SECRETS_MASTER_KEY` 生产必填后，`server/tests/test_task_1_4_prod_config.py` 的“prod 配置成功”用例会因为缺失 master key fail-fast 而失败。
- 处理：在这些用例里显式 `setenv("ADMIN_SECRETS_MASTER_KEY", <固定 base64url 32 bytes>)`，并在 `_clear_env()` 中清理该变量，避免错误信息污染原断言语义。

## [2026-02-16 14:16] - 任务：Task 6（生产 Docker Compose：server/worker/beat/admin-web 编排 + 持久化目录）
- 原始需求：补齐生产 `deploy/prod/docker-compose.yml`，可在 `pscly.cc` 的 `~/dockers/para/` 下运行；持久化卷落在 `~/dockers/para/data/`；可被既有外层 Nginx 反代；禁止写入真实 secrets。
- 实现目标/逻辑：
  - 服务拓扑：`postgres(pgvector/pg16)` + `redis` + `api(uvicorn 多 workers)` + `celery worker` + `admin-web(nginx 静态 dist)`；`celery beat` 作为可选 profile。
  - 端口约束：API/admin-web 仅绑定 `127.0.0.1`（默认 `18080/18081`），由外层 Nginx 反代；本 compose 不引入任何 reverse proxy。
  - 持久化：server 资产写盘路径在代码中硬编码为 `server_root/.data/<module>`（knowledge/ugc/gallery）。容器内固定 `WORKDIR=/app`，因此将宿主机 `/root/dockers/para/data/server/.data` 挂载到容器内 `/app/.data`，保持 DB 中绝对路径稳定。
  - 迁移策略：提供 `migrate` service（profile=migrate）用于手动 `alembic upgrade head`，避免 `up` 时隐式跑 DDL。
- 核心变更：`deploy/prod/docker-compose.yml`、`server/Dockerfile`、`admin-web/Dockerfile`、`admin-web/nginx.default.conf`、`deploy/prod/README.md`。
- 遗留/约束：生产必须显式注入 `AUTH_ACCESS_TOKEN_SECRET/ADMIN_ACCESS_TOKEN_SECRET/OPENAI_*` 等环境变量；`ENV=prod|production` 下缺失会 fail-fast（预期行为）。

## [2026-02-16 12:55] - 任务：Task 4（版本一致性：tag v0.x.y 驱动多端版本对齐）
- 原始需求：统一版本来源（优先用 tag `v0.x.y`），并同步到 `client/package.json`、`admin-web/package.json`、`server/pyproject.toml` 与 OpenAPI `info.version`。
- 实现目标/逻辑：
  - 将 server/client/admin-web 版本全部对齐到 `0.1.0`（与现有 `contracts/openapi.json` 保持一致）。
  - 新增 `scripts/sync_versions.py`：
    - 默认从 tag 环境变量（如 `GITHUB_REF_NAME`/`GITHUB_REF`）解析 `v0.x.y`；无 tag 时回退到本地 `contracts/openapi.json` 或 `server/pyproject.toml`。
    - `--write` 同步写入三个版本文件；可选 `--export-openapi` 通过 `PARA_VERSION` 注入导出一致的 `contracts/openapi.json`。
- 核心变更：`scripts/sync_versions.py`、`client/package.json`、`admin-web/package.json`、`server/pyproject.toml`。
- 验收：`./scripts/ci.sh` 全绿；OpenAPI `info.version` 与三端版本一致。

## [2026-02-16 12:59] - 任务：Task 4（版本一致性：tag v0.x.y 驱动版本对齐）
- 原始需求：tag `v0.x.y` 驱动 `server/client/admin-web` 版本与 `contracts/openapi.json` 的 `info.version` 对齐，并保持 `./scripts/generate-contracts.sh --check` 与 `./scripts/ci.sh` 的验收口径稳定。
- 实现目标/逻辑：
  - 服务端 OpenAPI version 显式对齐 SemVer：`FastAPI(..., version=get_app_version())`；`PARA_VERSION` 环境变量优先，其次读取 `server/pyproject.toml`，再兜底已安装分发包 metadata。
  - 新增 `scripts/sync_versions.py`：解析版本（tag env 优先，否则 `contracts/openapi.json`，再兜底 `server/pyproject.toml`）并提供 `--check/--write/--export-openapi`。
  - `scripts/generate-contracts.sh` 在 tag 环境下自动导出 `PARA_VERSION`（剥离 `v` 前缀），让 OpenAPI 导出可被 tag 驱动。
- 核心变更：`server/app/core/version.py`、`server/app/main.py`、`scripts/sync_versions.py`、`scripts/generate-contracts.sh`、`server/pyproject.toml`、`client/package.json`、`admin-web/package.json`。
- 验证：`./scripts/generate-contracts.sh --check` 通过；`python scripts/sync_versions.py --check` 通过；改动文件 LSP 诊断为 clean。
- 遗留/约束：未将版本一致性强门禁并入 `scripts/ci.sh`（避免改变既有门禁语义）；tag 发布时建议先执行 `python scripts/sync_versions.py --write`（必要时追加 `--export-openapi`）再进行打包/生成合同。

## [2026-02-16 12:42] - 任务：Task 3（CI 占位符/泄露/假模式扫描 + 生产 fake/local 禁用）
- 原始需求：把 `example(dot)invalid`、疑似 `sk-` key、内网 IP（如 `192(dot)168(dot)`）等占位/泄露作为发布阻断；并确保生产环境禁止 `OPENAI_MODE=fake` 与 `KNOWLEDGE_EMBEDDING_PROVIDER=local` 静默启动。
- 实现目标/逻辑：
  - 新增 `scripts/scan_blockers.sh`：基于 `git ls-files --cached --others --exclude-standard` 扫描文本文件；对疑似 key 做脱敏输出；命中则 exit 1。
  - `scripts/ci.sh` 将扫描作为第一步门禁（本地与 CI 共用同一口径）。
  - 清理客户端更新源占位：`client/package.json` 的 electron-builder `build.publish` 置空（明确关闭 in-app 自动更新渠道）。
  - 服务端生产校验补强：`server/app/core/config.py` 在 `ENV=prod|production` 下禁止 `OPENAI_MODE=fake` 与 `KNOWLEDGE_EMBEDDING_PROVIDER=local`。
- 核心变更：`scripts/scan_blockers.sh`、`scripts/ci.sh`、`client/package.json`、`server/app/core/config.py`。
- 验收：`make dev-up && ./scripts/ci.sh` 全绿；`./scripts/scan_blockers.sh` 输出 OK。

## [2026-02-16 12:07] - 任务：修复门禁脚本 scripts/ci.sh 误报 ALL GREEN
- 原始需求：修复门禁脚本 `scripts/ci.sh`：当任一步失败时必须整体退出非 0（不得打印 ALL GREEN 并返回 0）。
- 根因：脚本为保留 `tee` 证据输出与 `PIPESTATUS` 捕获逻辑，在运行主流程 `run_all` 前做了 `set +e`，导致 `run_step` 的失败只会 `return 1` 而不会触发整体 fail-fast；`run_all` 继续执行并最终打印 `ALL GREEN`，从而误导 CI 放行。
- 修复：在 `run_all()` 内对每个 `run_step ...` 增加 `|| return 1`，让任一步失败都能立刻终止主流程；仅当三步都成功时才会输出 `ALL GREEN` 并最终 exit 0。
- 影响：当依赖不可达（例如 127.0.0.1:5432 连接拒绝导致 `uv run pytest` 失败）时，`./scripts/ci.sh` 将正确返回非 0，避免门禁误放行。

## [2026-02-16 12:41] - 任务：Task 3（CI：增加“占位符/泄露/假模式”扫描并作为发布阻断）
- 原始需求：CI/本地门禁增加确定性扫描：禁止占位域名、疑似 OpenAI key 泄露、私网 IP；并在生产环境禁用 `OPENAI_MODE=fake` 与 `KNOWLEDGE_EMBEDDING_PROVIDER=local`（fail-fast），且补齐 pytest 防回归。
- 实现目标/逻辑：
  - 仍以 `./scripts/ci.sh` 为唯一权威 gate；新增扫描步骤作为第一个 step，命中即快速失败。
  - 扫描输入来自 `git ls-files --cached --others --exclude-standard`：覆盖“已跟踪 + 未忽略的未跟踪”文件，避免误扫 `.gitignore` 下的生成缓存/产物。
  - key 扫描命中时只输出脱敏 token（防止把明文 key 再写进 evidence/日志）。
  - 生产 guard 放在 `server/app/core/config.py` 的 `_validate_prod_config`：Settings 加载阶段直接报错退出。
- 核心变更：
  - `scripts/scan_blockers.sh`：新增占位符/泄露扫描脚本。
  - `scripts/ci.sh`：新增 `run_step` 调用扫描脚本（fail-fast）。
  - `client/package.json`：移除/清空 electron-builder `build.publish` 占位更新 URL（不做 in-app auto-update）。
  - `server/app/core/config.py`：prod 禁止 `OPENAI_MODE=fake` 与 `KNOWLEDGE_EMBEDDING_PROVIDER=local`。
  - `server/tests/test_task_1_4_prod_config.py`：新增/调整用例覆盖 prod guard。
- 验证：
  - `./scripts/ci.sh` 在干净 tree + 已启动 Postgres/Redis 时 exit 0。
  - 创建临时文件写入占位域名可触发 `./scripts/ci.sh` 在扫描步骤 exit 1；删除后恢复全绿。

## [2026-02-16 12:01] - 任务：Task 2（CI：接入 scripts/ci.sh 到 GitHub Actions，强门禁）
- 原始需求：在 GitHub Actions 新增强门禁 CI：在 `pull_request` 与 `push(main)` 上运行 Ubuntu runner，拉起 Postgres(pgvector)+Redis，并执行权威脚本 `./scripts/ci.sh`。
- 实现目标/逻辑：
  - 新增独立 workflow `ci.yml`（不改既有 linux/macos/windows 打包工作流），只负责“门禁验收”。
  - Runner 侧准备 Node 20（client `npm -C client ci` + vitest）、Python 3.12 + uv（server `uv run pytest` + OpenAPI 导出）。
  - 依赖服务复用根目录 `docker-compose.yml` + `.env.example`，只启动 `postgres/redis`，并基于 compose healthcheck 等待 `healthy` 后再运行门禁脚本。
  - 运行 `./scripts/ci.sh` 时显式注入 `DATABASE_URL/CELERY_BROKER_URL/WS_REDIS_URL`（全部指向 `127.0.0.1`），避免 runner 环境变量差异导致漂移。
- 核心变更：
  - `.github/workflows/ci.yml`：新增（push main + PR，最小权限 `contents: read`，安装依赖/拉起服务/执行 `./scripts/ci.sh`）。
- 遗留/约束：workflow 不包含任何真实密钥/内网地址；服务端依赖必须在容器/本机本地回环地址可达。

## [2026-02-16 11:46] - 任务：Para 完工计划 Task 1（本地 Runbook 与环境基线）
- 原始需求：finish Para project；勾选计划 1：建立“可重复跑通”的本地 Runbook 与环境基线。
- 计划路径：`.sisyphus/plans/para-completion.md`
- 当前会话：`ses_39bc0590effeMH2Kf94Wt7Wg3e`
- 实现目标/逻辑：
  - 在 `docs/` 下新增最小但完整的 runbook，提供本地开发与生产运维的“可复制粘贴”命令序列。
  - 明确健康检查与 smoke checklist：`docker compose ps` + `curl /api/v1/health`（可延后执行）。
  - 将 `./scripts/ci.sh`、`./scripts/qa_alpha.sh`、`./scripts/qa_beta.sh` 作为权威 QA 入口写入 runbook，避免团队自创流程导致验收漂移。
- 关键决策（继承/确认）：
  - Windows-only NSIS
  - tag release
  - push-main deploy
  - pgvector
  - admin-managed channels
- 核心变更：
  - `docs/runbook.md`：新增（本地 dev + 生产 ops baseline + secrets 处理约束）。
- 遗留/约束：本文档与 runbook 均不包含任何 API keys/密码/内网 IP；生产 `.env` 仅服务器侧维护。

## [2026-02-16 02:15] - 任务：Wave8.2 Linux：分发策略（AppImage/deb/rpm）
- 原始需求：补齐 Beta hardening 计划 Future 8.2：在 Linux 上明确分发策略，并落地可在 Ubuntu runner 运行的 CI 打包链路（AppImage/deb/rpm），同时保持最小增量、不影响现有 Windows/macOS workflow。
- 实现目标/逻辑：
  - 使用现有 `electron-builder` 配置，扩展 `build.linux.target` 到 `dir + AppImage + deb + rpm`，让 Linux runner 可一次性产出多种分发包。
  - 在 `client/package.json` 增加 `package:linux:dist` 脚本（`electron-builder --linux`），用于 CI/本地统一入口。
  - 新增独立 GitHub Actions workflow（仅 Ubuntu runner 内通过 `apt-get` 安装 rpm/FUSE 相关依赖），并上传 `client/dist-electron/**` 作为 artifacts。
  - 文档化三类包的取舍、依赖与产物目录；Linux 自动更新策略保持现状（默认仍可保持关闭）。
- 核心变更：
  - `client/package.json`：Linux targets 增加 `AppImage/deb/rpm`；新增 `package:linux:dist`。
  - `.github/workflows/linux-build.yml`：Ubuntu 打包链路（含 rpm/libfuse2 依赖）。
  - `docs/linux-distribution.md`：Linux 分发策略与构建说明。
- 验收（本机/CI）：
  - 本地：`npm -C client run lint`、`npm -C client test`、`./scripts/ci.sh`
  - Linux 打包（Ubuntu）：`npm -C client ci && npm -C client run package:linux:dist`

## [2026-02-16 01:35] - 任务：Success Criteria 292 插件沙箱落地（B 路线 / QuickJS WASM）
- 原始需求：插件执行不再使用 `node:vm` 作为安全边界；在 fork 的插件子进程内落地真正沙箱（B 路线），具备：不可访问 Node API、可中断超时、资源/内存上限；同时保持 permissions/sha256/限额/kill-switch 行为不回归，并补充离线 e2e 与证据。
- 实现目标/逻辑：
  - 继续保留 `child_process.fork` 隔离（插件在独立子进程执行），但子进程内改用 QuickJS(WASM) 执行第三方插件 code。
  - 超时/中断：使用 QuickJS runtime 的 interrupt handler（`shouldInterruptAfterDeadline`）实现 init eval 与 menu click 两处可中断超时；不依赖外层 setTimeout“等结果”。
  - 资源上限：在 QuickJS runtime 上设置 `setMemoryLimit(64MiB)` 与 `setMaxStackSize(512KiB)`，避免恶意/异常插件导致宿主进程资源失控。
  - Node API 隔离：不向 QuickJS context 注入 `process/require/fs/child_process` 等任何 Node 能力，仅注入既有插件 API：`say/suggestion/addMenuItem/onMenuClick`（以及无副作用 console stub）。
- 核心变更：
  - `client/src/main/plugin_host.ts`：移除 `node:vm`，用 QuickJS(WASM) runtime 执行 code；menu click 走 handle 调用；补齐 pending jobs 驱动与 shutdown 清理。
  - `client/playwright/electron-plugin.spec.ts`：增强断言，验证 `process/require` 不可用且 `require('fs')` 失败可控（bubble 文本包含 `process=undefined require=undefined requireFs=no`）。
  - 证据：`.sisyphus/evidence/task-plugins-sandbox.txt`
- 验收（本机已通过）：
  - `npm -C client run lint`
  - `npm -C client test`
  - `npm -C client run e2e -- electron-plugin.spec.ts`
  - `npm -C client run e2e -- electron-update-rollback.spec.ts`
  - `./scripts/ci.sh`

## [2026-02-15] - 任务：Wave5.1 admin-web 完成
- 状态：5.1 已完成（计划已勾选）。
- 原始需求：完成计划 Wave5.1：新建 `admin-web/`（Vite + React + TS），包含登录、Dashboard、Feature Flags、Models/Prompts、Audit Logs、UGC Review、Plugins Review；并具备 Playwright web e2e 验收（登录->改 flags->客户端生效）。
- 实现目标/逻辑：
  - Admin 侧：以独立站点承载后台能力，按路由拆分页面，尽量保持无状态（token/session 仅用于调用后端，避免在 UI/console 泄漏敏感信息）。
  - E2E：覆盖“登录->切换 feature flags->验证客户端行为变化”的闭环；交互上优先点击 `label.switch`（隐藏 checkbox 直接 `.check()` 容易不稳定）。
  - 离线稳定性：e2e 用 stub 后端响应关键接口（登录/会话/feature_flags 等），保证在 CI/本机无外网环境下稳定可重复。
- 验收（本机已通过）：`./scripts/ci.sh`、`npm -C admin-web run build`、`npm -C client run e2e -- web-admin-feature-flags.spec.ts`。
- 遗留/约束：Wave5.2/5.3 仍待完成（review 队列列表/批量操作与部署安全头/CORS 等不在 5.1 范围内）。

## [2026-02-15 20:10] - 任务：admin-web 审核页：UGC/插件“手动审核”（approve/reject）
- 原始需求：在 `admin-web/` 实现 UGC 审核页与插件审核页的“手动审核”能力：输入目标 id 后调用后端 approve/reject 端点并展示返回结果；operator 调用需友好提示 403（Requires super_admin）；校验空输入；错误提示脱敏；同时明确“审核队列列表”会在 5.2 补齐；不改 server。
- 实现目标/逻辑：
  - 端点对齐：UGC 使用 `POST /api/v1/admin/review/ugc/{asset_id}:approve|:reject`；插件使用 `POST /api/v1/admin/review/plugins/{plugin_id}/{version}:approve|:reject`；响应分别为 `{ asset_id, status }` 与 `{ id, version, status }`。
  - API：在 `admin-web/src/lib/api.ts` 新增 `adminReviewUgcApprove/adminReviewUgcReject` 与 `adminReviewPluginApprove/adminReviewPluginReject`，复用 `apiRequestJson()` + `ApiError` 的脱敏 detail 映射；并在 API 层做非空参数 guard。
  - UI：`UgcReviewPage/PluginsReviewPage` 从占位升级为可用表单页：输入校验（空字符串禁止提交）、RBAC UX（非 super_admin 显示 Requires super_admin 提示并禁用提交）、成功后展示 action human text + 返回 JSON（不在 console 打印 token/响应体）。
  - 版本提示：页面明确标注“审核队列列表会在 5.2 补齐”，且不实现待审列表/批量审核。
- 核心变更：
  - `admin-web/src/lib/api.ts`
  - `admin-web/src/pages/UgcReviewPage.tsx`
  - `admin-web/src/pages/PluginsReviewPage.tsx`
  - `admin-web/src/styles.css`
- 遗留/约束：不改 server；不实现队列列表/批量审核（留给 5.2）；错误信息仅展示 `ApiError.message`（脱敏）。

## [2026-02-15 19:45] - 任务：Wave5.2 Admin Review 队列补齐（pending 列表/详情/备注/审计）
- 原始需求：补齐 admin review 队列能力：UGC/插件 pending 列表（limit/offset + `{ items, next_offset }`）、详情（含 manifest raw + parsed）、备注写入、审核动作 approve/reject 落 review 字段并写审计；admin-web 两个审核页从“手动输入 id”升级为“队列浏览+详情+备注+approve/reject”；operator 只读，super_admin 可操作。
- 实现目标/逻辑：
  - 后端：在 `server/app/api/v1/admin_review.py` 新增 queue/list/detail/note 端点；列表采用稳定排序 `created_at asc, id asc`（offset/limit，limit+1 判定 next_offset）。详情同时返回 `manifest_json` 与 `manifest`（解析失败为 null）。
  - 备注（note）约束：`strip()` 后空串视为 null；最大长度 2000；审计 metadata 不存全量 note，仅存 `{len,sha256,preview}` 摘要；业务表落 `review_note`。
  - 审核动作：`approve/reject` 继续 `require_super_admin`；写 `AuditLog`（actor=`admin:{admin.id}`，metadata 含 from/to；若本次请求显式提供 note 则 metadata 追加 note 摘要）；同时更新 `reviewed_at/reviewed_by/review_note`（note 仅在显式提供时覆盖）。
  - RBAC：队列 list/detail 允许 `operator` 与 `super_admin`（Depends `get_current_admin_user`）；写入动作（approve/reject/note）仅 `super_admin`。
  - 前端：admin-web 的 `UgcReviewPage/PluginsReviewPage` 改为左侧队列（分页）+ 右侧详情（manifest/code/审核字段）+ 备注编辑 + approve/reject；operator 只读并提示 Requires super_admin。
- 核心变更：
  - DB：`server/app/db/models.py`（review 字段）；迁移：`server/alembic/versions/9c1f0b2a3d4e_review_fields_for_ugc_and_plugins.py`
  - API：`server/app/api/v1/admin_review.py`（新增队列端点 + 审计/落字段）
  - Tests：`server/tests/test_task_5_2_admin_review_queue.py`；同时 `server/tests/conftest.py` 增加 pytest 初始化 schema 修补（避免历史 create_all 测试库缺列导致 UndefinedColumn）
  - Web：`admin-web/src/lib/api.ts`、`admin-web/src/pages/UgcReviewPage.tsx`、`admin-web/src/pages/PluginsReviewPage.tsx`
  - 合同：`contracts/openapi.json`、`client/src/gen/openapi.ts`（由 `./scripts/generate-contracts.sh` 同步）
- 验证：`./scripts/ci.sh` 全绿；`npm -C admin-web run build` 通过。

## [2026-02-15 18:10] - 任务：admin-web Models/Prompts 配置页面真实读写（安全 JSON 编辑器 + RBAC）
- 原始需求：在 `admin-web/` 实现 Models/Prompts 两个配置页面的真实读写：对接后端 `GET/PUT /api/v1/admin/config/models` 与 `GET/PUT /api/v1/admin/config/prompts`，提供一个安全的 JSON 编辑器（textarea + 校验 + diff/dirty + save/reset），并正确处理 RBAC（operator 只读，super_admin 可保存）。
- 实现目标/逻辑：
  - API：在 `admin-web/src/lib/api.ts` 新增 `adminConfigGetModels/adminConfigPutModels` 与 `adminConfigGetPrompts/adminConfigPutPrompts`，路径保持 snake_case，不做 schema 限制，payload/响应均为任意 JSON object 透传。
  - UI：抽取 `admin-web/src/components/JsonEditorCard.tsx` 作为可复用 JSON 编辑器卡片：GET 后 2 空格缩进 pretty-print 到 textarea；输入实时 `JSON.parse` 校验（无效时提示“JSON 语法错误”并禁止保存）；dirty 通过与 last loaded 文本对比；支持 reset 回滚与 diff（details 下展示远端/本地内容）。
  - RBAC：页面通过 `loadAdminSession().role` 判断 `canEdit`（仅 `super_admin` 可保存）；`operator` 使用只读 textarea（可滚动/复制但不可修改），并提示 Requires super_admin；若 PUT 实际返回 403，则由 `ApiError` 的脱敏 detail 显示原因。
- 核心变更：
  - `admin-web/src/lib/api.ts`
  - `admin-web/src/components/JsonEditorCard.tsx`
  - `admin-web/src/pages/ModelsPage.tsx`
  - `admin-web/src/pages/PromptsPage.tsx`
  - `admin-web/src/styles.css`
- 遗留/约束：不改动 server；不引入 Monaco 等大型编辑器；不做版本管理；错误信息仅展示脱敏后的 `ApiError.message`，不输出 token。

## [2026-02-15 19:10] - 任务：admin-web 审计日志页面接入真实读写（过滤/分页/metadata 折叠）
- 原始需求：在 `admin-web/` 实现“审计日志”页面的真实读写：调用 `GET /api/v1/admin/config/audit_logs`，支持 actor/action/target_type/target_id 基础过滤 + limit/offset 分页（优先使用响应的 `next_offset`），表格展示核心列，并将 metadata 以可折叠 JSON 展示；401/403/网络错误需清晰提示；禁止把 token 或完整响应体打印到 console；错误处理使用 `ApiError`；不引入大型 table 组件库；不改动 server。
- 实现目标/逻辑：
  - API 封装：在 `admin-web/src/lib/api.ts` 增加 `adminAuditLogsList(params)`，用 `URLSearchParams` 对齐后端 query 参数（`actor/action/target_type/target_id/since/until/limit/offset`），并通过 `apiRequestJson()` 自动携带 sessionStorage 中的 admin token；返回结构规范化为 `{ items, next_offset }`（缺省兜底为 `[]/null`）。
  - UI：`admin-web/src/pages/AuditLogsPage.tsx` 默认拉取 `limit=50, offset=0` 最近日志；提供过滤输入与“查询/清空”；分页按钮“上一页/下一页”优先使用后端 `next_offset`；错误信息只展示脱敏后的 `ApiError.message`。
  - metadata：表格列固定包含 `created_at/actor/action/target_type/target_id`，metadata 通过 `<details>` 折叠，展开后用 `<pre>` 格式化 JSON 并限制最大高度，避免占满页面。
- 核心变更：
  - `admin-web/src/lib/api.ts`
  - `admin-web/src/pages/AuditLogsPage.tsx`
  - `admin-web/src/styles.css`
- 遗留/约束：不做 server 改动；不在 UI/console 输出 token；后端仍以 offset 分页为主，前端仅“优先”消费 `next_offset`。

## [2026-02-15 18:30] - 任务：4.5 Knowledge：embedding 升级为真实 embedding（OpenAI 兼容）+ reindex/delete 闭环
- 原始需求：Knowledge 默认使用本地 embedding(64) 离线可跑；当显式开启 OpenAI embeddings 时调用 OpenAI-compatible `/v1/embeddings`，并将高维向量确定性折叠到 `Vector(64)`；新增 material 的 delete/reindex 端点与闭环测试/证据。
- 实现目标/逻辑：
  - Provider：新增 `embed_text()` 统一封装 local/openai embeddings；OpenAI client 采用同步 `httpx.Client(trust_env=False)` + 明确 timeout。
  - 维度：DB schema 固定 `Vector(64)`，OpenAI embedding 结果通过 folding(按 index%64 累加) + L2 normalize 生成 64 维，并把策略版本编码进 `embedding_model=openai:<model>:fold64-v1`。
  - Query/Index：knowledge query 与 celery 索引任务统一走 provider，写入 `KnowledgeChunk.embedding_model/embedding_dim/embedding`。
  - Delete：新增 `DELETE /api/v1/knowledge/materials/{material_id}`，删除 DB material（级联 chunks）并在磁盘侧只清理 `server/.data/knowledge/<material_id>/`（目录边界校验，避免信任 storage_path）。
  - Reindex：新增 `POST /api/v1/knowledge/materials/{material_id}/reindex`，触发重新索引并最终回到 indexed。
- 核心变更：
  - `server/app/services/embedding_provider.py`
  - `server/app/core/config.py`
  - `server/app/api/v1/knowledge.py`
  - `server/app/workers/tasks/knowledge.py`
  - `server/tests/test_task_13_knowledge_query.py`（新增 task-45 闭环测试与证据输出）
  - `.sisyphus/evidence/task-45-knowledge-delete.json`
  - `contracts/openapi.json`、`client/src/gen/openapi.ts`

## [2026-02-15 17:20] - 任务：4.4 Timeline：keyset pagination + event_type 过滤
- 原始需求：`GET /api/v1/timeline` 从 offset cursor 切换为 keyset pagination（稳定排序 `created_at desc, id desc`），`cursor` 仍是 string 且兼容 `cursor=0` 起始；新增 `event_type` 可选过滤；响应仍为 `{ items, next_cursor }`，其中 `next_cursor` 为版本化不透明游标，无更多数据时返回空串；无效游标返回 400。
- 实现目标/逻辑：
  - 游标：采用 `k1_` 前缀 + base64url(JSON) 编码，payload 固定为 `{ created_at, id }`；解码时严格校验 shape 与 `created_at` 可解析，否则 400。
  - 起始：`cursor` 缺省/空串/`"0"` 视为第一页（兼容旧客户端默认 `cursor='0'`）。
  - Keyset 条件：当 cursor 存在时追加 `created_at < cursor_created_at OR (created_at == cursor_created_at AND id < cursor_id)`；并按 `created_at desc, id desc` 排序。
  - 翻页判定：查询使用 `limit+1` 取回，多取到 1 条则认为有下一页，并用“当前页最后一条”生成 `next_cursor`；否则 `next_cursor=''`。
  - 过滤：新增 query param `event_type`（非空时等值过滤），在 keyset/排序之前应用。
- 核心变更：
  - `server/app/api/v1/timeline.py`：移除 offset 分页；新增 keyset cursor 编解码与 `event_type` 过滤。
  - `server/tests/test_task_18_timeline.py`：新增多页翻页（无重复/无遗漏/顺序稳定）与 `event_type` 过滤翻页用例；补充无效 cursor 400。
  - `contracts/openapi.json`、`client/src/gen/openapi.ts`：通过 `./scripts/generate-contracts.sh` 更新生成物。

## [2026-02-15 15:45] - 任务：4.3 Gallery list 去 base64 + 下载端点 + 任务状态机
- 原始需求：`GET /api/v1/gallery/items` 不再回传 `thumb_data_url/image_data_url`；新增下载端点按需下载 `thumb.png/image.png`（鉴权+校验 save 归属+防路径穿越）；支持取消把 item 标记为 `canceled`；worker 状态机至少 `pending->running->completed|failed` 并尊重 canceled；客户端用二进制 + Blob URL 展示；离线 E2E stub 同步更新；OpenAPI/TS 生成物通过 `./scripts/generate-contracts.sh` 同步。
- 实现目标/逻辑：
  - 列表接口只返回元数据（id/status/created_at/prompt），图片内容通过下载端点单独获取，避免 base64 放大 payload。
  - 下载端点只允许固定 kind=thumb|image 映射到固定文件名，并校验 `storage_dir` 必须位于 server gallery 根目录之下。
  - 取消端点将 `pending|running` 置为 `canceled` 并写入 completed_at；worker 在开始/写盘前后刷新状态并提前退出。
  - Electron：主进程携带 Authorization 拉取 bytes（不把 token 拼进 URL），renderer 用 Blob URL 渲染并在条目移除/卸载时 revoke。
- 核心变更：
  - `server/app/api/v1/gallery.py`：移除 data_url 字段；新增 download/cancel 端点。
  - `server/app/workers/tasks/gallery.py`：增加 running 状态与 canceled 早退。
  - `client/src/main/index.ts`/`client/src/preload/index.ts`/`client/src/renderer/app/App.tsx`：新增 `gallery:download` IPC + Blob URL 展示；poll 逻辑 pending/running 均触发。
  - `server/tests/test_task_17_gallery.py`、`client/playwright/electron-gallery.spec.ts`：更新断言与 stub。
- `contracts/openapi.json`、`client/src/gen/openapi.ts`：通过 `./scripts/generate-contracts.sh` 同步。

## [2026-02-15 16:40] - 任务：修复 Gallery E2E（completed 但不渲染 img）
- 现象：E2E 中 pill 已到 `已完成`，且 `desktopApi.gallery.download` 返回 bytes>0，但 `<img.gallery-img>` count 仍为 0。
- 根因：renderer 的下载 useEffect 会在 `galleryItems` 轮询更新时触发 cleanup 取消，导致已下载到的 blob URL 被提前丢弃/回收；同时 revoke 逻辑对所有 URL 一刀切，未来引入 data URL fallback 会有误清理风险。
- 修复：
  - 图片 URL 生成：优先 Blob URL，若创建失败则在 renderer 内部 fallback 为 `data:image/png;base64,...`（仅用于展示，不影响后端 list contract）。
  - 清理：仅对 `blob:` URL 调用 `URL.revokeObjectURL`，data URL 不 revoke。
  - effect：下载 effect 只依赖 `galleryItems`，用 ref 判断“是否已缓存 URL”，不再用 cleanup cancel 中止并回收 fresh URL。
- 验证：`npm -C client run e2e -- electron-gallery.spec.ts` 通过，证据输出 `.sisyphus/evidence/task-17-gallery.png`。

## [2026-02-15 14:50] - 任务：4.1 真 LLM streaming（WS v1 可切换 provider）
- 原始需求：WS `/ws/v1` 的 `CHAT_SEND` 不再固定依赖 fake generator；支持 OpenAI 兼容 streaming（优先 Responses API，允许 fallback chat.completions）；CI/E2E 必须离线（默认 fake 或本地 stub）；`INTERRUPT` 仍需中断 token 且最终 `CHAT_DONE.payload.interrupted=true`；`CHAT_TOKEN/CHAT_DONE` 仍需落库便于 resume/replay。
- 实现目标/逻辑：
  - 将 WS chat streaming 的 token 源抽象为 `stream_chat_tokens()`，由 `OPENAI_MODE` 驱动选择 `fake` 或 `openai` provider；默认 `OPENAI_MODE=fake` 保证离线可跑。
  - OpenAI provider 使用异步 `httpx.AsyncClient.stream()` 解析 SSE；Responses 解析 `type=response.output_text.delta` 的 `delta`；chat.completions 解析 `choices[0].delta.content`；遇到未知事件/非 JSON 直接跳过。
  - `INTERRUPT` 语义：WS stream loop 持续检查 stop event；即使 provider 因 stop 提前结束也会把 `interrupted` 置为 true，并确保最终写入/发送 `CHAT_DONE`。
  - 离线 stub：新增 pytest 内置本地 `http.server` SSE stub，覆盖 responses/chat_completions 两种流式与 interrupt。
- 核心变更：
  - `server/app/ws/chat_fake.py`：从占位 fake 升级为 provider 实现（fake + openai SSE streaming + 容错解析 + trust_env=False）。
  - `server/app/ws/v1.py`：`CHAT_SEND` 改为调用 `stream_chat_tokens()`；done payload 增加可选 `error` 字段；中断语义保持。
  - `server/tests/test_ws_v1_openai_streaming_stub.py`：新增本地 stub server 的流式解析与 interrupt 覆盖。
  - `server/pyproject.toml`：将 `httpx` 调整为运行时依赖（openai provider 需要）。
  - `server/app/core/config.py`：补齐 `openai_*` settings 字段（env 驱动）。
- 验证：`cd server && uv run pytest`、`./scripts/ci.sh`。

## [2026-02-15 14:36] - 任务：3.5 审计可查询：新增 audit logs list（过滤/分页）
- 原始需求：新增 admin API 查询审计日志，支持 actor/action/target_type/target_id（可选 since/until）过滤与 limit/offset 分页；排序稳定；operator 与 super_admin 均可查询；新增 pytest 触发 feature_flags update / vision screenshot / ugc approve 并通过 list API 验证；更新 OpenAPI 合同与 TS 生成物；`uv run pytest` 与 `./scripts/ci.sh` 全绿。
- 实现目标/逻辑：
  - 在 `admin_config` router 下新增 `GET /api/v1/admin/config/audit_logs`，查询 `audit_logs` 表并按 `created_at desc, id desc` 稳定排序；过滤字段做等值匹配，时间范围用 `since/until`（若带时区则转 UTC naive 与 DB 对齐）。
  - 响应固定为 `{ items: [...], next_offset }`；items 字段包含 `id/actor/action/target_type/target_id/metadata/created_at`，其中 `metadata` 为解析后的 JSON（失败则回退 raw string）。
  - 鉴权复用 `Depends(get_current_admin_user)`，允许 `operator` 与 `super_admin`。
- 核心变更：
  - `server/app/api/v1/admin_config.py`：新增 audit logs list API + schema。
  - `server/tests/test_task_3_5_audit_logs_list.py`：新增覆盖（无过滤、过滤、分页；同测触发 3 类审计写入）。
  - `contracts/openapi.json`、`client/src/gen/openapi.ts`：随 OpenAPI 导出更新。
- 验证：`cd server && uv run pytest`、`./scripts/ci.sh`。

## [2026-02-15 14:20] - 任务：3.4 Upload 上限与校验（knowledge/ugc/plugins）
- 原始需求：为 `POST /api/v1/knowledge/materials`、`POST /api/v1/ugc/assets`、`POST /api/v1/plugins` 增加上传上限与校验；超限返回 413 且不留下半文件/临时目录；类型不支持返回 400；新增 pytest 覆盖并通过 `uv run pytest` 与 `./scripts/ci.sh`。
- 实现目标/逻辑：
  - knowledge/ugc：采用“先写同目录临时文件 -> 成功后 `os.replace` 原子 move”的落盘策略；写入过程中按 chunk 计数检查字节上限，超限立即 413，并清理临时文件与目录；事务回滚避免落库 `storage_path`。
  - ugc：新增 content-type allowlist（至少包含 `application/octet-stream`），不在 allowlist 直接 400（不写盘、不落库）。
  - plugins：按 `manifest_json+code` 的 UTF-8 字节数做 payload 上限检查，超限 413；其余 manifest/code 校验仍为 400；不影响 GET。
- 核心变更：
  - `server/app/core/config.py`：新增 `knowledge_materials_max_bytes`、`ugc_assets_max_bytes`、`plugins_upload_max_bytes`、`ugc_assets_allowed_content_types`。
  - `server/app/api/v1/knowledge.py`、`server/app/api/v1/ugc.py`：落盘改为临时文件 + 原子替换 + 超限清理。
  - `server/app/api/v1/plugins.py`：payload 字节上限校验。
  - `server/tests/test_task_3_4_upload_limits.py`：新增 413/400/清理行为覆盖。
- 遗留/约束：不在请求路径做 DDL；不新增第三方依赖；413 分支不输出任何文件内容。

## [2026-02-15 12:58] - 任务：2.4 qa_beta 多进程 WS + Celery 事件可达（硬验收脚本）
- 原始需求：补齐 `scripts/qa_beta.sh`，以独立 docker compose project + 动态端口启动 Postgres(pgvector)/Redis；跑迁移；以 `uvicorn --workers 2` 启动 server；启动非 eager 的 Celery worker；在“不重连”的同一条 WS 连接上触发 `/api/v1/dreams/trigger` 并收到 `TIMELINE_EVENT`（证明 worker->redis notify->ws tail->client 链路可达）；最终可靠清理并写固定 evidence：`.sisyphus/evidence/task-beta-ws-multiproc.txt`。
- 实现目标/逻辑：
  - 端口：用 python 绑定 `127.0.0.1:0` 一次性挑选 3 个空闲端口（postgres/redis/server），避免与本机冲突。
  - compose：使用独立 `COMPOSE_PROJECT_NAME` + `docker compose -p <project>`，仅影响本次 project；等待容器 health=healthy 后再继续。
  - 迁移：`cd server && DATABASE_URL=... uv run alembic upgrade head` 指向临时 Postgres。
  - server：`uv run uvicorn app.main:app --workers 2` 多进程启动，并注入 `DATABASE_URL/WS_REDIS_URL/CELERY_BROKER_URL` 指向同一 Postgres/Redis。
  - worker：`uv run celery -A app.workers.celery_app:celery_app worker -l INFO -c 1`（non-eager），并等待日志出现 `ready.` 作为就绪信号。
  - WS 验收：Node 内联脚本使用 `client/node_modules/ws` 建立 WS（带 `Authorization: Bearer ...` header），等 `HELLO` 后触发 `/api/v1/dreams/trigger`，再等待收到 `TIMELINE_EVENT`（payload.event 至少为非空字符串，常见为 `DREAM_ENTRY_CREATED`），并输出摘要到 evidence。
  - 清理：用 `trap` 确保异常退出也会 kill server/worker 进程组 + `docker compose down -v`。
- 核心变更：
  - `scripts/qa_beta.sh`：从骨架补齐为可运行的本机硬验收脚本；证据输出固定为 `.sisyphus/evidence/task-beta-ws-multiproc.txt`。
- 备注：由于 server 依赖 `uvicorn` 的 WebSocket 后端，本脚本在检测到 server venv 缺少 `wsproto` 时会在本机 venv 内按需安装（不改 pyproject/lockfiles），以确保 WS 验收可跑通。

## [2026-02-15 13:05] - 任务：2.3 WS save ownership 校验 + 防滥用上限
- 原始需求：完善 WS `/ws/v1`：连接必须绑定到“存在且属于当前 user、且未 deleted”的 save；并限制同一 `(user_id, save_id)` 下通过不同 `device_id` 大量创建 `ws_device_cursors`（超过 `settings.ws_max_devices_per_save` 拒绝连接，close 1008），但允许已存在 `device_id` 的重连；继续兼容 `device_id` 缺省 `legacy` 且限制最大长度。
- 实现目标/逻辑：
  - ownership：连接握手阶段用 `asyncio.to_thread(_is_owned_save)` 同步校验 save 存在/归属/未删除，不满足则立即 close 1008。
  - 防滥用上限：在 `ensure_device_cursor` 之前先 `device_cursor_exists()`；若已存在则放行；若不存在则 `count_device_cursors()`，当计数已达 `ws_max_devices_per_save` 时拒绝（close 1008），否则再创建 cursor。
  - event loop 保护：WS 主 async 路径中的 DB 读写（HELLO cursor、ACK 更新、PING cursor、chat 事件写入）统一改为 `await asyncio.to_thread(...)`，避免阻塞。
- 核心变更：
  - `server/app/ws/v1.py`：新增 device 上限检查；补齐多处 DB 调用的 `asyncio.to_thread` 包装。
  - `server/app/ws/event_store.py`：新增同步 helper `device_cursor_exists`/`count_device_cursors` 供 WS 复用。
  - `server/tests/test_task_2_3_ws_save_ownership_and_limits.py`：新增验收测试覆盖 ownership 拒绝与设备上限/重连放行。
- 验证：`cd server && uv run pytest`、`./scripts/ci.sh`。

## [2026-02-15 13:45] - 任务：3.2 密码策略 + email 规范化 + 密码重置
- 原始需求：实现 Beta hardening 计划 3.2：弱密码注册返回 400；email 大小写不敏感（重复注册 409、登录/刷新/管理员登录对大小写不敏感）；密码重置提供 request/confirm（request 防枚举总是 202；confirm 成功后旧密码失效、token 不可复用且过期拒绝），并补齐 pytest 与合同生成物。
- 实现目标/逻辑：
  - email 规范化集中在 `normalize_email()`（strip+lower），写入与查询一致；并在 PG 用 `UNIQUE INDEX (lower(email))` 作为并发下的最终一致性保障（users/admin_users）。
  - 密码策略采用最低门槛（禁止空白、至少包含字母+数字），不破坏广泛使用的 `password123`；策略失败在 register/confirm 返回 400（不走 Pydantic 422）。
  - 密码重置：request 永远 202；存在用户则生成原始 token（可 monkeypatch）并仅存 `sha256(token)` 到 DB；confirm 校验 hash 匹配 + 未使用 + 未过期（行锁防并发复用），成功后更新 `User.password_hash`、标记 used，并撤销该用户现存 refresh token/device。
- 核心变更：
  - `server/app/api/v1/auth.py`、`server/app/api/v1/admin_auth.py`
  - `server/app/core/email.py`、`server/app/core/security.py`、`server/app/core/config.py`
  - `server/app/db/models.py`
  - 迁移：`server/alembic/versions/c6c8f2a0a9d1_email_case_insensitive_uniqueness.py`、`server/alembic/versions/d2e4a7b5c1f0_password_reset_tokens.py`
  - 测试：`server/tests/test_task_3_2_auth_password_reset_and_email_normalization.py`
  - 合同生成物：`contracts/openapi.json`、`client/src/gen/openapi.ts`
- 验证：
  - `cd server && uv run pytest`
  - `./scripts/generate-contracts.sh`
  - `./scripts/ci.sh`

## [2026-02-15 12:20] - 任务：2.2 Redis 通知（PubSub）+ WS 实时追尾（不重连也能收到新事件）
- 原始需求：实现计划项 2.2：append 事件后通过 Redis pubsub 通知；WS accept+replay 之后进入实时追尾；各实例只对本机在线连接推送（即每个 WS 连接只订阅自己的 stream channel，而不是全局订阅）。
- 实现目标/逻辑：
  - channel 精确到单个 stream：`ws:v1:{user_id}:{save_id}`（统一由 `redis_notify.ws_v1_stream_channel()` 生成）。
  - WS 每个连接仅订阅自己的 channel；收到 pubsub 消息后不直接转发 payload，而是用 `asyncio.to_thread` 从 DB 拉取 `seq > last_sent_seq` 的事件逐条发送，并更新 `last_sent_seq` 去重。
  - `last_sent_seq` 在 replay 发送历史事件时更新；在 chat stream 直推 token/done 时也更新，避免“直推 + 追尾补拉”导致重复。
  - Redis 不可用时降级：WS 仍可完成 HELLO + replay + chat 直推（追尾 task 启动失败则安静退出，不影响主连接）。
  - 生命周期：WS disconnect 时取消追尾 task，并关闭 pubsub/client，避免泄漏。
- 核心变更：
  - `server/app/ws/v1.py`：增加 per-connection `last_sent_seq` + `_safe_send_json` 去重；replay 改为 `asyncio.to_thread` 拉取；新增 Redis pubsub 追尾 task（订阅 stream channel，收到通知后 DB 补拉并发送）。
  - `server/app/ws/redis_notify.py`：新增 async 订阅/关闭小工具（`subscribe_ws_v1_stream`/`close_async_redis_pubsub`）。
  - `server/tests/test_task_2_2_ws_redis_notify.py`：新增用例验证“WS 不断开也能收到 append 的新 EVENT”。
- 遗留/约束：Redis pubsub 仍是 at-most-once 提示通道，不能作为真相；可靠性来自 DB 补拉与客户端 cursor/ACK。

## [2026-02-15 10:31] - 任务：2.1 Durable EventStore + per-device cursor（WS v1）
- 原始需求：将 `/ws/v1` 的事件日志从进程内 in-memory 迁移为可落盘/可重放的 durable store，并引入 per-device ACK cursor：支持断线重连按 `resume_from` 回放、ACK 幂等单调递增、安全裁剪；`device_id` 作为 WS query param 可选（默认 `legacy`），不强制客户端立刻改造；保持 `server_event_id={user_id}:{save_id}:{seq}` 兼容既有 WS v1 测试口径。
- 实现目标/逻辑：
  - durable store 三表：`ws_streams`（`next_seq/trimmed_upto_seq` 水位）、`ws_events`（事件帧）、`ws_device_cursors`（per-device `last_acked_seq`）。
  - seq 原子分配策略：在事务内对 `ws_streams.next_seq` 执行 `UPDATE ... SET next_seq = next_seq + 1 RETURNING (next_seq - 1) AS seq`，保证并发下单调且不重复。
  - `device_id` 兼容策略：从 WS query param 读取 `device_id`；未提供/空串统一按 `legacy`；连接建立时确保 cursor 行存在。
  - ACK 幂等更新 + 安全裁剪：`ws_device_cursors` 采用 `GREATEST(old, new)` 单调递增更新；裁剪水位取该 stream 下 device cursor 的 `MIN(last_acked_seq)`，推进时更新 `ws_streams.trimmed_upto_seq` 并删除 `ws_events.seq <= trimmed_upto_seq`。
  - 回放 clamp：replay 时对 `resume_from` 做 trimmed watermark clamp（`effective_resume_from = max(resume_from, trimmed_upto_seq)`），避免请求已裁剪历史造成空洞。
  - 兼容性约束：所有可回放事件帧保持 `server_event_id={user_id}:{save_id}:{seq}`，确保现有 WS v1 pytest 不回归。
- 核心变更：
  - `server/app/ws/event_store.py`
  - `server/app/ws/v1.py`
  - `server/app/db/models.py`
  - `server/alembic/versions/7eed360f132d_ws_event_store.py`
  - `server/tests/test_task_2_1_ws_eventstore.py`
- 验证：`cd server && uv run pytest`、`./scripts/ci.sh` 通过。
- 遗留/约束：
  - 离线/僵尸设备可能长期不 ACK 导致 `MIN(last_acked_seq)` 不前进（裁剪受阻）；后续如要自动推进需引入 device lease/TTL + 最小保留策略（时间/条数）。
  - 大量 `DELETE` 可能导致 PG 膨胀/VACUUM 压力；后续可考虑分批删除/分区或按时间窗口保留。

## [2026-02-15 09:56] - 任务：1.4 生产配置强校验（禁止默认 secret 上线）
- 原始需求：在 `ENV=prod`（或 `production`）且未设置 secret 时启动直接失败（明确报错）；非 prod 保持本地/测试可跑，允许 `admin_review_secret` 缺省并自动生成随机值。
- 实现目标/逻辑：
  - `Settings` 增加 `env` 字段读取 `ENV`，并在 after validator 中对 `prod/production` 做 fail-fast 校验（Settings 加载即抛错，进程启动失败）。
  - 校验点：
    - 禁止 `AUTH_ACCESS_TOKEN_SECRET`/`ADMIN_ACCESS_TOKEN_SECRET` 使用默认占位值（`dev-secret-change-me`/`dev-admin-secret-change-me`）或空值；
    - 生产必须显式设置 `ADMIN_REVIEW_SECRET`（禁止依赖每进程随机默认值，避免多实例不一致）。
  - 非 prod：`ADMIN_REVIEW_SECRET` 缺省时用 `default_factory` 生成随机值；不在请求路径做 DDL/副作用。
- 核心变更：
  - `server/app/core/config.py`：新增 `env` + 生产校验 + `admin_review_secret` 的 `Field(default_factory=...)`。
  - `server/tests/test_task_1_4_prod_config.py`：新增 pytest 覆盖 prod/dev/test 行为。
- 验证：`cd server && uv run pytest`、`./scripts/ci.sh` 通过。
- 遗留/约束：本任务仅禁止“默认占位/缺失”，未引入更严格的强度规则（长度/熵）；如需可后续分阶段收紧并同步更新部署文档。

## [2026-02-15 09:23] - 任务：1.3 Health/Readiness：依赖探活（db/redis/pgvector/worker）
- 原始需求：扩展 `/api/v1/health`，返回整体 `status` 与 `dependencies`（db/redis/pgvector/worker）四项；探活必须只读、具备明确超时、失败快速返回；pgvector 禁止 DDL（只查 `pg_extension`）；worker eager 模式不要求外部 worker；同步更新 OpenAPI/TS 生成产物与测试。
- 实现目标/逻辑：
  - `dependencies.*.status` 仅允许 `ok|error`；整体 `status` 仅允许 `ok|degraded`，且严格规则：所有依赖 ok -> `status=ok`，否则 `status=degraded`（避免误报）。
  - db：使用独立短连接执行 `SELECT 1`；同时在同一连接内只读检查 `pg_extension` 是否存在 `vector`。
  - redis：基于 `CELERY_BROKER_URL`（默认 `redis://localhost:6379/0`）用 socket + RESP `PING`（可选 `AUTH`）做轻量探活，不引入新依赖。
  - worker：若 `celery_app.conf.task_always_eager==True` 返回 `mode=eager`；否则用 `celery_app.control.ping(timeout=...)` 探活，并用线程池硬超时兜底避免 hang。
- 核心变更：
  - `server/app/api/v1/health.py`：新增响应 schema（Pydantic），实现 db/pgvector/redis/worker 探活与整体降级规则（全部带超时）。
  - `server/tests/test_health.py`：从 JSON 全等断言改为 schema/一致性断言，并强制 worker eager 以避免测试依赖外部 worker。
  - `contracts/openapi.json`、`client/src/gen/openapi.ts`：随 OpenAPI 导出更新（由脚本生成）。
- 遗留/约束：health 不做任何 DDL；对外部依赖的探测必须始终可控超时，避免健康检查成为阻塞点。

## [2026-02-15 10:05] - 任务：1.2 把 pgvector extension 从请求路径移除
- 原始需求：`memory_ingest/memory_search`、`knowledge_materials_create/knowledge_query` 以及 knowledge worker 索引任务路径不得在运行时执行 `CREATE EXTENSION ...` 或任何 DDL；仍保持本地 embedding + `<->` 检索不回归；新增测试断言防回归。
- 实现目标/逻辑：
  - 删除/停用请求路径与 worker 中的 `_ensure_pgvector()` 及其调用点，不把 DDL “挪到别的隐蔽路径”（例如 startup event）。
  - 保持“扩展由迁移/部署流程预先安装”的约定：如果 pgvector 不可用，API 以更明确的 503 detail 提示先跑迁移/启用扩展（不引入 DDL）。
  - 测试通过 monkeypatch `Session.execute` 检测 SQL 文本包含 `CREATE EXTENSION` 直接 fail；覆盖 memory/knowledge API 与 Celery eager worker 路径。
- 核心变更：
  - `server/app/api/v1/memory.py`：移除请求路径 DDL；缺失 pgvector 时返回 503 detail。
  - `server/app/api/v1/knowledge.py`：移除请求路径 DDL；缺失 pgvector 时返回 503 detail。
  - `server/app/workers/tasks/knowledge.py`：移除 worker 路径 DDL。
  - `server/tests/test_task_1_2_no_request_path_ddl.py`：新增防回归测试（禁止请求/worker 路径触发 `CREATE EXTENSION`）。
- 遗留/约束：不修改 Alembic migrations（1.1 已完成）；后续 1.3 补 health dependencies 时只做只读探活（例如查 `pg_extension`），不要做 DDL。

## [2026-02-15 09:20] - 任务：1.1 迁移补齐（空库 alembic upgrade head 创建全部 Beta 依赖表）
- 原始需求：从“真正空库”执行 `cd server && uv run alembic upgrade head` 必须能创建 `server/app/db/models.py` 定义的全部表/索引/约束；迁移链路需覆盖 `Vector(64)`（memory/knowledge embedding），并在迁移阶段确保 `CREATE EXTENSION vector`（禁止放到请求路径）。
- 实现目标/逻辑：
  - 以现有 revision `6db398364679` 为基线，新增一个接在其后的 revision，补齐其余所有 ORM 表；确保从无 `alembic_version` 的空库升级到 head 全链路可跑通。
  - pgvector：在新 revision 的 `upgrade()` 最开头执行 `CREATE EXTENSION IF NOT EXISTS vector`，保证 `vector(64)` 列创建成功。
  - 为避免 Alembic autogenerate 生成的 `app.db.models.Vector(64)` 在 migration 中未导入导致 NameError，迁移脚本显式 `from app.db.models import Vector` 并使用 `Vector(64)`。
- 核心变更：
  - 新增 `server/alembic/versions/f1dcf9f0abe6_create_beta_tables.py`（down_revision=6db398364679；创建除 auth 外的所有 Beta 表，并包含 pgvector extension DDL）
- 遗留/约束：本任务不改任何业务代码（`server/app/api/**`、`server/app/ws/**`、`client/**`）；后续 1.2 仍需把请求路径里的 vector DDL 全部移除，仅保留迁移/启动期一次性确保。

## [2026-02-15 09:00] - 任务：0.1 Beta 目标清单与版本策略冻结（HTTP/WS）
- 原始需求：输出 `docs/beta-scope.md` 与 `docs/protocol-versioning.md`，并以“当前真实实现”为基准冻结 HTTP/WS 版本策略；同时在 notepad 与 `.ai_session.md` 追加决策/记录。
- 实现目标/逻辑：
  - HTTP 真相来源固定为 `contracts/openapi.json`；合同漂移检查机制以 `scripts/generate-contracts.sh --check` 为准（并被 `scripts/ci.sh` 调用）。
  - WS v1 真相来源固定为 `server/app/ws/v1.py` + `client/src/main/index.ts` + pytest 证据（`server/tests/test_ws_v1_resume.py`、`server/tests/test_ws_v1_chat_stream.py`）。
  - 明确三套版本维度：应用版本（SemVer）、HTTP `/api/v1`、WS `/ws/v1` + `PROTOCOL_VERSION=1`，避免混淆。
  - WS v2 仅作为 Future 计划（device cursor、opaque cursor），明确“不混入 v1 冻结”。
- 核心变更：
  - 新增 `docs/beta-scope.md`
  - 新增 `docs/protocol-versioning.md`
  - 更新 `.sisyphus/notepads/ai-girlfriend-desktop-pet-beta-hardening/decisions.md`
  - 更新 `.ai_session.md`
- 遗留/约束：不修改任何业务代码；不运行测试；文档验收以 `./scripts/qa_beta.sh --dry-run` 输出清单与既有 pytest/ci 脚本作为证据口径。

## [2026-02-15 08:24] - 任务：Wave0.2 新增 qa_beta 骨架脚本
- 原始需求：0.2 新增 `scripts/qa_beta.sh`（只做骨架：启动拓扑 + 空验收点），支持 `--help`/`--dry-run`，并把约定记录到 notepad。
- 实现目标/逻辑：
  - 复用既有 QA/CI runner 风格：`set -euo pipefail`、repo root 探测、step marker/run_step 结构。
  - `--dry-run` 只输出“将要执行的命令清单”，不启动/不修改任何服务，也不写 evidence。
  - evidence 根目录统一为 `.sisyphus/evidence/`，仅预留 `evidence_file`，后续 Wave2/3/4 再逐步补齐真实启动与验收。
- 核心变更：
  - 新增 `scripts/qa_beta.sh`
  - 更新 `.sisyphus/notepads/ai-girlfriend-desktop-pet-beta-hardening/learnings.md`
- 遗留/约束：Wave0.2 仅骨架；Wave2/3/4 落地真实命令时需保持 dry-run 输出与实际执行一致，避免验收漂移。

## [2026-02-15 08:10] - 任务：本次 Beta Hardening 计划启动
- 原始需求：初始化本计划 notepads（learnings/decisions/issues/problems）并记录到 `.ai_session.md`（仅最小增量）。
- 实现目标/逻辑：
  - Plan 名称：ai-girlfriend-desktop-pet-beta-hardening
  - Plan 路径：`.sisyphus/plans/ai-girlfriend-desktop-pet-beta-hardening.md`
  - Notepads 路径：`.sisyphus/notepads/ai-girlfriend-desktop-pet-beta-hardening/`
  - 当前 session id：`ses_3a1657c8affeoUFShjkSqa7EmN`
  - 开始时间：2026-02-15 08:10
  - 接下来先做 Wave0：收敛 Beta Hardening 基线（风险清单/安全基线/验证与证据约定），再进入后续波次。
- 核心变更：
  - 新增 `.sisyphus/notepads/ai-girlfriend-desktop-pet-beta-hardening/`：`learnings.md`、`decisions.md`、`issues.md`、`problems.md`（含追加记录模板）。
  - `.ai_session.md`：在顶部追加本次启动记录（不覆盖既有历史）。
- 遗留/约束：只做记录与模板初始化；不改动任何业务代码；Wave0 的详细 checklist 后续补充到 notepads。

## [2026-02-15 00:00] - 任务：收尾清理（提交证据/笔记 + 忽略 .serena）
- 原始需求：处理未提交的 `.sisyphus/evidence/**`、`.sisyphus/notepads/**`、`.sisyphus/boulder.json`、`.ai_session.md`，并让 `.serena/` 不再出现在 `git status`，最终工作区干净；不 push。
- 实现目标/逻辑：
  - 将本轮产生的 `task-*.{png,txt,json}` 证据与 notepads 归档为单个 chore 提交（便于审阅与追溯）。
  - 通过 `.gitignore` 最小增量忽略 `/.serena/`，避免本地工具状态污染工作区。
  - 提交前检查文本/json 证据不包含真实 token/密钥（允许 `[REDACTED]`/stub 占位）。
- 核心变更：
  - `.gitignore`：追加 `/.serena/`。
  - `.sisyphus/*`：更新/新增 task evidence 与 notepads。
- 遗留/约束：不提交 `.serena/` 内容；不提交任何真实密钥（`AGENTS.md` 保持忽略）。

## [2026-02-14 22:46] - 任务：修复 DoD QA runner 回归（qa_alpha + plugin e2e feature flags）
- 原始需求：
  - `scripts/qa_alpha.sh` 任一步失败必须整体 exit 非 0（不能出现 step fail 仍继续并最终 rc=0/ALL GREEN）。
  - `client/playwright/electron-plugin.spec.ts` 补齐 `GET /api/v1/feature_flags` stub（`plugins_enabled=true`），否则引入远端 kill-switch 后插件 host 无法启动导致 `plugins-menu-item` 不出现。
- 实现目标/逻辑：
  - QA runner 继续用 `tee` 写 evidence，并用 `PIPESTATUS` 捕获 `run_all` 的真实返回码；但 `run_all()` 内部必须在每个 `run_step` 失败时立刻 `return 1`，避免后续步骤与最终 `ALL GREEN` 误报。
  - 插件 e2e 的 stub server 增加 `GET /api/v1/feature_flags`，返回 JSON `{ feature_flags: { plugins_enabled: true } }`（与 main 侧解析器兼容 `plugins_enabled/pluginsEnabled`）。
  - 并发/慢机下 plugins consent 面板可能异步出现：在 e2e 中对 consent panel 做短暂等待再点击 accept，避免漏点导致插件未真正启用。
- 核心变更：
  - `scripts/qa_alpha.sh`：`run_all()` 中每个 `run_step ...` 改为 `run_step ... || return 1`。
  - `client/playwright/electron-plugin.spec.ts`：stub 增加 `GET /api/v1/feature_flags`，并增强 consent panel 的等待/处理。
- 遗留/约束：不新增依赖；不降低既有断言标准；e2e stub 需在 Electron 启动后即可被轮询命中。

## [2026-02-13 23:31] - 任务：初始化项目目录结构
- 原始需求：在当前仓库内按 client/server 方式划分客户端与后端；plan.md 保持当前位置不动；完全不开源。
- 实现目标/逻辑：采用单仓库（monorepo）降低接口/协议频繁调整时的协作与联调成本；根目录创建 client/ 与 server/ 作为两端代码入口。
- 核心变更：新增目录 client/、server/；未移动 plan.md。
- 遗留/约束：
  - 暂不拆分为多个 GitHub 仓库；待 MVP 稳定后再评估是否需要拆仓。
  - 后端 Python 环境后续使用 uv 管理（FastAPI + SQLAlchemy + PostgreSQL + pgvector）。

## [2026-02-14 00:12] - 任务：启动执行 ai-girlfriend-desktop-pet 计划
- 原始需求：桌面端与服务端同步开发；接口规范/协议/数据模型提前设计好；按总计划分波次推进。
- 实现目标/逻辑：遵循 `.sisyphus/plans/ai-girlfriend-desktop-pet.md`，从脚手架与契约流水线开始，逐步落地鉴权、WS 流式、存档/角色、长记忆、投喂、多模态、助手能力、相册、离线生活、社交/UGC/插件与最小管理后台；全程 TDD + 自动化验收产证据。
- 核心变更（预期）：将新增 docker-compose、本地开发脚本、server(FastAPI/SQLAlchemy/Alembic)、client(Electron/React/Playwright)、contracts(OpenAPI/WS schema) 等。
- 遗留/约束：
  - 本机缺少 `rg` 与 `pnpm`；执行阶段优先用 npm 与内置 grep/ast_grep 工具（或后续统一安装）。
  - 高风险能力（截图/插件/UGC/社交）默认关闭，启用必须显式同意且写审计。

## [2026-02-14 01:40] - 任务：完成 Wave1 Task2/Task3 脚手架与自动化验收
- 原始需求：并行推进 server/client，且具备可自动验收的测试与证据产出。
- 实现目标/逻辑：
  - 后端：FastAPI + uv + SQLAlchemy + Alembic，提供 `/api/v1/health`，并用 pytest 覆盖 health 与 DB 连通性（`SELECT 1`）。
  - 客户端：Electron + React + TS + vitest + Playwright Electron smoke，并强制 `data-testid` 稳定选择器。
  - Headless 环境：Linux 无 DISPLAY 时，e2e 通过 `xvfb-run -a` 自动兜底。
- 核心变更：
  - `server/` 新增脚手架与测试；证据：`.sisyphus/evidence/task-2-health.json`
  - `client/` 新增脚手架与测试；证据：`.sisyphus/evidence/task-3-electron-smoke.png`
- 遗留/约束：
  - `electron` 二进制下载偶发不完整：必要时手动运行 `ELECTRON_MIRROR=... node node_modules/electron/install.js`。

## [2026-02-14 00:22] - Task: Local deps + one-command bootstrap
- Original request: implement plan item "基础脚手架：本地依赖与一键启动".
- Goal/logic: provide a minimal Docker Compose stack (Postgres w/ pgvector + Redis) and Make targets that work from repo root.
- Core changes: add `docker-compose.yml`, `Makefile`, `.env.example`, `.gitignore`.
- Constraints: no real secrets committed; `.env` is gitignored; defaults are embedded so `docker compose config` works even without `.env`.

## [2026-02-14 01:35] - 任务：Client 脚手架（Electron + React + TS + 最小 UI）
- 原始需求：实现计划项 3，创建 `client/` 下 Electron+React+TS 的最小可运行工程；从 Day 1 固化 `data-testid`；提供 Vitest 单测与 Playwright Electron 冒烟 e2e（含截图产物）。
- 实现目标/逻辑：renderer 用 Vite+React（`client/src/renderer` 作为 root，build 输出到 `client/dist/renderer`）；主进程/预加载用 `tsc` 编译到 `client/dist/main` 与 `client/dist/preload`；dev 期用 `concurrently + tsc --watch + nodemon + wait-on` 一键启动。
- 核心变更：新增 `client/package.json`、`client/vite.config.ts`、`client/tsconfig*.json`、`client/src/main`、`client/src/preload`、`client/src/renderer`、`client/tests`、`client/playwright`；`client/src/renderer/app/testIds.ts` 提供稳定选择器常量。
- 遗留/约束：
  - 当前网络环境下 Electron 二进制下载可能不稳定；必要时用 `ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/ npm -C client install` 走镜像源。
  - `/// <reference types="vite/client" />` 属于 TS 类型指令，保留以确保 Vite 类型生效（不是“多余注释”）。
  - 已新增 `client/.gitignore` 忽略 `node_modules/`、`dist/`、`playwright-results/` 等生成目录，避免误提交。
  - dev 启动里 `wait-on` 等待本地文件需要 `file:` 前缀（已在 `client/package.json` 中使用 `file:dist/main/index.js` / `file:dist/preload/index.js`）。

## [2026-02-14 00:52] - Task: Server scaffold (FastAPI + uv + DB + Alembic + /health)
- Original request: implement plan checkbox "2. Server scaffold: FastAPI + uv + DB + Alembic + /health".
- Goal/logic: keep a minimal, env-driven FastAPI app with request-id middleware, SQLAlchemy(2.0)+psycopg3 wiring, Alembic scaffold for future migrations, and a single health endpoint for smoke tests.
- Core changes: add `server/pyproject.toml`, `server/app/*`, `server/alembic.ini`, `server/alembic/*`, `server/tests/*`.
- Notes: `uv run pytest` uses the `pytest` console script (sys.path[0] = `.venv/bin`), so `server/tests/conftest.py` ensures `import app` works.

## [2026-02-14 01:18] - Task: Headless e2e wrapper for Electron/Playwright
- Original request: fix `npm -C client run e2e` failing on Linux without $DISPLAY (Electron "Missing X server" crash).
- Goal/logic: keep e2e command stable by conditionally wrapping Playwright with `xvfb-run -a` only when `process.platform==='linux'` and no `DISPLAY`.
- Core changes: add `client/scripts/run-e2e.mjs`; update `client/package.json` e2e script to call the wrapper.
- Constraints: no new npm deps; do not change test logic; only touch `client/`.

## [2026-02-14 01:34] - Task: Task 3 验收证据（Electron smoke 成功截图）
- 原始需求：修改 `client/playwright/electron-smoke.spec.ts`，让 e2e 成功通过时自动输出截图到 `.sisyphus/evidence/task-3-electron-smoke.png`。
- 实现目标/逻辑：在关键断言通过后写入固定证据路径；必要时创建目录；保持 smoke test 轻量且不引入新依赖。
- 核心变更：更新 `client/playwright/electron-smoke.spec.ts`，使用 `path.resolve(process.cwd(), '..', '.sisyphus', 'evidence', ...)` + `fs.promises.mkdir(..., { recursive: true })` + `page.screenshot(...)`。
- 遗留/约束：默认 e2e 通过 `npm -C client run e2e` 运行（cwd 为 `client/`）；若从其他 cwd 运行，证据路径可能需要调整为更稳健的仓库根定位逻辑。

## [2026-02-14 01:55] - Task: Contract pipeline (OpenAPI export + TS gen + drift check)
- Original request: implement plan item "4. Contract pipeline: OpenAPI export + TS SDK gen + drift check".
- Goal/logic: make OpenAPI JSON a first-class artifact at `contracts/openapi.json`, generate TS types into `client/src/gen/`, and provide a deterministic drift check suitable for CI.
- Core changes:
  - `server/app/api/v1/auth.py` adds placeholder auth endpoints (501) so schema includes `/api/v1/auth/*`.
  - `server/app/scripts/export_openapi.py` exports `app.openapi()` with stable JSON formatting.
  - `client/package.json` adds `gen:api` using `openapi-typescript`; output is `client/src/gen/openapi.ts`.
  - `scripts/generate-contracts.sh` regenerates artifacts and optionally enforces `git diff --exit-code`.
- Notes/constraints: keep generated outputs committed to avoid drift; `pyrightconfig.json` added at repo root so LSP resolves server venv deps.

## [2026-02-14 08:34] - 任务：完成 Task 6 Client 登录闭环
- 原始需求：补齐 Client 端登录 UI 与 token 安全存储，并提供 `/auth/me` 验证与 e2e 证据，形成“登录闭环”。
- 实现目标/逻辑：主进程负责 token 的安全存储与 REST 调用（login/me/logout），renderer 通过 preload 暴露的 `window.desktopApi.auth` 仅获取用户信息（me）并渲染状态/错误，避免在 renderer 直接持有敏感 token。
- 核心变更：
  - `client/src/main/index.ts`（新增 `auth:login`/`auth:me`/`auth:logout`，并引入 `PARA_SERVER_BASE_URL`/`PARA_USER_DATA_DIR` 相关配置）
  - `client/src/preload/index.ts`（暴露 `window.desktopApi.auth`）
  - `client/src/renderer/app/App.tsx`（显示“已登录：{email}”并处理错误态）
  - `client/playwright/electron-login.spec.ts`（使用本地 stub server 做登录 e2e）
  - `.sisyphus/evidence/task-6-login-success.png`（登录成功截图）
  - `.sisyphus/evidence/task-6-login-fail.png`（登录失败截图）
- 遗留/约束：
  - plan.md 未明确确认的变更不应提交（避免把未达成共识的试验性改动带入主线）。
  - WS 相关的 Task 7 尚未开始（避免把登录与 WS 串流耦合在同一次改动中）。

## [2026-02-14 10:12] - 任务：WS 协议 v1（Server）：HELLO/ACK/PING + 断线重连骨架
- 原始需求：实现 `/ws/v1?save_id=<string>&resume_from=<int>` WebSocket；用 `Authorization: Bearer <access_token>` 鉴权并解析 `user_id=sub`；支持 HELLO/ACK/PING(PONG) 与断线重连回放。
- 实现目标/逻辑：以 `(user_id, save_id)` 为维度维护 in-memory 事件日志与单调递增 `seq`；控制帧统一 `seq=0`/`server_event_id=null`，可回放事件才分配 `seq>=1` 且 `server_event_id=f"{user_id}:{save_id}:{seq}"`；重连仅回放 `seq > resume_from` 的事件，确保 `server_event_id` 不重复。
- 核心变更：
  - `server/app/ws/v1.py`：新增 stream 状态模型与 `append_event`/`get_events_after`，并实现 WS endpoint。
  - `server/app/main.py`：挂载 WS router，确保路径严格为 `/ws/v1`（不走 `/api/v1` 前缀）。
- 遗留/约束：当前仅 in-memory 骨架，未引入 DB/持久化；后续扩展需补齐事件落盘/裁剪策略与更严格的消息校验。

## [2026-02-14 14:26] - 任务：Task 8 流式聊天（Server 侧最小实现）
- 原始需求：在现有 `/ws/v1` 上支持 `CHAT_SEND` -> `CHAT_TOKEN`/`CHAT_DONE` 的流式推送，并支持 `INTERRUPT` 中断；事件帧写入 events log，断线后可 `resume_from` 回放。
- 实现目标/逻辑：
  - 保持 Task7 的 `append_event()` 旧行为不变（仍产出固定 `type="EVENT"`），新增内部 `_append_typed_event()` 生成可回放的不同事件类型。
  - 通过 `asyncio.create_task` + `asyncio.Event` 跑后台生成任务；主 receive loop 继续处理 `ACK/PING/INTERRUPT/CHAT_SEND`，避免“单线程循环”导致中断收不到。
  - 发送侧增加 `asyncio.Lock` 串行化 `send_json`，避免并发 send 破坏 Starlette WebSocket 状态。
  - 先实现确定性 fake streaming：把输入回声为 `AI: {text}`，按字符拆分为 token，多帧推送。
- 核心变更：
  - `server/app/ws/v1.py`：新增 `_append_typed_event()`；新增处理 `CHAT_SEND`/`INTERRUPT`；新增事件帧 `CHAT_TOKEN`/`CHAT_DONE`（均写入 events log 以支持断线回放）。
  - `server/app/ws/chat_fake.py`：新增 `fake_chat_tokens()`，按字符异步产出 token，并在每个 token 间 `await asyncio.sleep(0)` 让出调度。
- 遗留/约束：本阶段不落库、不改 DB schema；事件仍为 in-memory，后续需要补持久化与裁剪策略。

## [2026-02-14 15:08] - 任务：Task 8 后端测试（WS 流式 CHAT_SEND/INTERRUPT）
- 原始需求：为 `/ws/v1` 增加 pytest，覆盖 `CHAT_SEND` 流式输出 `CHAT_TOKEN/CHAT_DONE`，以及中途 `INTERRUPT` 能停止并返回 `CHAT_DONE.payload.interrupted=true`。
- 实现目标/逻辑：
  - 复用现有 REST 注册逻辑获取 `access_token`，并通过 `Authorization: Bearer <token>` 建立 WS 连接。
  - 连接后先读取并忽略 `HELLO`；收帧时允许夹杂控制帧（如 `PONG`），通过循环过滤到目标 `type`。
  - 用例 1：断言至少 1 条 `CHAT_TOKEN`（`seq>=1` 且 `server_event_id` 非空）并最终收到 `CHAT_DONE`（`interrupted=false`）。
  - 用例 2：收到首条 `CHAT_TOKEN` 后立刻发送 `INTERRUPT`，随后断言 `CHAT_DONE.payload.interrupted=true`。
- 核心变更：新增 `server/tests/test_ws_v1_chat_stream.py`（仅新增该测试文件，不改 WS 实现）。
- 遗留/约束：测试为减少竞态，第二用例使用较长输入文本以确保中断窗口足够；后续若引入真实模型流式，需根据新节奏调整等待/过滤策略。

## [2026-02-14 12:45] - 任务：Task 11 长记忆：生活记忆写入/检索 + 遗忘（pgvector）
- 原始需求：新增 memory ingest/search/delete API；按 save 隔离且必须鉴权；使用 pgvector `<->` 做相似度检索；删除为软删；pytest 覆盖 ingest→search→delete→search，并落盘证据 JSON。
- 实现目标/逻辑：
  - 数据模型：`MemoryItem` 保存文本与来源/可信标记，`MemoryEmbedding` 保存 `vector(64)` embedding；两者 1:1 关联，软删字段 `deleted_at` 在 `MemoryItem` 上。
  - embedding：实现确定性本地 embedding（按字符 sha256 hash 到固定维度桶计数并归一化），保证无外部依赖且可复现。
  - 检索：用 pgvector 距离运算符 `<->` 排序取 top-k，并返回 `distance` 与 `score=1/(1+distance)`；查询显式 `.cast(Float)` 避免类型推断误用向量 result processor。
  - 扩展启用：在 API 与测试里用 `CREATE EXTENSION IF NOT EXISTS vector` 确保 DB 已安装 pgvector（镜像包含扩展但 DB 默认未 install）。
- 核心变更：
  - `server/app/db/models.py`：新增 `Vector`（pgvector 类型声明）、`MemoryItem`、`MemoryEmbedding`；`Save` 增加 `memory_items` 关系。
  - `server/app/api/v1/memory.py`：新增 `POST /api/v1/memory/ingest`、`GET /api/v1/memory/search`、`DELETE /api/v1/memory/{memory_id}`（delete 需 `save_id` 参数）。
  - `server/app/api/v1/router.py`：挂载 memory router。
  - `server/tests/test_task_11_memory_search.py`：新增用例并写入证据 `.sisyphus/evidence/task-11-memory-search.json`。
- 遗留/约束：严格不修改 `.sisyphus/plans/ai-girlfriend-desktop-pet.md`（该文件存在非预期 diff 风险，需 orchestrator 统一管理）。

## [2026-02-14 12:40] - 任务：Task 11 长记忆（pgvector）
- 原始需求：实现“生活记忆写入/检索 + 遗忘（pgvector）”，并能用自动化验收证明：写入“我喜欢蓝色”后搜索“喜欢的颜色”能命中，删除后不可命中。
- 实现目标/逻辑：
  - REST 新增 `/api/v1/memory/ingest`、`/api/v1/memory/search`、`/api/v1/memory/{id}`（DELETE），全部 Bearer JWT 鉴权，并按 `save_id` 隔离且校验 save 归属当前 user。
  - pgvector：不新增依赖，使用 SQLAlchemy `UserDefinedType` 声明 `vector(64)` 列；本地 embedding 采用字符 hash 到固定维度桶 + 归一化，保证可复现与离线测试。
  - 检索使用 pgvector 距离运算 `<->` 排序；删除采用软删 `deleted_at`（墓碑），查询过滤掉已删除项。
- 核心变更：
  - `server/app/db/models.py`（新增 `Vector` 类型与 `MemoryItem`/`MemoryEmbedding` 模型）
  - `server/app/api/v1/memory.py`（新增 memory API + 本地 embedding）
  - `server/app/api/v1/router.py`（挂载 memory router）
  - `server/tests/test_task_11_memory_search.py`（新增用例 + 写入证据）
  - 证据：`.sisyphus/evidence/task-11-memory-search.json`
- 遗留/约束：当前在请求路径里 `CREATE EXTENSION IF NOT EXISTS vector` 属于偏重操作；后续应迁移化/启动时一次性确保扩展。

## [2026-02-14 13:15] - 任务：Task 12 日记/梦境/总结（Celery + 定时）
- 原始需求：建立 Celery worker/beat 骨架；支持触发一次任务生成“梦境/日记”产物入库，并通过 WS 推送（或可重连回放）；提供自动化证据。
- 实现目标/逻辑：
  - Celery：新增 `server/app/workers/celery_app.py`，使用 Redis 作为 broker/backend；测试通过 `celery_app.conf.task_always_eager = True` 同步执行避免依赖真实 worker。
  - 产物入库：新增 `DreamEntry`（按 `save_id` 隔离），最小字段 `id/save_id/kind/content/created_at`。
  - 触发入口：新增 `POST /api/v1/dreams/trigger`（Bearer JWT 鉴权 + save 归属校验），调用 Celery task 生成 dream entry。
  - WS 推送：Celery task 执行后向 `(user_id, save_id)` 的 in-memory events log 追加可回放事件帧 `TIMELINE_EVENT`（`seq>=1`）。
- 核心变更：
  - `server/app/workers/celery_app.py`
  - `server/app/workers/tasks/dreams.py`
  - `server/app/api/v1/dreams.py`
  - `server/app/api/v1/router.py`
  - `server/app/db/models.py`
  - `server/tests/test_task_12_dream_event.py`
  - 证据：`.sisyphus/evidence/task-12-dream-event.txt`
- 遗留/约束：WS 事件日志目前是进程内内存结构；Celery 真正多进程/多实例部署时需要把事件落到 Redis/DB 或走专门的 push 通道，否则 worker 无法直接影响 API 进程内的 events log。

## [2026-02-14 05:20] - 任务：Task 13 学习投喂（上传→解析→切片→向量化→检索问答含引用）
- 原始需求：新增 knowledge 资料上传（md/txt/pdf）与异步索引；完成后可用 pgvector 检索并返回 answer + citations；所有 API 需 JWT 鉴权且按 save_id 隔离。
- 实现目标/逻辑：
  - 抽取可复现本地 embedding(64) 到共享模块，memory/knowledge 复用同一算法；
  - 上传后落盘到 `server/.data/knowledge/<material_id>/original.<ext>` 并创建 material(status=pending)，随后触发 Celery task 解析→切片→向量化→入库→更新 status；
  - query 用 `<->` 距离检索 top-k chunk，并返回 citations（含 chunk_id/material_id/chunk_index/distance/score/snippet）。
- 核心变更：
  - `server/app/services/embedding_local.py`（共享 embedding 逻辑），`server/app/api/v1/memory.py` 改为复用；
  - `server/app/db/models.py` 新增 `KnowledgeMaterial`/`KnowledgeChunk`（含 `save_id` 隔离、`Vector(64)` embedding）；
  - `server/app/workers/tasks/knowledge.py` 新增 Celery 索引任务；
  - `server/app/api/v1/knowledge.py` 新增 materials/query REST，并在 `server/app/api/v1/router.py` 挂载；
  - `server/tests/test_task_13_knowledge_query.py` 新增 pytest 闭环并落盘证据 `.sisyphus/evidence/task-13-knowledge-query.json`。
- 依赖/验证：新增 `pypdf` 与 `python-multipart`；`uv run pytest`（server/）全绿。

## [2026-02-14 11:55] - 任务：Task 9 存档/Persona（server CRUD + persona 绑定 + 状态隔离 + client 最小 UI）
- 原始需求：实现存档切换与 persona 绑定；每个 save 的聊天/记忆/知识隔离；提供自动化证据“两个 save 历史不串”。
- 实现目标/逻辑：
  - Server 新增 `Save/Persona/SavePersonaBinding` 模型；REST 提供 saves CRUD、personas list/get、save persona bind；鉴权复用 Bearer JWT。
  - WS 隔离基于既有 `(user_id, save_id)` 事件日志 key；通过两条 save 分别流式 chat 并在重连 replay 中断言 token 文本不串。
  - Client 在调试面板中加入“存档/Persona”最小 UI（加载/创建/切换/绑定）；WS connect 使用当前选中 saveId，默认仍为 `default`。
- 核心变更：
  - `server/app/db/models.py`、`server/app/api/v1/saves.py`、`server/app/api/v1/personas.py`、`server/app/api/v1/router.py`
  - `server/tests/test_task_9_save_isolation.py` 输出证据 `.sisyphus/evidence/task-9-save-isolation.txt`
  - `client/src/main/index.ts`、`client/src/preload/index.ts`、`client/src/renderer/app/App.tsx`
- 证据：`.sisyphus/evidence/task-9-save-isolation.txt`
- 遗留/约束：当前 personas 没有“创建 persona”REST；测试里通过 DB 直接插入 persona。后续可加管理端/种子数据。

## [2026-02-14 12:25] - 任务：Task 10 桌宠 UI（透明置顶/穿透/托盘/唤醒/环形菜单）
- 原始需求：Windows 优先的桌宠窗口：透明置顶、默认鼠标穿透；托盘与快捷键唤醒进入可交互态；提供最小环形菜单；自动化验收截图。
- 实现目标/逻辑：
  - main 进程新增 pet BrowserWindow（320x320、transparent/frame-less、alwaysOnTop、skipTaskbar、默认 setIgnoreMouseEvents(true,{forward:true})）。
  - renderer 通过 `?window=pet` 切换渲染 `PetApp`（占位 sprite + 环形菜单 DOM），菜单由点击 sprite 打开。
  - Tray + globalShortcut（`CommandOrControl+Shift+P`）切换可交互态（ignoreMouse true/false）；tray 菜单支持显示/隐藏、打开调试面板、退出。
  - e2e 因多窗口存在，不能依赖 `firstWindow()`；改为按 `window.innerWidth` 选目标窗口。
- 核心变更：
  - `client/src/main/index.ts`
  - `client/src/renderer/main.tsx`
  - `client/src/renderer/pet/PetApp.tsx`
  - `client/playwright/electron-pet-ui.spec.ts`
- 证据：`.sisyphus/evidence/task-10-pet-ui.png`

## [2026-02-14 13:23] - 任务：Task 14 Client：拖拽投喂 UI + 索引进度气泡
- 原始需求：在调试面板中提供拖拽 .md 文件投喂知识的最小 UI；上传必须走 main 进程；轮询 material status 并展示空闲/索引中/完成(或失败)；新增 Playwright Electron e2e 且内置 stub server，不依赖真实后端；通过时落盘证据截图。
- 实现目标/逻辑：
  - renderer 读取 `File.arrayBuffer()` 得到 bytes，通过 preload 暴露的 `window.desktopApi.knowledge` 调用 main IPC；renderer 不直接持有敏感 token。
  - main 通过 `fetch + FormData` 以 multipart 上传到 `/api/v1/knowledge/materials`，并提供 `GET /api/v1/knowledge/materials/{id}` 查询；base url 复用 `PARA_SERVER_BASE_URL`。
  - e2e 在 spec 内起本地 http stub：POST 返回 pending；GET 先 pending 后 indexed，确保进度态可观测；成功后写 `.sisyphus/evidence/task-14-feed-progress.png`。
- 核心变更：
  - `client/src/renderer/app/testIds.ts`（新增 `feed-dropzone`/`feed-progress`/`feed-done`）
  - `client/src/preload/index.ts`（新增 `desktopApi.knowledge`）
  - `client/src/main/index.ts`（新增 IPC handlers：`knowledge:uploadMaterial`/`knowledge:materialStatus`）
  - `client/src/renderer/app/App.tsx`（新增投喂 UI + 轮询逻辑）
  - `client/playwright/electron-feed-knowledge.spec.ts`（新增 e2e stub + 拖拽 + 截图）
- 证据：`.sisyphus/evidence/task-14-feed-progress.png`
- 遗留/约束：当前 e2e stub 不鉴权；真实环境如需要鉴权应在 main 侧复用现有 token 读取与 authed fetch（仍不把 token 暴露给 renderer）。

## [2026-02-14 16:20] - 任务：Task 15 多模态截图理解（强隐私开关 + 最小可用）
- 原始需求：新增 `POST /api/v1/sensors/screenshot`（Bearer 鉴权、校验 save 归属、payload 大小限制），返回稳定 JSON `{ "suggestion": "..." }`；实现保持离线，不调用外部模型。
- 实现目标/逻辑：对截图仅做最小校验（base64 解码 + 体积限制 + 可选 PNG 宽高提取），产出固定提示文案；提供强隐私开关 `privacy_mode`：默认 `strict` 不写 WS，可选 `standard`/`emit_ws_event` 才写入一条 `SUGGESTION` 事件（不包含截图内容）。
- 核心变更：
  - `server/app/api/v1/sensors.py`：新增 screenshot endpoint + 限制与隐私开关 + 可选写 WS typed event
  - `server/app/api/v1/router.py`：挂载 sensors router
  - `server/tests/test_task_15_vision_screenshot.py`：新增 200/401/404 三用例
- 遗留/约束：当前建议文案为占位（不做真实“理解”）；后续如接入真实多模态，需要再次评审隐私策略（默认关闭/显式同意/审计）与存储策略。

## [2026-02-14 14:07] - 任务：Task 15 Client 多模态截图理解（强隐私开关 + 最小闭环 + e2e 证据）
- 原始需求：Client 侧完成最小闭环（toggle + 明确授权 UI + 上传 1 张测试截图 + 显示建议），默认关闭；发送必须在主进程发起网络请求；新增 Electron Playwright e2e，stub server 计数断言并落盘证据截图。
- 实现目标/逻辑：
  - renderer 默认关闭（`aria-pressed=false`），点击 toggle 弹出自定义授权面板，同意后才真正启用；随时可关闭撤回。
  - 启用后点击“发送测试截图”调用 preload IPC `vision:uploadScreenshot`，由 main 进程携带 token 调用 `POST /api/v1/sensors/screenshot`（JSON：`save_id` + `image_base64` + `privacy_mode`），并把 `{ suggestion }` 回传给 renderer 展示。
  - e2e 在 spec 内启动本地 http stub：关闭状态点击发送，hit 计数保持 0；授权开启后点击发送，hit 计数变为 1 且 UI 出现 suggestion；成功时写入固定证据截图。
- 核心变更：
  - `client/src/renderer/app/testIds.ts`（新增 vision 相关 testids）
  - `client/src/renderer/app/App.tsx`（新增 toggle/授权 UI/发送测试截图/展示建议）
  - `client/src/preload/index.ts`（新增 `desktopApi.vision.uploadScreenshot`）
  - `client/src/main/index.ts`（新增 IPC handler `vision:uploadScreenshot`，主进程 POST `/api/v1/sensors/screenshot`）
  - `client/src/renderer/vite-env.d.ts`（补齐 `DesktopApi.vision` typings）
  - `client/playwright/electron-vision-screenshot.spec.ts`（新增 stub server + e2e 断言）
- 证据：`.sisyphus/evidence/task-15-vision-suggestion.png`
- 遗留/约束：renderer 不直接接触 token；测试截图为内置 1x1 PNG base64（仅用于闭环验证，避免引入真实截屏权限/采集逻辑）。

## [2026-02-14 14:31] - 任务：Task 16 Client 系统助手（开关 UI + IPC + suggestion 展示）
- 原始需求：Client 侧新增“系统助手”开关 UI + IPC 通道；主进程周期读取剪贴板，检测变化且“看起来像英文”时调用 `POST /api/v1/sensors/event` 获取 `{suggestion, category}` 并推送到 renderer 展示；新增“闲置关怀”子开关（默认关闭）与最后一次 suggestion 展示；不写 e2e。
- 实现目标/逻辑：
  - renderer：新增“系统助手”卡片与稳定 `data-testid`（主开关/闲置开关/复制英文按钮/建议展示），并订阅 `assistant:suggestion` 推送更新 UI。
  - preload：暴露 `desktopApi.assistant`（`setEnabled`/`setIdleEnabled`/`onSuggestion`/`writeClipboardText`），renderer 不直接持 token。
  - main：实现 `AssistantManager`，仅在开启时轮询剪贴板；idle 子开关启用时启动一次性计时器（默认 5 分钟，可用 `PARA_ASSISTANT_IDLE_MS` 覆盖）；所有事件调用复用 `fetchAuthedJson`，建议通过 `safeSendToRenderer('assistant:suggestion', ...)` 推送。
- 核心变更：
  - `client/src/renderer/app/testIds.ts`（新增 assistant 相关 testids）
  - `client/src/renderer/app/App.tsx`（新增系统助手卡片 + 订阅/展示）
  - `client/src/preload/index.ts`（新增 `desktopApi.assistant`）
  - `client/src/main/index.ts`（新增 assistant IPC + 剪贴板/idle 逻辑 + 推送）
  - `client/src/renderer/vite-env.d.ts`（补齐 typings）
- 遗留/约束：默认关闭（关闭时不轮询剪贴板、不触发 idle）；不输出剪贴板内容日志；本任务未新增/修改 Playwright 测试。

## [2026-02-14 16:25] - 任务：Task 17 生成式相册端到端可验收
- 原始需求：触发生成任务 → job 完成 → 客户端 UI 出现新图片，并产出固定证据截图 `.sisyphus/evidence/task-17-gallery.png`。
- 实现目标/逻辑：renderer 仅通过 preload 暴露的 `desktopApi.gallery` 调用 IPC；所有 HTTP 请求与鉴权 token 均留在 main 进程（复用 `fetchAuthedJson`）。e2e 沿用 spec 内 stub server 策略，避免依赖真实后端与网络波动。
- 核心变更：
  - `client/src/renderer/app/App.tsx` 新增“生成式相册”区块（prompt → generate → refresh/auto-refresh → masonry 展示）。
  - `client/src/renderer/styles.css` 新增 `.gallery-masonry/.gallery-item/.gallery-img` 等轻量样式。
  - 新增 `client/playwright/electron-gallery.spec.ts`，成功后截图写入 `.sisyphus/evidence/task-17-gallery.png`。
- 遗留/约束：
  - Electron e2e 依赖 `client/node_modules/electron/dist/`；缺失时需运行 `ELECTRON_MIRROR=https://npmmirror.com/mirrors/electron/ node client/node_modules/electron/install.js`。
  - 不修改 `plan.md` 与 `.sisyphus/plans/ai-girlfriend-desktop-pet.md`。

## [2026-02-14 18:10] - 任务：Task 18 客户端验收证据（时间轴：离线模拟）
- 原始需求：补齐 Electron Playwright E2E，用 spec 内 stub server 驱动“时间轴（离线模拟）”卡片点击“模拟一次”后生成并展示事件，并落盘截图证据。
- 实现目标/逻辑：沿用既有 E2E 模式（spec 内 `http.createServer` + env 注入 `PARA_SERVER_BASE_URL`/`PARA_USER_DATA_DIR` + 写入 `auth.tokens.json`），并在多窗口场景下按 `window.innerWidth` 选择调试面板窗口；仅用 `data-testid` 选择器等待 `timeline-item` 可见后截图。
- 核心变更：
  - `client/playwright/electron-timeline.spec.ts`：stub `POST /api/v1/timeline/simulate` 与 `GET /api/v1/timeline?...`，点击 `timeline-simulate` 后断言至少 1 个 `timeline-item` 并截图。
  - 证据：`.sisyphus/evidence/task-18-timeline.png`
- 遗留/约束：
  - 选择器仅允许 `data-testid`（`timeline-card`/`timeline-simulate`/`timeline-list`/`timeline-item`），避免文本/结构选择器导致脆弱。
  - 证据路径固定以仓库根为基准（运行时 cwd=client）：`path.resolve(process.cwd(), '..', '.sisyphus', 'evidence', ...)`。

## [2026-02-14 18:07] - 任务：Task 19 社交房间（Room REST + WS ROOM_EVENT 重连回放）
- 原始需求：在 server 端新增房间创建/邀请/加入 REST；并通过现有 WS 事件流追加 `ROOM_EVENT`（可通过重连 replay 收到）；补齐 pytest 验收与证据 `.sisyphus/evidence/task-19-room-event.txt`。
- 实现目标/逻辑：
  - 数据模型：新增 `Room`（`id/room_type/created_by_user_id/created_at`）与 `RoomMember`（`(room_id,user_id)` 唯一；`role/status/created_at/joined_at`），保持最小可演进。
  - REST：新增 `/api/v1/social/rooms`、`/api/v1/social/rooms/{room_id}/invite`、`/api/v1/social/rooms/{room_id}/join`，全部 Bearer JWT 鉴权；invite 校验 room 存在且邀请者为 creator 或已 joined 成员；join 仅允许被邀请用户自己加入。
  - WS：复用 `append_typed_event((user_id, save_id), frame_type='ROOM_EVENT', payload=...)` 追加事件到“相关用户的所有 saves”；验收采用“先触发 REST，再通过 `/ws/v1?...&resume_from=0` 重连回放”模式，断言两边至少收到 `ROOM_JOINED`。
- 核心变更：
  - `server/app/db/models.py`：新增 `Room`/`RoomMember` ORM。
  - `server/app/api/v1/social.py`：新增 rooms create/invite/join REST，并在 create/invite/join 时写入 `ROOM_EVENT`。
  - `server/app/api/v1/router.py`：挂载 social router。
  - `server/tests/test_task_19_room_event.py`：双 WS 客户端 replay 验收 + 证据落盘。
- 证据：`.sisyphus/evidence/task-19-room-event.txt`
- 遗留/约束：当前 WS 事件日志仍为进程内内存结构；未来若引入多进程/多实例，需要把事件存储/广播迁移到 Redis/DB 或专门 push 通道。

## [2026-02-14 18:31] - 任务：Task 19 客户端：社交房间最小 UI + IPC 打通
- 原始需求：在调试面板新增“社交房间”最小 UI（输入好友 user_id、创建房间、邀请、加入、展示房间事件文本），并打通 renderer -> preload -> main 的 IPC 调用到现有 server social endpoints（`/api/v1/social/rooms`、`/invite`、`/join`）。
- 实现目标/逻辑：renderer 严格不直接 fetch/不接触 token；所有 REST 调用均在 main 侧通过 `fetchAuthedJson` 完成；renderer 只通过 preload 暴露的 `window.desktopApi.social.*` 发起 `ipcRenderer.invoke`；WS 事件流在既有 `ws.onEvent` handler 中新增 `ROOM_EVENT` 分支，将 payload 以可读文本形式追加到列表。
- 核心变更：
  - `client/src/main/index.ts`：新增 IPC 常量与 `registerSocialIpcHandlers`（create/invite/join），内部调用 `/api/v1/social/*` 并对 403/404/422 映射可读错误码。
  - `client/src/preload/index.ts`：暴露 `desktopApi.social`（createRoom/invite/join，全部 `ipcRenderer.invoke`）。
  - `client/src/renderer/app/testIds.ts`：新增 social room 相关 testids。
  - `client/src/renderer/app/App.tsx`：新增 Social Room 卡片与状态管理；监听 WS `ROOM_EVENT` 并展示事件列表。
  - `client/src/renderer/vite-env.d.ts`：补齐 `DesktopApi.social` typings（并补齐 saves/personas，减少 renderer 的 `as unknown`）。
- 遗留/约束：
  - WS v1 事件偏“重连 replay”语义；UI 侧只展示收到的 `ROOM_EVENT`，若未连接/未重连则不会自动出现。
  - 事件列表做了长度裁剪（仅保留最近 N 条）以避免调试面板长时间运行时无限增长。

## [2026-02-14 19:10] - 任务：Task 19 客户端最小 UI 补齐（Social Room 卡片 + IPC + ROOM_EVENT 展示）
- 原始需求：客户端补齐最小可操作 UI：创建房间/邀请/加入；并能在调试面板中看到 `ROOM_EVENT`（来自 WS 重连 replay）。
- 实现目标/逻辑：
  - renderer：在 `client/src/renderer/app/App.tsx` 新增 Social Room 卡片，按钮调用 preload 暴露的 `window.desktopApi.social`；UI 全部用 `client/src/renderer/app/testIds.ts` 常量作为稳定 `data-testid`。
  - IPC + REST：renderer 不直接接触 token；Social REST 请求全部由 main 进程 handler 发起，并复用 main 侧的 `fetchAuthedJson`（把鉴权与敏感信息留在主进程）。
  - WS 展示：监听 ws 事件流中的 `ROOM_EVENT`，将 payload 追加到列表用于可视化；由于事件来自“重连 replay + 多 save fan-out”可能重复，按 `server_event_id` 去重。
- 核心变更：
  - `client/src/renderer/app/App.tsx`
  - `client/src/renderer/app/testIds.ts`
  - `client/src/preload/index.ts`
  - `client/src/main/index.ts`
  - `client/src/renderer/vite-env.d.ts`
- 遗留/约束：
  - `ROOM_EVENT` 可能需要先连接/重连 WS 才能收到（依赖 server 侧 replay 语义），UI 文案需明确提示“可能需要先连接/重连”。
  - renderer 侧不读取/不缓存 token；所有 authed REST 仍必须走 main。

## [2026-02-14 18:43] - 任务：Task 20 计划任务（UGC 工坊骨架）
- 原始需求：实现 UGC 资源上传（pending）+ Admin 审核通过/拒绝（带审计）+ Client 仅拉取 approved 资源列表（本次仅做 server list endpoint + pytest 证据）。
- 实现目标/逻辑：
  - UGC 上传：`POST /api/v1/ugc/assets`（Bearer JWT）接收 multipart：`file` + `manifest_json` + `asset_type`；服务端创建 `ugc_assets(status='pending')`，并将文件落盘到 `server/.data/ugc/<asset_id>/original`（路径由服务端生成，不信任用户文件名）。
  - UGC 列表：`GET /api/v1/ugc/assets` 默认仅返回 `approved`（client 拉取安全默认）；支持 `?status=approved`，其他 status 直接 400。
  - Admin 审核：`POST /api/v1/admin/review/ugc/{asset_id}:approve|reject` 通过 `X-Admin-Secret` 保护（`settings.admin_review_secret`）；改写资源 `status` 并写入 `audit_logs`（actor/action/target_id/created_at，metadata 记录 from/to）。
  - 默认 admin secret：本地/测试用随机默认值；生产环境必须显式设置环境变量（避免误用默认值）。
- 核心变更：
  - `server/app/db/models.py`：新增 `UgcAsset`、`AuditLog`
  - `server/app/core/config.py`：新增 `admin_review_secret`
  - `server/app/api/v1/ugc.py`：新增 UGC upload + list
  - `server/app/api/v1/admin_review.py`：新增审核 approve/reject
  - `server/app/api/v1/router.py`：挂载 ugc + admin_review routers
  - `server/tests/test_task_20_ugc_approve.py`：pytest 闭环 + evidence 落盘 `.sisyphus/evidence/task-20-ugc-approve.txt`
- 遗留/约束：
  - 本任务不做 Admin RBAC/login（后续 Task 22）；审计 actor 当前固定为 `admin` 字符串。
  - 客户端 UI/IPC 拉取 approved 列表后续单独任务补齐。

## [2026-02-14 21:40] - 任务：Task 21 插件系统 alpha（Server 侧）
- 原始需求：实现插件包上传（pending）→ 管理员审核 approve/reject（写审计）→ 客户端仅 list/download approved。
- 实现目标/逻辑：
  - 数据模型：新增 `PluginPackage`（`plugin_id/version/name/entry/permissions_json/manifest_json/code_text/sha256/status/created_at/updated_at`），并对 `(plugin_id, version)` 做唯一约束。
  - Manifest 规则：`manifest_json` 必须是 JSON object，且包含 `id/version/name/entry/permissions`；其中 `entry` 必须为 `index.js`；`permissions` 必须显式声明（object 或 list），为空表示默认 deny。
  - Admin 上传：`POST /api/v1/plugins`（`X-Admin-Secret: <settings.admin_review_secret>`），body 为 `{manifest_json: string, code: string}`；服务端校验并将 manifest/permissions 做 canonical JSON（`ensure_ascii=True, separators=(",",":"), sort_keys=True`），并计算 `sha256(code)`；创建 `status='pending'`。
  - Admin 审核：`POST /api/v1/admin/review/plugins/{plugin_id}/{version}:approve|reject`（同样用 `X-Admin-Secret` 保护）；更新 status 并写 `AuditLog`：`action='plugin.approve'|'plugin.reject'`，`target_type='plugin_package'`，metadata 记录 from/to。
  - Client 拉取：`GET /api/v1/plugins`（Bearer JWT，复用 `require_user_id`）仅返回 approved 列表（`id/version/name/sha256/permissions`）；`GET /api/v1/plugins/{plugin_id}/{version}` 仅允许下载 approved（未批准一律 404）。
- 核心变更：
  - `server/app/db/models.py`：新增 `PluginPackage`
  - `server/app/api/v1/plugins.py`：新增 plugins router（upload/list/download）
  - `server/app/api/v1/admin_review.py`：扩展插件包 approve/reject + 审计
  - `server/app/api/v1/router.py`：挂载 plugins router
  - `server/tests/test_task_21_plugins.py`：pytest 闭环（upload→approve→list→download）
- 遗留/约束：本任务只落库与下发 permissions，不实现“权限执行/沙箱/运行时拦截”；Admin 仍为共享密钥模式（不做 RBAC/login）。

## [2026-02-14 21:10] - 任务：Task 20 客户端补齐（仅拉取 approved 资源列表）
- 原始需求：补齐 Task 20 的客户端部分：调试面板新增“UGC 工坊（只拉取 approved）”卡片；renderer 不直接 fetch/不接触 token；走 main 侧 authed fetch 拉取 `GET /api/v1/ugc/assets?status=approved` 并渲染列表（至少显示 id + asset_type），失败显示 `.danger`。
- 实现目标/逻辑：
  - UI：新增 UGC 卡片（刷新按钮 + 列表容器 + item），新增元素全部使用 `data-testid`，并集中维护在 `client/src/renderer/app/testIds.ts`。
  - IPC：renderer -> preload -> main 走 `ipcRenderer.invoke('ugc:listApproved')`；main 侧复用 `fetchAuthedJson`（携带 token）请求固定 endpoint，并用 `throwApiErrorForStatus` 统一映射错误码。
  - 数据：主进程返回最小字段 `{ id, asset_type }[]`（过滤空值），renderer 仅展示不做编辑。
- 核心变更：
  - `client/src/renderer/app/testIds.ts`（新增 UGC 相关 testids）
  - `client/src/renderer/app/App.tsx`（新增 UGC 卡片：刷新 + approved 列表展示 + danger 错误）
  - `client/src/preload/index.ts`（暴露 `desktopApi.ugc.listApproved()`）
  - `client/src/main/index.ts`（新增 IPC handler：`ugc:listApproved` → GET `/api/v1/ugc/assets?status=approved`）
  - `client/src/renderer/vite-env.d.ts`（补齐 `DesktopApi.ugc` typings）
- 遗留/约束：客户端暂不做上传/审核 UI（后续 Task 22 做 admin）；UGC 列表当前固定只拉取 `approved`（避免误展示未审核内容）。

## [2026-02-14 22:40] - 任务：Task 21 客户端 core（插件运行时 + feature flag + Debug Panel + IPC）
- 原始需求：实现插件系统 alpha 的客户端核心：默认关闭；主进程负责 list/download/sha256 校验与落盘；插件在独立子进程中用 vm 执行，并通过 IPC 回传菜单项；renderer 只通过 preload API 驱动调试卡片，不直接 fetch。
- 实现目标/逻辑：
  - Feature flag：插件执行 `enabled` 默认 `false`（首次启动不创建/不拉起任何插件 host）。状态持久化到 userData（支持 `PARA_USER_DATA_DIR` 覆盖）。
  - IPC：新增 `desktopApi.plugins`：`getStatus/setEnabled/listApproved/install/getMenuItems`；renderer 不碰 token，所有网络请求在主进程复用 `fetchAuthedJson`/Bearer token 完成。
  - 安装与校验：`GET /api/v1/plugins` 拉取 approved 列表（字段 `id/version/name/sha256/permissions`），选择后 `GET /api/v1/plugins/{id}/{version}` 下载 code text；主进程计算 `sha256(code)` 校验一致后写入 `userData/plugins/bundles/<id>/<version>/index.js`。
  - 隔离执行：主进程 `child_process.fork(dist/main/plugin_host.js)` 拉起 host；host 内用 `vm.createContext`（尽量禁用 `codeGeneration.strings/wasm`）+ `runInContext(timeout=...)` 执行插件代码。
  - 插件 API（alpha deny-all 权限模型）：插件必须显式带 `permissions`（允许 `{}` / `[]` 代表 deny-all），但 alpha 阶段不授予额外能力，仅提供 `say(text)` / `suggestion(text)` / `addMenuItem({id,label})`；并在 host 侧做文本长度与菜单项数量上限。
- 核心变更：
  - `client/src/main/index.ts`（PluginManager + 持久化 + IPC handlers + fork host + menu items 缓存）
  - `client/src/main/plugin_host.ts`（子进程入口：vm 执行 + API 限流）
  - `client/src/preload/index.ts`（暴露 `desktopApi.plugins`）
  - `client/src/renderer/app/testIds.ts`（新增 plugins 相关 testids）
  - `client/src/renderer/app/App.tsx`（Debug Panel 新增 Plugins 卡片）
  - `client/src/renderer/vite-env.d.ts`（补齐 `DesktopApi.plugins` typings）
- 遗留/约束：
  - `say/suggestion` 目前仅做“从插件到主进程”的管道与长度裁剪，暂未接入桌宠气泡/主 UI 展示（后续接入 Pet radial menu 与气泡系统）。
  - `vm` 不是安全边界；当前实现只做 alpha 级别隔离与限流（子进程 + 禁用字符串代码生成尽力而为 + 同步执行 timeout）。

## [2026-02-14 20:00] - 任务：Task 21 插件运行时/协议链路打通（Client）
- 原始需求：对齐 server download JSON 协议，打通“菜单点击回路”与“插件输出 push 到 renderer（至少桌宠窗口可订阅）”，并保持默认关闭。
- 实现目标/逻辑：
  - 下载：`GET /api/v1/plugins/{id}/{version}` 按 JSON `{manifest_json, code, sha256}` 解析；用 `sha256(code)` 校验（同时对比 list 返回的 sha256 与 download 返回的 sha256），再把 `code` 落盘到 `userData/plugins/bundles/<id>/<version>/index.js`。
  - 点击：plugin host 支持 `onMenuClick(id, fn)` 注册回调；主进程新增 `plugins:menuClick` IPC，把点击请求转发给 host（带 requestId），host 在 vm 内执行并回传 `menu:click:result`；两侧均做超时与 pending 数量上限。
  - 输出：主进程把插件 `say/suggestion` 通过 `plugins:output` 广播到所有窗口；preload 暴露 `desktopApi.plugins.onOutput` 供 renderer/pet 订阅。
  - 多窗口：push 走广播函数（`safeSendToAllRenderers`），避免原 `safeSendToRenderer` 只偏向 mainWindow 导致桌宠收不到。
- 核心变更：`client/src/main/index.ts`、`client/src/main/plugin_host.ts`、`client/src/preload/index.ts`、`client/src/renderer/vite-env.d.ts`；并按要求追加更新 notepads。
- 遗留/约束：未实现 ESM export/模块系统；仍为“脚本式插件”；`vm` 非安全边界，仅做 alpha 级别限流与超时。

## [2026-02-14 20:21] - 任务：Task 21 插件系统验收证据补齐（Electron Playwright e2e）
- 原始需求：只补齐 Task 21 的“自动化验收证据”部分：新增 Playwright Electron e2e + 证据截图；不改 plan 勾选、不新增依赖。
- 实现目标/逻辑：沿用现有 e2e 模式（spec 内 stub server + 临时 userData + 写入 `auth.tokens.json` + 双窗口选择），覆盖“默认关闭→开启→安装→桌宠菜单点击→气泡输出”闭环。
- 核心变更：
  - 新增 `client/playwright/electron-plugin.spec.ts`：stub `/api/v1/plugins` 与 `/api/v1/plugins/{id}/{version}` 返回 1 个 approved 插件；sha256 由 spec 内对 code 真实计算；并 stub `/api/v1/auth/me` 维持登录态。
  - 成功时截图证据写入：`.sisyphus/evidence/task-21-plugin.png`（从 `client/` cwd 回到 repo root）。
- 遗留/约束：Electron e2e 在无 `$DISPLAY` 的 Linux 上仍需 `xvfb-run -a`（仓库已有 wrapper）；测试依赖 `client/dist/main/index.js` 已构建。

## [2026-02-14 22:30] - 任务：Task 22 Server：最小管理后台 API（Admin RBAC + Config + Feature Flags + Metrics）
- 原始需求：落地最小管理后台 server 侧 API：admin 登录（Bearer token）+ RBAC（super_admin/operator）+ 配置与 feature flags 持久化 + metrics summary；并提供 pytest 验收（login + put flags + user get flags）。
- 实现目标/逻辑：
  - Admin 登录：新增 `admin_users` 表，复用 `core.security` 的 PBKDF2 hash/verify 与 JWT HS256 编码/解码；admin token 用独立 settings secret（避免与用户 token 混用）。
  - RBAC：`super_admin` 可 `PUT`，`operator` 仅 `GET`；鉴权通过 `Authorization: Bearer <admin_token>`。
  - 配置/flags：新增 `admin_kv`（namespace+key 唯一），`value_json` 存储 canonical JSON（`ensure_ascii=True, separators=(",",":"), sort_keys=True`）；feature flags 最小字段 `plugins_enabled: bool`，默认 false。
  - Metrics：`GET /api/v1/admin/metrics/summary` 返回稳定结构（含 `generated_at`、`audit_log_count_24h`、`admin_user_count`）。
- 核心变更：
  - `server/app/db/models.py`：新增 `AdminUser`、`AdminKV`
  - `server/app/core/config.py`：新增 `admin_access_token_secret`、`admin_access_token_ttl_seconds`
  - `server/app/api/v1/admin_auth.py`：`POST /api/v1/admin/auth/login`
  - `server/app/api/v1/admin_deps.py`：admin bearer 解析 + RBAC 依赖
  - `server/app/api/v1/admin_config.py`：config/models/prompts/feature_flags GET/PUT
  - `server/app/api/v1/admin_metrics.py`：metrics summary
  - `server/app/api/v1/feature_flags.py`：普通用户拉取生效 flags
  - `server/app/api/v1/router.py`：挂载新增 routers
  - `server/tests/test_task_22_admin_flags.py`：pytest 覆盖 login + RBAC + flags 下发 + canonical JSON
- 遗留/约束：暂不提供“创建第一个 admin”的生产化 bootstrap 通道；不改动既有 `admin_review.py` 的 `X-Admin-Secret` 守卫。

## [2026-02-14 20:57] - 任务：Task 22 Client：feature flags 轮询驱动插件实时启停（plugins_enabled）
- 原始需求：实现“修改一个开关 → 客户端实时生效”的客户端侧最小闭环：主进程轮询 `GET /api/v1/feature_flags`，并用 `feature_flags.plugins_enabled` 实时启停插件执行；当关闭时插件菜单项必须为空且 plugin host 停止；当从 false->true 且本地 enabled=true 且已安装插件存在时应自动启动 host。
- 实现目标/逻辑：
  - 仅改 main：在主进程新增保守轮询（1200ms，带错误吞吐），按 `PARA_SERVER_BASE_URL` 拼出 `/api/v1/feature_flags` 请求；不新增依赖。
  - 将 `PluginManager` 的“本地 enabled=true”与“远端 plugins_enabled=true”做 AND 组合为唯一执行条件；任何一侧关闭都立即 stop host + 清空 menu。
  - 远端从 false->true 时触发一次 reconcile：若本地 enabled=true 且 installed 存在则自动启动 host 并重新产出菜单项。
- 核心变更：
  - `client/src/main/index.ts`：新增 `FeatureFlagsPoller`（轮询 + 变更检测）与 `PluginManager.setRemotePluginsEnabled()`（远端 kill-switch + 统一 reconcile），并让 `desktopApi.plugins.getMenuItems()` 在 flags 关闭时稳定返回空数组。
- 遗留/约束：
  - 目前 feature flags 拉取先按 public/无 token 实现；若未来变为 bearer，可在 main 侧增加“401 时尝试 authed fetch”的兼容分支。
  - 默认安全策略：首次成功拉到 flags 前视为 `plugins_enabled=false`，因此在离线/endpoint 缺失时插件不会运行。

## [2026-02-14 21:09] - 任务：Task 22 验收证据（Admin 登录 -> 修改 feature flag -> 客户端实时生效）
- 原始需求：补齐 Task 22 的验收证据：Playwright Electron e2e 自动化闭环“登录 admin → 修改一个开关 → 客户端实时生效”，并生成截图 `.sisyphus/evidence/task-22-admin-flag.png`。
- 实现目标/逻辑：
  - e2e 仍采用“spec 内 stub server”策略：用 `http.createServer` 提供 `/api/v1/plugins` + `/api/v1/feature_flags` + admin login/PUT flags，避免依赖真实后端。
  - 初始 `plugins_enabled=false`：即使本地插件执行已开启且已安装插件，桌宠 pet 环形菜单也必须没有插件入口（远端 kill-switch 生效）。
  - 通过 `POST /api/v1/admin/auth/login` 获取 stub token，再 `PUT /api/v1/admin/config/feature_flags` 切到 `plugins_enabled=true`；等待 client 侧 `FeatureFlagsPoller(1200ms)` 拉到新值并自动启动 plugin host；最终在 pet 菜单断言插件入口出现，点击后出现 `pet-plugin-bubble`。
- 核心变更：
  - 新增 `client/playwright/electron-admin-flag.spec.ts`（stub server + 双窗口选择 + pet 断言 + evidence 截图）。
  - 证据：`.sisyphus/evidence/task-22-admin-flag.png`
- 遗留/约束：Electron e2e 需要先构建 `client/dist/main/index.js`（已由 `npm -C client run e2e` 自动执行 build）；Linux 无 DISPLAY 时依赖 `xvfb-run -a`（已有 wrapper 自动兜底）。

## [2026-02-14 22:10] - 任务：Task 23 隐私/安全基线（同意弹窗、数据保留、日志脱敏、审计）
- 原始需求：为“敏感能力”补齐客户端同意 UI（插件执行开关需与 vision 同模式，可拒绝/可撤回）；服务端对截图与 admin feature flags 变更写入 `audit_logs`；提供最小可执行的数据保留策略；并做日志脱敏兜底（Authorization/token/base64/插件 code 等不出现在最终日志输出）。
- 实现目标/逻辑：
  - Client：在 `plugins` toggle 从关闭->开启时弹出同意面板；同意后才调用 `desktopApi.plugins.setEnabled(true)`；拒绝保持关闭；开启后点击按钮可撤回关闭。
  - Server 审计：
    - 截图：`POST /api/v1/sensors/screenshot` 成功调用写 `AuditLog(action='sensors.screenshot', target_type='save', target_id=<save_id>, actor='user:<user_id>')`，metadata 仅记录 bytes/宽高/隐私模式/是否 emit。
    - Feature flags：`PUT /api/v1/admin/config/feature_flags` 当 `plugins_enabled` 发生变化时写 `AuditLog(action='feature_flags.update', target_type='feature_flags', target_id='global', actor='admin:<admin_id>')`，metadata 记录 changes.from/to。
    - 插件 approve/reject：沿用 Task 21 已有 `plugin.approve`/`plugin.reject` 审计（不改语义）。
  - 日志脱敏兜底：在 logging formatter 层对最终输出字符串做 regex 替换（Bearer token、image_base64、data URL base64、code/manifest_json、长 base64 串等）。

## [2026-02-14 22:19] - 任务：Task 24 CI/本地一键验收脚本（契约漂移 + 测试全绿）
- 原始需求：实现计划勾选项 Task 24：契约漂移检查 + server/client 测试全绿；任一步失败需要输出“哪一步失败 + 命令”；成功/失败都要写固定证据 `.sisyphus/evidence/task-24-ci.txt`。
- 实现目标/逻辑：新增 `scripts/ci.sh`，从脚本位置稳健定位 repo root，串行执行：`./scripts/generate-contracts.sh --check`（复用既有契约导出/TS 生成与 drift 检测逻辑）-> `(cd server && uv run pytest)` -> `npm -C client test`；每步前后打印稳定 marker；整体 stdout/stderr 通过 `tee` 写入证据文件。
- 核心变更：新增 `scripts/ci.sh`；证据路径固定为 `.sisyphus/evidence/task-24-ci.txt`（从仓库根定位）。
- 遗留/约束：不修改计划文件、不新增依赖；该证据文件每次运行会覆盖写入（确保单次验收日志完整、可追溯）。
  - Data retention：新增 settings `audit_log_retention_days`（默认 90），并提供最小清理入口 `POST /api/v1/admin/config/audit_logs:cleanup?days=N`（super_admin）。
- 核心变更：
  - `client/src/renderer/app/App.tsx`：抽出轻量 `ConsentPanel`，复用到 vision 与 plugins；plugins toggle 增加同意 gate。
  - `client/src/renderer/app/testIds.ts`：新增 `pluginsConsentPanel/pluginsConsentAccept/pluginsConsentDecline`。
  - `client/playwright/electron-plugin.spec.ts`、`client/playwright/electron-admin-flag.spec.ts`：兼容 plugins consent panel（若出现则点击 accept）。
  - `server/app/core/logging.py`：新增 `RedactingFormatter` 并在 `configure_logging()` 中启用。
  - `server/app/api/v1/sensors.py`：截图 endpoint 写审计（metadata 不含截图内容）并仅记录元信息日志。
  - `server/app/api/v1/admin_config.py`：feature flags 变更写审计；新增 audit_logs cleanup endpoint。
  - `server/app/core/config.py`：新增 `audit_log_retention_days`。
  - `server/tests/test_task_23_privacy_audit.py`：覆盖脱敏 formatter + screenshot/admin flags 审计入库 + retention cleanup；并生成证据 `.sisyphus/evidence/task-23-audit.txt`。
  - 遗留/约束：脱敏为“兜底层”，仍应遵守“不打印 body/token/base64/prompt/plugin code”的编码纪律；脱敏可能会对含长 base64 的调试输出做过度替换（属于预期的安全优先）。

## [2026-02-18 18:19] - 任务：Task 1 后端：新增 invite_registration_enabled feature flag（默认 true + 部分更新）
- 原始需求：实现 feature flag `invite_registration_enabled`（默认 true），并通过 AdminKV(feature_flags/global) 存 overrides；`GET /api/v1/feature_flags` 与 `GET/PUT /api/v1/admin/config/feature_flags` 均需支持；PUT 允许部分更新且不清掉其他 override；未知 key 或非 bool 返回 400。
- 实现目标/逻辑：
  - 默认值：`plugins_enabled=false`、`invite_registration_enabled=true`，当 DB 未写入该字段时仍下发默认值。
  - 存储：只存 overrides；当提交值等于默认值时从 overrides 中移除该 key，避免把所有默认值写入 `AdminKV(feature_flags/global)`。
  - PUT 校验：仅允许 `plugins_enabled`/`invite_registration_enabled`；payload 为空/未知 key/非 bool 均 400；写入时与已存 overrides 合并。
  - GET 输出稳健：对 DB 中未知字段或非 bool 值忽略，只合并已知 bool key，避免脏数据导致输出类型异常。
- 核心变更：
  - `server/app/api/v1/feature_flags.py`：扩展默认 flags；合并 overrides 时只接受已知 bool。
  - `server/app/api/v1/admin_config.py`：扩展默认 flags；PUT 支持部分更新 + 合并 overrides + 严格校验；GET 合并时只接受已知 bool。
  - `server/tests/test_task_22_admin_flags.py`：扩展用例覆盖默认值、部分更新不丢失、未知 key/非 bool 400、RBAC 不回归。
- 遗留/约束：当所有 overrides 清空时目前会保留 `AdminKV` 行并写入 `{}`；语义正确但不是“删除行”。

## [2026-02-14 23:10] - 任务：Task 23 服务端校正（脱敏收敛 + 审计规范 + retention helper）
- 原始需求：按 Task23 验收补齐“无敏感日志 + 审计表有记录 + 可执行保留策略 + 证据文件”，并避免脱敏规则误伤 WS `CHAT_TOKEN`。
- 实现目标/逻辑：
  - 脱敏：移除对通用 key `token` 的正则匹配；增加 `access_token/refresh_token` 的 key=value 形式脱敏，以及 JSON/pydict 的 `authorization: "Bearer ..."` 形式脱敏；保留 `Authorization: Bearer`、`image_base64`、`data:image/*;base64,` 与长 base64 串兜底。
  - 审计：截图 action 统一为 `vision.screenshot`；feature flags 审计 metadata 改为 `namespace/key/changed_keys + prev/next sha256+len`，不写入完整 flags JSON。
  - 保留：抽出 `purge_old_audit_logs(db, now, retention_days)` helper，并让 `POST /api/v1/admin/config/audit_logs:cleanup` 复用；测试直接调用 helper 验证。
- 核心变更：
  - `server/app/core/logging.py`：收敛 token 脱敏规则，补齐 JSON 与 key=value 模式。
  - `server/app/api/v1/sensors.py`：action 改为 `vision.screenshot`。
  - `server/app/api/v1/admin_config.py`：feature flags 审计 metadata 变更为 hash/len 摘要；cleanup 调用 helper。
  - `server/app/core/audit.py`：新增 `purge_old_audit_logs`。
  - `server/tests/test_task_23_privacy_audit.py`：更新断言与证据输出，避免写入真实 token/base64。
- 遗留/约束：长 base64 串兜底正则可能对某些长随机字符串做过度脱敏（安全优先）；仍需遵守编码纪律避免打印 body/token/base64。

## [2026-02-14 22:29] - 任务：Task 25 Alpha E2E QA Runner（端到端证据产出）
- 原始需求：新增 `./scripts/qa_alpha.sh` 一键跑通 CI + Electron e2e，并在 `.sisyphus/evidence/` 产出与校验证据；输出稳定 marker；失败指出缺少哪些证据。
- 实现目标/逻辑：
  - 复用 `scripts/ci.sh` 作为后端/合同/单测主链路，避免重复实现 curl/鉴权。
  - 复用 Playwright Electron specs 作为 UI 端到端截图证据来源（登录/聊天流/投喂/相册/时间轴）。
  - 以“关键文件存在性检查”作为强约束（比单纯计数更抗误报），并保留最小证据数量阈值（>=10）。
  - 用外层 `tee` 写 `.sisyphus/evidence/task-25-qa-alpha.txt`，并通过 `PIPESTATUS` 保留真实 exit code（避免 pipe 吞掉失败）。
- 核心变更：新增 `scripts/qa_alpha.sh`；证据 `.sisyphus/evidence/task-25-qa-alpha.txt`。
- 遗留/约束：不修改计划文件、不新增依赖；required evidence 列表需保持与 DoD 链路绑定，未来改动 e2e/pytest 输出名时需要同步更新脚本。

## [2026-02-15 10:30] - 任务：2.1 引入 durable EventStore（Postgres 表）+ per-device cursor
- 原始需求：WS v1 不再依赖进程内 `_streams`；事件追加与回放落到 Postgres；ACK 支持 per-device cursor（可选 `device_id`，默认 `legacy`）；ACK 后可安全裁剪，且 worker/API 的 `append_typed_event` 必须写入 durable store。
- 实现目标/逻辑：
  - 事件表作为真相：新增 `ws_streams`（保存 `next_seq/trimmed_upto_seq`）、`ws_events`（事件体）、`ws_device_cursors`（per-device last_acked_seq）。
  - seq 分配：在 DB 事务内对 `ws_streams` 行执行 `UPDATE ... SET next_seq = next_seq + 1 RETURNING next_seq - 1` 原子自增，确保跨进程安全。
  - replay：`/ws/v1?save_id=...&resume_from=int` 回放 `seq > max(resume_from, trimmed_upto_seq)` 的事件，按 `seq` 升序；事件帧 `seq>=1` 且 `server_event_id={user_id}:{save_id}:{seq}`。
  - ACK：WS 连接解析可选 `device_id`（默认 `legacy`），ACK 通过 UPSERT + `GREATEST` 单调递增写入 cursor；PONG/HELLO 的 `cursor` 返回该 device 的 last_acked_seq。
  - 裁剪：在同一 `(user_id, save_id)` 上，取当前已知 device cursors 的 `MIN(last_acked_seq)` 作为可裁剪 watermark；推进 `trimmed_upto_seq` 并删除 `ws_events.seq<=watermark`，操作幂等。
- 核心变更：
  - `server/app/ws/event_store.py`：实现 durable append/replay/ack/trim。
  - `server/app/ws/v1.py`：保留 `append_event/append_typed_event/get_events_after` 兼容入口，底层改为调用 durable store，并新增 `device_id` query param 支持。
  - `server/app/db/models.py`：新增 `WsStream/WsEvent/WsDeviceCursor` ORM。
  - `server/alembic/versions/7eed360f132d_ws_event_store.py`：新增迁移（down_revision=`f1dcf9f0abe6`）。
  - `server/tests/test_task_2_1_ws_eventstore.py`：新增测试覆盖多设备 cursor 独立与 ACK 裁剪。
- 验证：`cd server && uv run pytest` 通过；`./scripts/ci.sh` 通过；`server/tests/test_ws_v1_resume.py` 与 `server/tests/test_ws_v1_chat_stream.py` 未回归。
- 遗留/约束：当前“所有 device”以 `ws_device_cursors` 中已出现的 device 集合为准（后续若需要处理僵尸设备/TTL/lease，可在 2.2/后续波次扩展）。

## [2026-02-15 16:10] - 任务：3.1 Auth 限流（register/login/refresh/admin login）
- 原始需求：实现认证相关端点的限流：连续 N 次错误密码后，后续尝试返回 429；窗口过期后恢复；覆盖 user register/login/refresh 与 admin login；补齐 pytest 并保持既有流程不回归。
- 实现目标/逻辑：
  - 共享真相：用 DB 表 `auth_rate_limits` 记录 `(scope, ip, identifier)` 的失败计数与 `reset_at`，确保多进程/多实例一致。
  - 触发规则：仅失败会 `record_failure`（固定窗口计数）；当 `failures >= max_failures` 且 `reset_at > now` 时返回 429，并带 `Retry-After`。
  - 解除锁定：login/refresh/admin login/register 成功后清理对应 key（`reset`）。
  - 配置：新增 settings `auth_rate_limit_enabled/auth_rate_limit_max_failures/auth_rate_limit_window_seconds`。
- 核心变更：
  - `server/app/services/auth_rate_limit.py`：限流 key 生成 + DB 读写（check/record_failure/reset）。
  - `server/app/api/v1/auth.py`、`server/app/api/v1/admin_auth.py`：端点接入 429/401/409 行为。
  - `server/app/db/models.py` + `server/alembic/versions/b0d31c0c7a2e_auth_rate_limits.py`：新增表与迁移。
  - `server/tests/test_task_3_1_auth_rate_limit.py`：覆盖 lockout/expiry/success reset + admin/refresh/register。
- 验证：`cd server && uv run pytest`；`./scripts/ci.sh`。

## [2026-02-15 14:01] - 任务：3.3 Admin 鉴权统一（admin JWT + RBAC 替换 shared secret 审核/上传）
- 原始需求：审核（UGC/插件 approve|reject）与插件上传不再接受 `X-Admin-Secret`，统一改为 `Authorization: Bearer <admin_jwt>`；RBAC：operator 禁止（403），super_admin 允许；审计 actor 统一为 `admin:{admin_id}`；不破坏用户侧 list/download 与 UGC upload/list。
- 实现目标/逻辑：
  - 鉴权：复用 `server/app/api/v1/admin_deps.py` 的 `require_super_admin`，审核/上传端点统一依赖注入校验 admin JWT（typ=admin）与 role。
  - 删除 shared secret：移除 `_require_admin_secret()` 逻辑与路由签名中的 `X-Admin-Secret` header 参数；生产配置不再强制要求 `ADMIN_REVIEW_SECRET`。
  - 审计：审核 approve/reject 以及插件上传写入 `AuditLog.actor="admin:{admin_id}"`。
- 核心变更：
  - `server/app/api/v1/admin_review.py`：审核端点改为 admin JWT + super_admin RBAC；AuditLog.actor 改为 `admin:{id}`。
  - `server/app/api/v1/plugins.py`：插件上传改为 admin JWT + super_admin RBAC；新增上传审计（action=`plugin.upload`）。
  - `server/app/core/config.py`：生产校验移除 `ADMIN_REVIEW_SECRET` 强制要求（shared secret 已废弃）。
  - `server/tests/test_task_20_ugc_approve.py`、`server/tests/test_task_21_plugins.py`、`server/tests/test_task_1_4_prod_config.py`：更新为 admin login 获取 token；增加 operator 403 覆盖。
  - `contracts/openapi.json`、`client/src/gen/openapi.ts`：随 OpenAPI 变更更新（脚本生成）。
- 验证：`cd server && uv run pytest`；`./scripts/ci.sh`。
## [2026-02-15 15:20] - 任务：4.2 记录 LLM usage（token/latency/errors）并纳入 metrics + admin dashboard
- 原始需求：每次 WS `/ws/v1` 的 chat stream 结束后，必须落一条可持久化的 LLM usage 事件（provider/api/model、started/ended、latency、ttft、输出 chunks/chars、interrupted、error、tokens(如可得)）；同时暴露 Prometheus `GET /metrics`；并在 `GET /api/v1/admin/metrics/summary` 增加 24h 聚合（count/error/latency p50/p95/avg、tokens 合计等）；CI 必须离线可跑。
- 实现目标/逻辑：
  - WS v1：在 `_run_chat_stream()` 入口/出口采集 monotonic 时间，首个 token 时计算 TTFT；每个 token 记 chunks/chars；异常仅记 `error`（不强行标记 interrupted），INTERRUPT/断连/取消才记 `interrupted=true`。
  - Provider 元数据：`stream_chat_tokens(..., capture=...)` 传入 capture 容器，OpenAI-compatible SSE 解析时尽力从事件 JSON 的 `usage`（或 `response.usage`）提取 token 计数；chat.completions 路径额外发送 `stream_options.include_usage=true`。
  - 可观测性分层：Prometheus 指标用于实时观测（进程内累加）；admin summary 以 DB 聚合为准，避免多 worker 下指标不一致。
- 核心变更：
  - `server/app/db/models.py`：新增 `LLMUsageEvent`。
  - `server/alembic/versions/e8a4c1b2d3f4_llm_usage_events.py`：创建 `llm_usage_events` 表。
  - `server/app/ws/v1.py`：chat stream 结束后写 usage 行 + 更新 Prometheus 指标。
  - `server/app/metrics/prometheus.py`、`server/app/main.py`：新增 `GET /metrics`（不入 OpenAPI schema）。
  - `server/app/api/v1/admin_metrics.py`：summary 增加 24h usage 聚合字段。
  - `server/tests/test_task_4_2_llm_usage_metrics.py`：新增离线 pytest 覆盖落库 + /metrics + admin summary。
- 遗留/约束：
  - token usage 并非所有 OpenAI-compatible streaming 都会返回；目前做 best-effort 捕获，缺失时保持 NULL/0 合计。
  - Prometheus counters/histograms 为“进程内”语义；多 worker 部署时需用 Prometheus 抓取每个 worker 或引入专用聚合方案。

## [2026-02-15 17:40] - 任务：Wave 5.1 Admin Web：新增 admin-web 骨架（Vite + React + TS）
- 原始需求：新建 `admin-web/`，实现可运行的 admin 后台骨架：路由、登录页、登录后布局（侧边栏/顶部栏）、token 管理与基础 API 客户端封装；受保护路由未登录跳转 `/login`；后端地址通过 `VITE_SERVER_BASE_URL` 配置。
- 实现目标/逻辑：
  - 路由：使用 `react-router-dom`，`/login` 公共页，`/` 及其子路由统一走 `RequireAdminAuth` 守卫；登录成功后跳回 `state.from` 或默认 `/`。
  - Token：使用 `sessionStorage` 保存 `access_token/admin_user_id/role`（不打印到 console）。
  - API：`src/lib/api.ts` 提供 `apiRequestJson`（baseUrl + bearer header + JSON parse + 脱敏错误映射），并提供 `adminLogin()` 封装 `POST /api/v1/admin/auth/login`。
  - 布局与页面：登录后展示运维控制台风格 shell（侧边栏导航 + 顶部栏 + 退出登录）；其余页面先占位，下一任务再接入 feature flags/audit logs 的真实读写。
- 核心变更：
  - 新增目录 `admin-web/`（Vite react-ts 脚手架 + `react-router-dom` 依赖）。
  - `admin-web/src/lib/auth.ts`：sessionStorage token/session 管理。
  - `admin-web/src/lib/api.ts`：baseUrl 来自 `VITE_SERVER_BASE_URL`，统一 fetch/错误映射（不包含 token/响应体）。
  - `admin-web/src/lib/routes.tsx`：路由表 + auth guard + 登录后布局。
  - `admin-web/src/pages/*`：登录页 + Dashboard/FeatureFlags/AuditLogs/Models/Prompts/UGC/Plugins 占位页。
  - `admin-web/src/styles.css`：定义 CSS variables 与基础布局样式（浅色底 + 微网格纹理，避免默认紫色主题）。
- 遗留/约束：
  - 本任务不实现 Feature Flags / Audit Logs 的真实读写；仅做路由/页面占位。
  - 后续 5.1 终验的 Playwright web e2e（登录->改 flags->客户端生效）将在后续子任务落地。

## [2026-02-15 17:51] - 任务：Wave 5.1 Admin Web：Feature Flags 页面可用化 + Dashboard flags 摘要
- 原始需求：在 `admin-web/` 把 Feature Flags 页面从占位升级为可用（登录后可 GET/PUT 后端 `/api/v1/admin/config/feature_flags`），并在 Dashboard 展示 flags 状态摘要（可选 metrics summary）。
- 实现目标/逻辑：
  - API 封装：新增 `adminConfigGetFeatureFlags`/`adminConfigPutFeatureFlags`（snake_case 字段 `plugins_enabled` 保持不变），并新增 `adminMetricsGetSummary`（`/api/v1/admin/metrics/summary`）。
  - 错误脱敏：`apiRequestJson` 在非 2xx 时仅提取并展示后端短 `detail`（限制长度，额外做 bearer/sk 前缀兜底替换），避免任何 token 泄露；仅对 400/422 与 403 追加 detail，其他状态仍用既有通用文案。
  - RBAC：Feature Flags 页面读取 `session.role`；operator 只读并提示“Requires super_admin”，保存按钮 disabled；super_admin 可切换 `plugins_enabled` 并保存。
  - 运维台交互：支持 loading/error/success；dirty/clean 状态（修改后 Save 亮起；可重置回后端值；保存成功提示“已保存”）。
  - Dashboard：新增 cards 展示 `plugins_enabled` 摘要与 metrics 的关键字段（接口失败不阻塞 UI）。
- 核心变更：
  - `admin-web/src/lib/api.ts`：新增 admin config/metrics API；错误 detail 轻量提取（脱敏）。
  - `admin-web/src/pages/FeatureFlagsPage.tsx`：实现真实 GET/PUT + RBAC + dirty/success。
  - `admin-web/src/pages/DashboardPage.tsx`：展示 flags 摘要 + metrics summary。
  - `admin-web/src/styles.css`：补齐开关/徽标/告警/操作条样式。
- 验证：`npm -C admin-web run build`。

## [2026-02-15 21:30] - 任务：计划 5.1 验收：Playwright web e2e（admin-web 改 flags -> Electron 生效）
- 原始需求：新增一个离线可跑的 Playwright e2e：起 stub backend（含 admin-web 登录/feature_flags + Electron 所需最小端点），构建并静态托管 `admin-web`，用真实 Chromium 登录并把 `plugins_enabled` 切到 true 并保存，随后启动 Electron 客户端并验证插件相关 UI/行为与 flags 一致。
- 实现目标/逻辑：
  - Stub backend：`http.createServer` + `listen(0,'127.0.0.1')`，内存态维护 `plugins_enabled`；支持 `POST /api/v1/admin/auth/login`（返回 super_admin token）、`GET/PUT /api/v1/admin/config/feature_flags`（Bearer 校验）、`GET /api/v1/feature_flags`（给 Electron poller 用）、`GET /api/v1/auth/me`（带 Bearer 则返回 user），以及 plugins 最小端点 `GET /api/v1/plugins` 与 `GET /api/v1/plugins/{id}/{version}`（复用 electron-plugin 的 stub 形态）。
  - admin-web 构建：测试内 spawn `npm -C ../admin-web run build` 并注入 `VITE_SERVER_BASE_URL=<stub baseUrl>`；再用简单静态 server 托管 `../admin-web/dist`，并对无扩展名路径 fallback 到 `index.html` 支持 SPA 路由。
  - Web 等待稳健化：避免对隐藏 checkbox 直接 `.check()`；改为点击 `label.switch`；操作前明确等待“与后端一致”出现且 switch input enabled；切换后断言“存在未保存更改”与 Save enabled；保存后断言“已保存”。
  - Electron 验证：复用窗口选择策略（innerWidth 最大的窗口为 debug panel），断言 `TEST_IDS.pluginsCard` 可见，并进一步拉取/安装 approved 插件后等待出现 `TEST_IDS.pluginsMenuItem`（证明远端 `plugins_enabled=true` 已生效，否则菜单项不会出现）。
  - 清理：无论成功失败，关闭 Electron app、静态站 server、stub backend（并 destroy 活跃 sockets，避免 server.close 被 keep-alive 阻塞）。
- 核心变更：
  - `client/playwright/web-admin-feature-flags.spec.ts`
- 遗留/约束：不依赖真实网络/真实后端；测试中不输出 token/响应体到 console。

## [2026-02-15 22:10] - 任务：Wave5.3 Web Admin 部署策略（独立 Nginx/静态站）+ CORS/TrustedHost/安全头
- 原始需求：支持 admin-web 作为独立静态站部署，并在 server 侧加入可测试的 CORS/TrustedHost/安全头；验收要求仅允许受信 origin；TrustedHost 生效；安全头存在；避免 token 落日志；同时提供可复制的 Nginx 配置与部署文档。
- 实现目标/逻辑：
  - FastAPI app 初始化重构为 `create_app()`，便于在 pytest 中通过构造 Settings 重新创建 app，稳定验收 CORS/TrustedHost 行为。
  - 默认不锁死 dev：`CORS_ALLOWED_ORIGINS`/`TRUSTED_HOSTS` 为空列表时不启用对应中间件；显式配置时才收紧。
  - 安全头在应用层统一添加（对所有 HTTP 响应生效），Nginx 示例再做一层边界兜底。
  - 日志：不新增任何打印 Authorization/token 的逻辑，继续依赖 `server/app/core/logging.py` 的 Bearer/OAuth token 脱敏。
- 核心变更：
  - `server/app/main.py`：新增 `create_app()`，按 Settings 注入 CORSMiddleware/TrustedHostMiddleware，并统一添加安全头与 X-Request-Id。
  - `server/app/core/config.py`：新增 `cors_allowed_origins`/`trusted_hosts`（支持 JSON 数组或逗号分隔字符串）。
  - `server/tests/test_task_5_3_admin_web_deploy_security.py`：新增离线 pytest 验收（CORS allowlist + 预检 + 安全头 + TrustedHost）。
  - `deploy/nginx/admin-web.conf`：新增 admin-web 静态站点部署示例（SPA fallback + 安全头 + 可选反代 /api 与 /ws）。
  - `docs/admin-web-deploy.md`：新增 build/部署说明与两种方案（同源反代 vs 跨域 + allowlist）。
- 验证（预期）：`./scripts/generate-contracts.sh --check`、`cd server && uv run pytest`、`npm -C admin-web run build`、`./scripts/ci.sh`。

## [2026-02-15 20:26] - 任务：Wave6.1 Electron 导航/外链 allowlist + 权限默认拒绝
- 原始需求：修复 Electron `setWindowOpenHandler` “永远 deny 但仍无条件 `shell.openExternal(url)`” 的安全问题；为 mainWindow/petWindow 增加导航拦截（`will-navigate`/`will-frame-navigate`）与权限默认拒绝；并新增离线 Playwright e2e 验收（`window.open` 试图打开 `javascript:`/`file:`/非白名单 `https` 均被 deny），产出固定证据文件。
- 实现目标/逻辑：
  - 外链：使用 `new URL(url)` 严格解析，仅允许 `http/https` 且 `origin/host` 命中 allowlist（env：`PARA_EXTERNAL_OPEN_ORIGINS`/`PARA_EXTERNAL_OPEN_HOSTS`）；默认 allowlist 为空 => 全部拒绝。
  - 导航：对所有窗口注册 `will-navigate`/`will-frame-navigate`，仅允许 `file://`（生产）与 dev server origin（开发）内导航，其余一律 `preventDefault()`。
  - 权限：`session.defaultSession.setPermissionRequestHandler` 默认拒绝所有 permission requests。
- 核心变更：
  - `client/src/main/index.ts`（外链 allowlist + 导航拦截 + 权限默认拒绝；同时应用到 mainWindow/petWindow）
  - `client/playwright/electron-security-navigation.spec.ts`（离线 e2e：window.open 拒绝 + monkeypatch shell.openExternal 断言未调用 + 写 evidence）
  - `.sisyphus/evidence/task-6-1-navigation-deny.txt`（e2e 落盘证据）
- 验证：`npm -C client run e2e -- playwright/electron-security-navigation.spec.ts`、`./scripts/ci.sh`。
- 遗留/约束：`will-frame-navigate` 在当前 Electron typings 中未被声明为可用事件名，已在 TS 侧对事件名做最小 `as any` 适配（运行时事件仍有效）。

## [2026-02-15 20:32] - 任务：Wave6.1 修正：收紧 file:// 导航到 dist/renderer
- 原始需求：code review 发现 `file:` 在 `will-navigate` 默认放行会导致 renderer 通过 `window.location='file:///etc/passwd'` 导航到任意本机文件，不符合 6.1 的“导航 allowlist”。
- 实现目标/逻辑：
  - `file://` 仅允许落在 `path.join(__dirname,'..','renderer')`（运行时即 `dist/renderer`）目录内的文件；其余一律拦截。
  - http/https 仍仅允许 dev server origin。
  - e2e 增加 `window.location.href` 的 deny 用例，断言 href 不变、无新窗口、无 openExternal，并写入同一 evidence 文件。
- 核心变更：
  - `client/src/main/index.ts`（`file:` 路径目录边界校验：`fileURLToPath` + `path.relative`）
  - `client/playwright/electron-security-navigation.spec.ts`（新增 navigate deny 两用例 + evidence 行扩展）
- 验证：`npm -C client run e2e -- playwright/electron-security-navigation.spec.ts`、`./scripts/ci.sh`。

## [2026-02-15 20:40] - 任务：Wave6.1 状态对齐（计划勾选 + 复验）
- 原始需求：将计划文件 Wave6 的 6.1 勾选为完成，并在 `.ai_session.md` 追加完成记录；离线复跑 E2E 作为验收证据。
- 实现目标/逻辑：
  - 不改任何业务/测试代码，仅对齐“计划执行状态”与“实际已实现/已验收”的状态。
  - 复跑 Electron Playwright E2E 确认 6.1 行为未回归，并确保证据文件路径存在。
- 验收/证据：
  - 命令：`npm -C client run e2e -- playwright/electron-security-navigation.spec.ts`（pass）
  - 证据：`.sisyphus/evidence/task-6-1-navigation-deny.txt`
- 核心变更：
  - `.sisyphus/plans/ai-girlfriend-desktop-pet-beta-hardening.md`（6.1 勾选为完成）
  - `.ai_session.md`（追加本记录）
- 遗留/约束：本次不改 `client/src/main/index.ts` 或任何 TS/py 源码；仅更新计划与会话记录。

## [2026-02-15 21:05] - 任务：Wave6.2 Electron sandbox + webPreferences 硬化
- 原始需求：在生产/测试路径启用 Electron sandbox（尽早 `app.enableSandbox()`，并在所有窗口显式设置 `webPreferences` 安全基线），同时不破坏 Wave6.1 已有的导航/外链 allowlist 与 permission deny 基线；不改 server，不新增依赖。
- 实现目标/逻辑：
  - 启用时机：`app.enableSandbox()` 必须在 `app.whenReady()` 之前调用，否则已初始化的 renderer 进程无法进入 sandbox；因此在主进程文件顶层尽早调用作为全局兜底。
  - 窗口显式基线：对 `createMainWindow/createPetWindow` 的 `BrowserWindow.webPreferences` 显式设置：
    - `contextIsolation: true`
    - `nodeIntegration: false`
    - `sandbox: true`
    - `preload` 保持原值
    - 并补充硬化项：`webviewTag: false`、`spellcheck: false`、`navigateOnDragDrop: false`、`webSecurity: true`、`allowRunningInsecureContent: false`。
  - DevTools 策略：`devTools` 仅在 `VITE_DEV_SERVER_URL` 存在时启用（开发调试用）；生产/测试路径显式关闭。
  - 测试辅助（仅 test）：在 `NODE_ENV=test` 时为每个窗口挂载 `webContents` 诊断事件（console-message/render-process-gone/preload-error），用于 sandbox 引入后快速定位 renderer/preload 崩溃（不放宽安全开关）。
- 核心变更：
  - `client/src/main/index.ts`：新增 `app.enableSandbox()`；硬化 main/pet 两个窗口的 `webPreferences`；保留 Wave6.1 的 `setupDefaultDenyPermissions()` 与 `applyNavigationAndExternalGuards()` 行为不变。
  - `client/playwright/electron-security-navigation.spec.ts`：补充断言 `app.isSandboxed()` 与窗口 `getLastWebPreferences()` 的安全基线（用于防回归）。
  - `.sisyphus/plans/ai-girlfriend-desktop-pet-beta-hardening.md`：勾选 6.2。
- 验收口径：
  - 你侧执行：`npm -C client run e2e`、`./scripts/ci.sh`
  - 备注：本会话中曾尝试运行 `npm -C client run e2e`，但多用例出现 timeout；已补充更强的安全断言与 test-only 诊断输出，便于你复跑时定位具体失败点。

- Linux(root) 兼容性补充（E2E 全绿所需）：
  - 背景：Chromium 在 Linux root 下通常会拒绝启用其进程级 sandbox（user namespace / setuid sandbox 等限制），常见表现是 Electron/Chromium 启动失败或卡住，导致 Playwright `electron.launch(...)` 全部超时。
  - 策略：引入 `shouldEnableSandbox()`：默认 Windows/非 root Linux 启用；Linux 且 `uid==0` 默认禁用；并支持 `PARA_FORCE_SANDBOX=1`/`PARA_DISABLE_SANDBOX=1` 显式覆盖。
  - 同步：`app.enableSandbox()` 与 `webPreferences.sandbox` 均跟随该策略，避免一边开一边关；当策略禁用且平台为 Linux 时，追加 Chromium 启动开关 `--no-sandbox --disable-setuid-sandbox` 以确保 root 环境可启动。
  - 安全权衡：Linux root 的 E2E 环境属于 CI/测试运行态，为保证可跑选择禁用；Windows 生产/打包路径仍按默认策略启用 sandbox，并保持 webPreferences 硬化项不变。

## [2026-02-15 22:05] - 任务：Wave6.3 IPC sender 校验（拒绝非受信 frame 调用 invoke）
- 原始需求：所有 `ipcMain.handle` 必须校验调用来源 `event.senderFrame.url` 属于 allowlist；任何来自非受信 frame 的 `ipcRenderer.invoke` 一律拒绝并抛出稳定错误码 `UNTRUSTED_IPC_SENDER`；allowlist 与 Wave6.1 导航 allowlist 对齐（file 仅 dist/renderer 内，http/https 仅 dev server origin）。
- 实现目标/逻辑：
  - 集中式校验：新增 `assertTrustedIpcSender(event)`，优先使用 `event.senderFrame?.url`，必要时 fallback `event.sender.getURL()`。
  - allowlist 复用：复用 Wave6.1 的 `isSafeForAppNavigation` 与 `isFileUrlInsideRendererDist` 逻辑；仅允许 `file:`（且必须落在 `dist/renderer` 目录边界内）或 `http/https`（且 origin==`VITE_DEV_SERVER_URL`）；`about:`/`data:` 等协议天然不在 allowlist 内，直接拒绝。
  - URL query/hash 兼容：为避免 `file://.../index.html?window=pet` 被误判或在 `fileURLToPath` 抛错，`isFileUrlInsideRendererDist` 在做 `fileURLToPath` 前会清空 `search/hash`。
  - 覆盖方式：封装 `handleTrustedIpc(channel, handler)` wrapper，内部统一执行 `assertTrustedIpcSender`，并将文件内所有业务 `ipcMain.handle(...)` 注册替换为 `handleTrustedIpc(...)`，避免漏掉未来新增通道。
- 核心变更：
  - `client/src/main/index.ts`：新增 `assertTrustedIpcSender`/`handleTrustedIpc` 与 allowlist 复用函数，并替换所有 IPC handle 注册点。
  - `client/playwright/electron-security-navigation.spec.ts`：新增 6.3 E2E：创建 `data:` 非受信窗口并尝试调用 `desktopApi.ping()`，断言被拒绝且错误包含 `UNTRUSTED_IPC_SENDER`。
- 验收口径：
  - `npm -C client run e2e`
  - `./scripts/ci.sh`

- 修正说明（E2E 载体选择）：
  - `desktopApi.ping()` 在 preload 中是直接返回字符串，不会触发 `ipcRenderer.invoke`，无法覆盖 senderFrame allowlist。
  - Wave6.3 的 E2E 已改为调用 `desktopApi.plugins.getStatus()`（对应 `ipcRenderer.invoke('plugins:getStatus')`），从而在 trusted/untrusted 场景下真实验证 IPC sender 校验。

## [2026-02-15 22:30] - 任务：Wave6.4 token 落盘策略（生产环境禁止明文 fallback）
- 原始需求：当“需要强制安全落盘”（生产/打包态，或 e2e 显式开启）且 `safeStorage` 不可用/不安全（含 Linux `basic_text` 后端）时：登录必须失败、不得写入明文 token 文件；renderer 侧要有明确提示；同时不破坏默认 dev/test/e2e 的既有行为。
- 实现目标/逻辑：
  - main 端新增策略函数 `shouldEnforceSecureTokenStorage()`：默认仅 `app.isPackaged===true` 强制；并允许 `PARA_ENFORCE_SECURE_TOKEN_STORAGE=1` 在 test/e2e 显式开启。
  - main 端新增可用性判断 `isSecureTokenStorageAvailable()`：要求 `safeStorage.isEncryptionAvailable()==true`；若存在 `safeStorage.getSelectedStorageBackend()` 且返回 `basic_text` 视为不可用；仅在 `NODE_ENV=test` 时允许 `PARA_TEST_DISABLE_SAFE_STORAGE=1` 强制返回 false 以稳定覆盖测试。
  - 写入策略：`writeAuthTokensToDisk()` 在“强制 + 不可用”时先清理 `auth.tokens.json` 再抛出稳定错误码 `SAFE_STORAGE_UNAVAILABLE`，禁止任何明文 fallback。
  - 读取策略：`readAuthTokensFromDisk()` 若读到 `secure:false` 且处于强制模式，则删除文件并返回 null，避免生产继续使用历史明文残留。
- UI 文案：renderer 的 `toReadableLoginError()` 增加 `SAFE_STORAGE_UNAVAILABLE` 的中文提示（说明本机安全存储不可用、已禁止明文保存 token，并给出修复建议）。
- E2E 覆盖：新增 Electron 登录用例：启动时设置 `NODE_ENV=test` + `PARA_ENFORCE_SECURE_TOKEN_STORAGE=1` + `PARA_TEST_DISABLE_SAFE_STORAGE=1`，断言页面出现提示且 `auth.tokens.json` 不存在；证据截图输出 `.sisyphus/evidence/task-6-4-token-storage.png`。
- 核心变更：
  - `client/src/main/index.ts`
  - `client/src/renderer/app/App.tsx`
  - `client/playwright/electron-login.spec.ts`
  - `.sisyphus/plans/ai-girlfriend-desktop-pet-beta-hardening.md`（勾选 6.4）
  - 证据：`.sisyphus/evidence/task-6-4-token-storage.png`
- 验收（本机已通过）：
  - `npm -C client run e2e`（ALL GREEN）
  - `./scripts/ci.sh`（ALL GREEN）

## [2026-02-15 23:10] - 任务：Wave6.5 通信加密（应用层，envelope v1）
- 原始需求：实现可灰度开启的客户端-服务端 JSON 通信加密解密（AES-256-GCM），协议严格按 envelope v1 与 AAD 规范；服务端含最小防重放；默认关闭不影响现有 CI/E2E。
- 实现目标/逻辑：
  - Opt-in：Server 仅当 `PARA_APPENC_ENABLED=1` 时启用中间件；Client 仅当 `PARA_APPENC_ENABLED=1` 时对 JSON 请求启用 envelope。
  - 协议头：请求体为 envelope 时带 `X-Para-Enc: v1`；客户端希望响应也加密则带 `X-Para-Enc-Resp: v1`；服务端返回 envelope 时回 `X-Para-Enc: v1`。
  - Envelope v1 字段：`v=1, typ=req|resp, alg=A256GCM, kid, ts(unix秒), rid(base64url 16B), nonce(base64url 12B), ct(base64url(ciphertext||tag16B))`。
  - AAD（UTF-8，字段顺序固定）：
    - req：`para-appenc-v1\ntyp=req\nkid=...\nts=...\nrid=...\nmethod=...\npath=...\nquery=...`
    - resp：`para-appenc-v1\ntyp=resp\nkid=...\nts=...\nrid=...\nstatus=...`
    - query 一致性：Server 侧使用 ASGI scope 的原始 `query_string`（latin-1 decode）构造 AAD。
  - Key rotation：`PARA_APPENC_KEYS` 支持多 `kid`；解密按 envelope 的 `kid` 查找；加密输出使用 keyring 的第一个 `kid` 作为 primary。
  - 防重放（最小实现）：Server 进程内 TTL map 去重 key=`(kid,rid)`，重复返回 409 明文 `{detail:"PARA_APPENC_REPLAY"}`；限制：多进程/多实例之间不共享。
  - 响应加密：仅当请求已成功解密且请求头带 `X-Para-Enc-Resp: v1` 时才会加密 JSON 响应；错误响应（解密失败/重放）始终明文 JSON。
- 核心变更：
  - Server：`server/app/middleware/app_encryption.py` 新增 envelope v1 middleware；`server/app/core/config.py` 新增 env/settings；`server/app/main.py` 插入 middleware；`server/tests/test_task_6_5_app_encryption.py` 新增 pytest 覆盖。
  - Client：`client/src/main/index.ts` 仅修改 `fetchAuthedJson`，对 JSON string body 做 envelope 请求加密，并在响应头 `X-Para-Enc: v1` 时解密。
- 验收命令：`cd server && uv run pytest -k task_6_5`
- 验收（本机）：`cd server && uv run pytest -k task_6_5 -vv`（3 passed）
- 遗留/约束：multipart/二进制下载不走加密；防重放为进程内最小实现。

## [2026-02-15 23:40] - 任务：Wave6.6 状态对齐：反调试/反编译（Electron fuses + asar 完整性）
- 采用的打包工具：electron-builder
- 关键配置：`asar: true`、`afterPack` hook（`client/scripts/afterPack-fuses.cjs`）
- fuses（逐项：NODE_OPTIONS/inspect/runAsNode/OnlyLoadAppFromAsar/EmbeddedAsarIntegrityValidation）：
  - NODE_OPTIONS：禁用（DisableNodeOptionsEnv）
  - inspect：禁用（DisableNodeCliInspectArguments）
  - runAsNode：禁用（DisableRunAsNode）
  - OnlyLoadAppFromAsar：启用
  - EmbeddedAsarIntegrityValidation：启用
- 验收命令与结果（Linux）：
  - `npm -C client run package:linux`
  - `node client/scripts/verify-fuses.js --exe client/dist-electron/linux-unpacked/ai-girlfriend-client`（PASS）
  - `npm -C client run e2e`（ALL GREEN）
  - `./scripts/ci.sh`（ALL GREEN）
- 局限/备注：Windows 产物仍需在 Windows runner/环境验证；但配置已按跨平台路径处理，Linux 验证覆盖 `linux-unpacked` 产物。

## [2026-02-15 23:55] - 任务：Wave7.1 Windows 打包（electron-builder）+ 可选代码签名 + CI artifacts
- 原始需求：补齐 Windows 下 electron-builder 打包与 GitHub Actions Windows CI 产物上传；代码签名为可选（提供证书则签名，否则不阻塞构建）。
- 实现目标/逻辑：
  - 打包：在 `client/package.json` 的 electron-builder 配置中新增 `win.target`（至少 `nsis`，同时增加 `dir` 便于 smoke），并补齐必需元数据 `appId/productName`。
  - 安装包：NSIS 配置采用“非 oneClick + 允许改安装目录”，减少测试/内测阶段摩擦。
  - 签名：使用 electron-builder 默认签名机制；仅当 CI secrets 提供 `CSC_LINK` 时注入签名环境变量；未提供时正常构建并产出 artifacts。
  - CI：新增 Windows workflow（`windows-latest` + Node 20），执行 `npm -C client ci` 后运行 `npm -C client run package:win`，并上传 `client/dist-electron/**`。
- 关键配置（本次选定值）：
  - `appId`: `com.pscly.para`
  - `productName`: `Para Desktop`
  - 产物目录：`client/dist-electron/`
  - 构建命令：`npm -C client run package:win`（NSIS）、`npm -C client run package:win:dir`（unpacked）
- 代码签名 secrets（可选）：
  - `CSC_LINK`（证书来源：常见为 base64 的 `.p12/.pfx` 或可下载 URL）
  - `CSC_KEY_PASSWORD`（证书密码，如有）
- 核心变更：
  - `client/package.json`
  - `.github/workflows/windows-build.yml`
  - `docs/windows-packaging.md`
  - `.sisyphus/plans/ai-girlfriend-desktop-pet-beta-hardening.md`（勾选 7.1）
- 遗留/约束：本波次不实现自动更新（Wave7.2）；不改动已有 Wave6.x 安全基线逻辑。

## [2026-02-16] - 任务：Wave7.2 自动更新策略（Windows）+ 回滚方案
- 原始需求：在 Windows 打包版默认启用自动更新；提供 check->available->download progress->downloaded->install（quitAndInstall）链路；提供回滚方案（推荐回滚 + 受控 allowDowngrade）；IPC 必须走 `handleTrustedIpc` + sender allowlist；测试必须离线稳定（允许 fake updater）。
- 实现目标/逻辑：
  - 主进程新增 UpdateManager：生产使用 `electron-updater`（generic provider，可选由 `PARA_UPDATES_URL` 运行时注入），开发/测试默认不触发真实更新；E2E/CI 默认走 fake updater。
  - 安全：更新相关 IPC 全部通过 `handleTrustedIpc()` 注册；更新状态通过 `safeSendToAllRenderers()` 广播，renderer 只展示与触发。
  - 回滚：默认推荐“发布更高 patch 但回退代码”；仅在测试/紧急场景通过 `PARA_UPDATES_ALLOW_DOWNGRADE=1` 受控开启降级。
- 核心变更：
  - `client/src/main/updateManager.ts`
  - `client/src/main/index.ts`
  - `client/src/preload/index.ts`
  - `client/src/renderer/app/App.tsx`
  - `client/src/renderer/app/testIds.ts`
  - `client/package.json`（新增 `electron-updater` 依赖与 publish 占位）
  - `docs/windows-updates.md`
  - `client/playwright/electron-update-rollback.spec.ts`（离线稳定 fake updater 验收）
  - `.sisyphus/evidence/task-7-2-update-rollback.txt`
- 验收命令：
  - `./scripts/ci.sh`
  - `npm -C client test`
  - `npm -C client run e2e -- electron-update-rollback.spec.ts`

## [2026-02-16 01:02] - 任务：Beta Hardening Success Criteria 勾选更新（基于已通过自动化验收）
- 原始需求：更新计划文件 `.sisyphus/plans/ai-girlfriend-desktop-pet-beta-hardening.md` 的 Success Criteria，把已通过自动化验收的条目从 `- [ ]` 改为 `- [x]`，并保持插件沙箱（292）与 Wave 8（Future）未完成。
- 验收（主会话已通过）：
  - `./scripts/qa_beta.sh` -> `.sisyphus/evidence/task-beta-ws-multiproc.txt`
  - `./scripts/ci.sh`
  - `npm -C admin-web run build`
  - `npm -C client run e2e -- web-admin-feature-flags.spec.ts`
  - `npm -C client run verify:fuses:linux`
- 备注/约束：插件“真正沙箱”仍未落地（当前仍是 `node:vm` + 子进程），因此 Success Criteria 292 保持未勾选。

## [2026-02-16 02:10] - 任务：Wave8.1 macOS：签名 + notarization + 更新
- 原始需求：补齐 macOS 打包/签名/公证（notarization）与更新链路：electron-builder 增加 mac target（dmg+zip），新增 macOS GitHub Actions 构建并上传 artifacts，签名与 notarization 必须可选（仅当 secrets 存在时启用）；同时让 packaged 的 macOS 默认启用更新模块（与 Windows 一致），并保持离线 fake updater E2E 稳定。
- 实现目标/逻辑：
  - 打包：`client/package.json` 增加 `mac.target`（`dmg` + `zip`）与必要元信息（`category`、`hardenedRuntime`、entitlements 占位）。
  - CI：新增 `.github/workflows/macos-build.yml`（`macos-latest` + Node 20），产出 `client/dist-electron/**` 并上传 artifacts。
  - 可选签名：仅当 secrets 提供 `CSC_LINK` 时注入 `CSC_LINK/CSC_KEY_PASSWORD`；否则设置 `CSC_IDENTITY_AUTO_DISCOVERY=false` 避免 CI 在无 identity 时失败。
  - 可选 notarization：仅当同时存在签名证书与 Apple notarization secrets 时注入 `APPLE_*` 环境变量，electron-builder 会自动触发 notarization（notarytool）。
  - 更新：`client/src/main/updateManager.ts` 默认启用从 `win32` 扩展到 `win32 + darwin`（仅 `app.isPackaged`）。
- 核心变更：
  - `client/package.json`
  - `client/build/entitlements.mac.plist`
  - `client/build/entitlements.mac.inherit.plist`
  - `.github/workflows/macos-build.yml`
  - `client/src/main/updateManager.ts`
  - `client/src/renderer/app/App.tsx`（标题文案泛化，不影响 testid）
  - `docs/macos-packaging.md`
  - `docs/macos-updates.md`
  - `.sisyphus/plans/ai-girlfriend-desktop-pet-beta-hardening.md`（勾选 8.1）
- 验收命令：
  - `npm -C client run lint`
  - `npm -C client test`
  - `./scripts/ci.sh`

## [2026-02-16 16:00] - 任务：Task 7（Nginx：para.pscly.cc HTTPS 反代 /api /ws /admin）
- 原始需求：为 `para.pscly.cc` 提供 aaPanel 风格 Nginx vhost：80 跳转 https；443 ssl http2；证书使用 `/root/ssl/pscly.cc.pem` + `/root/ssl/pscly.cc.key`；并把 `/api/`、`/ws/`、`/admin/`、`/assets/` 反代到本机回环端口（生产 compose 默认 `18080/18081`）。同时修复 admin-web 前端路由，使其既能在根路径通过 Playwright 测试，也能在生产 `/admin` 子路径下正常工作。
- 实现目标/逻辑：
  - vhost：新增 `deploy/nginx/para.pscly.cc.conf`（80->443 重定向；/api 与 /ws 反代到 `127.0.0.1:18080`；/ws 增加 Upgrade/Connection；/admin 反代到 `127.0.0.1:18081/` 以剥离前缀；/assets 额外反代到 `127.0.0.1:18081/assets/` 兼容 Vite 默认绝对资源路径）。
  - admin-web：在 `admin-web/src/lib/routes.tsx` 运行时根据 `window.location.pathname` 推导 `basename`（`/admin` 或 `/`），并使用 `createBrowserRouter(routes, { basename })`，保证同一套构建在两种部署形态下可复用。
- 核心变更：`deploy/nginx/para.pscly.cc.conf`、`admin-web/src/lib/routes.tsx`、`deploy/prod/README.md`。
- 遗留/约束：不引入新依赖；不在仓库写入任何真实证书/密钥/内网凭据；生产仍假设 API/admin-web 仅绑定回环端口并由外层 Nginx 提供对外入口。

## [2026-02-16 14:23] - 任务：Task 6 修复（Health：worker timeout 假阴性 + prod compose healthcheck timeout）
- 原始需求：修复线上 `GET /api/v1/health` 持续 degraded（`worker.status=error, detail=timeout`），并补齐/修正生产 compose 的健康检查超时，确保 `./scripts/ci.sh` 全绿。
- 根因：`server/app/api/v1/health.py` 的 `_check_worker()` 通过 `_call_with_timeout(ThreadPoolExecutor)` 包裹 `celery.control.ping(timeout=HEALTH_TIMEOUT_S)`，并在外层再次 `fut.result(timeout=HEALTH_TIMEOUT_S)` 施加同预算硬超时；当 ping 接近超时边界时，会产生 `latency≈HEALTH_TIMEOUT_S+ε` 的 Future timeout 假阴性（即使在容器内直接 `celery_app.control.ping(timeout=5)` 有 replies）。
- 修复：worker 探活改为在当前线程直接调用 `celery.control.ping(timeout=timeout_s)`，仅依赖 celery 自带 timeout；新增回归测试通过 monkeypatch `_call_with_timeout` 抛错来确保未来不会回退到线程池封装。
- Compose：`deploy/prod/docker-compose.yml` 的 api healthcheck 不再硬编码 `urllib timeout=2`，默认与 `HEALTH_TIMEOUT_S` 联动（`max(5s, HEALTH_TIMEOUT_S*4)`），并把 docker healthcheck `timeout` 放宽到 `30s`；同时允许用 `API_HEALTHCHECK_TIMEOUT_S` 覆盖。
- 核心变更：`server/app/api/v1/health.py`、`server/tests/test_health.py`、`deploy/prod/docker-compose.yml`。
- 验证：`./scripts/ci.sh` 全绿。

## [2026-02-16 14:45] - 任务：Task 8（自动部署：ci(main) 成功后 SSH 部署到 pscly.cc）
- 原始需求：push main 后，当 workflow `ci` run 成功时触发 deploy；使用 `secrets.SSHKEY` 连接 `root@pscly.cc`，将代码部署到 `/root/dockers/para/app/`（不覆盖 `/root/dockers/para/data/` 与 `/root/dockers/para/.env`）；远端显式 `--env-file /root/dockers/para/.env` 运行 migrate + `docker compose up -d --build --remove-orphans`；对 `https://para.pscly.cc/api/v1/health` 做 smoke 并断言 `status==ok`；部署失败尽量回滚到上一版目录。
- 实现目标/逻辑：
  - 触发：`.github/workflows/deploy.yml` 使用 `workflow_run` 监听 `workflows: ["ci"]` 的 `completed`；仅当 `head_branch==main` 且 `conclusion==success` 执行。
  - 版本一致性：`actions/checkout` 显式 `ref: ${{ github.event.workflow_run.head_sha }}`，确保部署的就是通过 gate 的那一次提交。
  - 同步策略：runner 侧打包 tarball（`release-<sha>.tgz`），上传到 `/root/dockers/para/releases/<sha>.tgz`；远端解压到 `app_new/` 后再原子切换目录到 `app/`，避免误删/覆盖 `.env` 与 `data/`。
  - compose 执行：远端脚本统一使用 `docker compose --env-file /root/dockers/para/.env -f /root/dockers/para/app/deploy/prod/docker-compose.yml -p para`；先跑 `--profile migrate run --rm migrate` 再 `up -d --build --remove-orphans`。
  - smoke：远端使用 `curl -fsS` 获取 health JSON，并用 `python3` 解析断言 `status==ok`（带重试等待启动）。
  - 最小回滚：远端失败时切回 `app_prev/` 并尝试 `docker compose up -d --build --remove-orphans` 恢复上一版（不执行 down、不删除数据卷）。
- 核心变更：`.github/workflows/deploy.yml`（新增）、`deploy/prod/remote_deploy.sh`（新增）。
- 遗留/约束：部署流程不写入任何真实 secrets；workflow 日志不得输出 key 或 `.env` 内容；必须显式 `--env-file` 规避 docker compose 的 `.env` 目录歧义。

## [2026-02-16 17:33] - 任务：Task 8 已通过 GitHub Actions 真实绿灯（补记证据并在计划中勾选完成）
- 原始需求：Task 8 已在 GitHub Actions 上完成一次真实的“CI -> deploy”绿灯链路，需要将计划文件 Task 8 勾选完成，并把 deploy/CI 的 run id 作为证据写入 notepad 与 `.ai_session.md`。
- 实现目标/逻辑：仅做“记录与验收证据入档”的最小增量修改：计划中 Task 8 从未完成改为完成，并在任务条目下追加一行证据；notepad 与 `.ai_session.md` 追加新条目，不覆盖历史内容。
- 证据：deploy run id `22057246419` 成功（remote deploy + public smoke OK）；该 deploy 由 CI run id `22057202610` 成功触发。
- 核心变更：`.sisyphus/plans/para-completion.md`、`.sisyphus/notepads/para-completion/learnings.md`、`.ai_session.md`。
- 遗留/约束：不写入任何 secrets（不记录 SSHKEY 内容/不记录 `.env`），仅保留 run id 级别的可公开证据。

## [2026-02-16 20:20] - 任务：Task 13（Windows NSIS：数据目录选择 + 配置写入 + silent 验证）
- 原始需求：Windows NSIS 安装器新增“数据目录选择”，将选择结果写入稳定配置；同时支持 silent 参数指定数据目录；应用启动时读取该配置并作为 Electron `userData` 根路径。
- 实现目标/逻辑：
  - NSIS：通过 electron-builder `build.nsis.include` 引入自定义脚本 `scripts/installer-para-data-dir.nsh`。
    - UI：在安装目录选择后插入“数据目录（userData 根路径）”选择页。
    - silent：新增参数 `/DATA_DIR=...`（配合 `/S`；安装目录仍用 NSIS `/D=...`，且 `/D=` 必须放在最后）。
    - 写入：安装完成写入 `%APPDATA%\\Para Desktop\\para.config.json`（字段 `userDataDir`）并创建 data dir 子目录 `logs/cache/plugins`，便于 CI 纯文件断言。
  - App：启动时按优先级 `env(PARA_USER_DATA_DIR)` > `installer config(userDataDir)` > `Electron 默认` 选择 userData，并在 `app.setPath('userData', ...)` 之前生效。
  - Release：`.github/workflows/release.yml` 的 `windows-nsis` job 增加 silent 安装验证：临时 install dir + 临时 data dir，断言配置文件与目录结构，然后清理。
- 核心变更：`client/package.json`、`client/scripts/installer-para-data-dir.nsh`、`client/src/main/index.ts`、`client/src/main/installerConfig.ts`、`.github/workflows/release.yml`。
- 遗留/约束：不引入新 npm 依赖；不写入任何真实凭据；本任务只完成“安装器选择/写入 + 启动读取”，迁移/回滚逻辑留给后续 Task 14。

## [2026-02-16 20:45] - 任务：Task 13（补记：NSIS 脚本健壮性）
- 实现补丁：`client/scripts/installer-para-data-dir.nsh` 显式 `!include "FileFunc.nsh"`，并在 update（`isUpdated`）场景下默认不覆写既有配置，除非用户显式指定 `/DATA_DIR=...` 或在 UI 页确认数据目录。
- 目的：减少 electron-builder 模板差异导致的打包漂移；避免“更新安装误重置数据目录”的潜在回归。

## [2026-02-16 21:01] - 任务：Task 14（应用内迁移 userData 目录 + e2e 验收）
- 原始需求：在 Task 13 已实现“安装器写入 appData 下的 `para.config.json` 并在 very-early 阶段读取以决定 `app.setPath('userData', ...)`”的前提上，新增“应用内迁移 userData 目录”：当用户从旧版本升级/或历史数据仍在 Electron 默认 userData 目录时，应用启动应自动把旧 userData 迁移到目标数据目录；同时补齐离线可重复的 e2e 验收。
- 实现目标/逻辑：
  - 配置真相来源保持不变：installer config 位于 appData（`Para Desktop/para.config.json`），启动 very-early 读取并决定 userData 根路径。
  - 迁移策略以“可恢复 + 尽量原子”为核心：迁移时先落到临时目录（tmp dir），完成后再通过 rename/替换把目录切换到最终位置；配置写入使用“临时文件 + rename”的原子写方式，避免崩溃/断电造成半写 JSON。
  - 幂等与安全边界：若目标目录已是当前 userData 或已迁移完成则不重复迁移；迁移只处理受控的 userData 目录边界，不做跨范围的任意路径移动。
  - e2e 采用“两阶段启动验证”：第一次启动构造“旧 userData 存在”的初始态并触发迁移；第二次启动验证新 userData 被正确采用且迁移逻辑不再触发（幂等）。
- 核心变更（关键路径必须准确）：
  - `client/src/main/index.ts`
  - `client/src/main/installerConfig.ts`
  - `client/src/preload/index.ts`
  - `client/src/renderer/app/App.tsx`
  - `client/src/renderer/app/testIds.ts`
  - `client/src/renderer/vite-env.d.ts`
  - `client/playwright/electron-userdata-migration.spec.ts`
- 验收（已跑通）：
  - `npm -C client run e2e -- electron-userdata-migration.spec.ts`
  - `./scripts/ci.sh`
- 遗留/约束：仅在客户端侧实现与验证（不触碰 `server/**`）；仓库中禁止写入任何密钥/token/内网地址；迁移必须保持 very-early 执行窗口，避免在 renderer/业务逻辑启动后再改动 userData 根路径。

## [2026-02-16 21:07] - 任务：Task 14（补记/更正：迁移为应用内手动触发）
- 更正原因：此前 Task 14 条目将迁移描述为“启动时自动迁移/very-early 自动搬运”，与实际代码行为不一致，容易误导读者。
- 真实行为（以最终实现为准）：
  - 迁移由 renderer 的“数据目录（userData）”卡片在 UI 中手动触发；用户选择/输入新路径后点击“迁移并写入配置”。
  - renderer 通过 IPC `userdata:migrate` 请求主进程执行迁移（搬运 userData 目录数据）。
  - 迁移成功后，主进程在 appData 下写入 `para.config.json`（记录新的 userData 路径配置）；UI 随后提示“需要重启”。
  - “一键重启”通过 IPC `app:relaunch` 触发应用重启；重启后主进程启动阶段读取 appData 下的 `para.config.json`，并在 very-early 阶段设置 `app.setPath('userData', ...)`，新目录因此生效。
- 非目标/不发生的行为：本次实现不包含“启动时自动迁移”，也不会在无用户操作的 very-early 阶段自动搬运旧目录。

## [2026-02-16 21:30] - Task: 15 (Desktop BYOK chat-only direct provider; no server persistence)
- Evidence observed in this session:
  - `npm -C client run e2e -- electron-byok-chat.spec.ts` -> 1 passed
  - `./scripts/scan_blockers.sh` -> OK
- Security notes:
  - BYOK api key is local-only and stored encrypted at rest via Electron `safeStorage` (never logged; never sent to server).
  - The Playwright e2e asserts no plaintext api key is present anywhere under the Electron userData directory (string scan).
- Behavior notes:
  - When BYOK is enabled, chat uses direct `/v1/chat/completions` to the configured OpenAI-compatible provider; server DB/audit is not used for BYOK chats.

## [2026-02-16 23:17] - 任务：Task 14/15（Alpha QA 覆盖 + 证据补齐）
- 原始需求：把桌面端 data dir 迁移（Task 14）与 BYOK chat-only（Task 15）的验收做得更完整：纳入 alpha QA runner，补齐可回放的证据截图，并提升 e2e 稳定性。
- 实现目标/逻辑：
  - QA 覆盖：`scripts/qa_alpha.sh` 的 e2e 列表纳入 `electron-userdata-migration.spec.ts` 与 `electron-byok-chat.spec.ts`。
  - 稳定性：alpha e2e 统一加 `--workers=1`，避免多 Electron 并发导致的偶发 timeout（例如 plugin e2e 在资源紧张时超时）。
  - 证据：两条 e2e 额外产出截图到 `.sisyphus/evidence/`：
    - `task-14-userdata-migrate.png` / `task-14-userdata-migrate-fail.png`
    - `task-15-byok.png`
- 验证（本次会话）：
  - `npm -C client run e2e -- electron-userdata-migration.spec.ts` -> 2 passed
  - `npm -C client run e2e -- electron-byok-chat.spec.ts` -> 1 passed
  - `./scripts/ci.sh` -> ALL GREEN（通过注入本地依赖端口的方式运行）
  - `./scripts/qa_alpha.sh` -> ALL GREEN（同上，且 e2e 使用 `--workers=1`）
- 遗留/约束：证据/脚本不包含任何真实 key/内网地址；BYOK key 仅本机加密存储，且 e2e 仍以“磁盘无明文 key”作为强约束。

## [2026-02-16 23:39] - 任务：Task 13（计划对齐：Windows NSIS silent install 验证）
- 原始需求：计划 Task 13 要求 Windows runner 可执行 NSIS silent install，并能通过 `/DATA_DIR=...` 指定数据目录，且安装后写入稳定配置文件。
- 实现目标/逻辑：已在 release workflow 的 Windows job 中加入自动化验证步骤：执行安装器 `/S /DATA_DIR=... /D=...`，并断言 `%APPDATA%\Para Desktop\para.config.json` 的 `userDataDir` 与指定路径一致，且 data dir 下存在 `logs/cache/plugins` 子目录。
- 核心变更：`.github/workflows/release.yml`
- 约束：不在仓库内写入任何真实密钥/内网地址；验证使用临时目录并在 job 内清理。

## [2026-02-16 23:48] - 任务：Task 25（qa_alpha 自包含：动态端口 deps + 自动清理）
- 原始需求：让 `scripts/qa_alpha.sh` 在本机更接近“权威一键门禁”：不依赖用户手动启动 Postgres/Redis、不与本机默认端口冲突，并保证跑完后自动清理容器与卷。
- 实现目标/逻辑：
  - 若未设置 `DATABASE_URL/CELERY_BROKER_URL/WS_REDIS_URL`：脚本会选择两个空闲端口，使用独立 `docker compose -p <project>` 启动 postgres/redis，等待 health=healthy 后导出三项 env，再执行 `./scripts/ci.sh` + Electron e2e。
  - 若用户已设置三项 env：脚本复用现有 deps，不做启动/清理。
  - 清理：通过 trap 在脚本结束时 `docker compose down -v`。
- 核心变更：`scripts/qa_alpha.sh`
- 验证：本次会话中以“完全不设置 deps env”的方式运行 `./scripts/qa_alpha.sh`，可全绿且最后自动清理。

## [2026-02-17 12:14] - 任务：Task 16（迁移演练 dry-run：复制数据到新环境并做一致性校验）
- 原始需求：提供一套可重复的迁移演练流程：从旧环境复制 DB+资产到 staging，并跑一致性校验（rowcount/孤儿行/资产抽样可读）与 `/api/v1/health` smoke；要求支持 `--dry-run` 只打印命令；严格无 secrets 入库且日志脱敏。
- 实现目标/逻辑：
  - 入口脚本 `deploy/prod/migration/dry_run.sh`：提供 `--help`（确定性计划）与 `--dry-run`（基于 env 打印命令清单），执行模式依次执行 dump/restore/rsync/validate/smoke。
  - 无新依赖：DB 校验与资产抽样校验均通过 `psql` 执行 SQL（Python 脚本仅做解析与文件检查），不引入新的 pip/npm 依赖。
  - 安全：所有 DSN 来自环境变量；输出统一脱敏（不打印密码）；临时 dump 默认落在 `/tmp` 工作目录，避免污染仓库与触发扫描门禁。
  - 资产映射：考虑 DB 中常见容器内路径前缀（如 `/app/.data/...`），校验脚本通过 `--assets-root` 把 DB 路径映射到真实磁盘目录。
- 核心变更：
  - `deploy/prod/migration/README.md`
  - `deploy/prod/migration/dry_run.sh`
  - `deploy/prod/migration/validate_db.py`
  - `deploy/prod/migration/validate_assets.py`
  - `deploy/prod/docker-compose.dryrun.yml`
- 遗留/约束：严格不修改 `deploy/prod/docker-compose.yml` 的生产行为；不写入任何真实 DSN/密码/内网 IP/真实主机名。

## [2026-02-17 17:00] - 任务：Task 26（CI push main：Linux dir 打包 + fuses 校验；失败时上传 linux-unpacked）
- 原始需求：在 `push` 到 `main` 时，CI 额外执行 Linux `dir` 打包与 `verify:fuses`；上述两步不在 `pull_request`/`workflow_call` 场景运行；当且仅当“Linux 打包或 verify:fuses 失败”时上传 `client/dist-electron/linux-unpacked/**` artifacts（用于排障），其他失败（例如 server pytest）不上传。
- 实现目标/逻辑：在 `.github/workflows/ci.yml` 中新增 3 个最小 step，并通过严格条件控制行为：
  - 打包/校验 step：`if: github.event_name == 'push' && github.ref == 'refs/heads/main'`，避免 release 复用 `workflow_call` 时误跑。
  - artifacts step：`if: ... && always() && (steps.<id>.outcome == 'failure' || ...)`，仅在这两步失败时上传；并设置 `if-no-files-found: ignore`，避免“打包失败未产出目录”导致 artifacts step 二次失败掩盖根因。
- 核心变更：`.github/workflows/ci.yml`
- 遗留/约束：不修改 `.github/workflows/release.yml`；不改变 `./scripts/ci.sh` 作为权威门禁；不引入非官方 actions 依赖。

## [2026-02-17 13:00] - 任务：修复 Desktop Linux 打包 afterPack/verify-fuses 可执行文件定位（硬阻断）
- 原始需求：`npm -C client run package:linux` 在 afterPack 阶段失败，原因是 `client/scripts/afterPack-fuses.cjs` 按 `productName=Para Desktop` 拼出路径，但 Linux `dir` 产物中主可执行文件实际为 `ai-girlfriend-client`；这也导致 CI(push main) 新增的 Linux 打包 + `verify:fuses` step 无法通过。
- 实现目标/逻辑：在 `afterPack-fuses` 与 `verify-fuses` 中实现“多候选 + 目录扫描兜底”的可执行文件定位策略：优先使用可用的 `executableName`（context/appInfo 或 `package.json build.*`）-> `package.json name`；显式排除 `chrome-sandbox`/`chrome_crashpad_handler`；仅在候选全部失败时扫描 `appOutDir` 并选择“最大体积且可执行、且非排除名单”的文件作为主 binary。
- 核心变更：`client/scripts/afterPack-fuses.cjs`、`client/scripts/verify-fuses.js`。
- 验证：
  - `npm -C client run package:linux` -> success（afterPack 可稳定定位并 flip fuses）
  - `npm -C client run verify:fuses -- --platform linux --appOutDir dist-electron/linux-unpacked` -> PASS
  - `node client/scripts/verify-fuses.js --exe client/dist-electron/linux-unpacked/ai-girlfriend-client` -> PASS

## [2026-02-17 13:40] - 任务：Task 26（桌面端：本地明文敏感信息扫描验收闭环）
- 原始需求：在 Playwright/Electron e2e 中生成临时 `userData` 后递归扫描 `userData/appData`，禁止落盘任何明文敏感信息（至少覆盖：access_token/refresh_token 原文、`Bearer `、疑似 `sk-...`、`OPENAI_API_KEY=`、`api_key` 等）；且 CI 环境 `safeStorage` 不可用时允许 fail-closed 并仍通过测试。
- 实现目标/逻辑：
  - `client/playwright/electron-login.spec.ts` 增加无依赖扫描：递归列出文件，仅扫描 <=1MiB 小文件；支持 literal + regex needles；命中仅记录 `filePath+needleName`，不打印 token/key 原文。
  - 测试内将 `XDG_CONFIG_HOME` 指向临时目录，确保 `appData` 可控且扫描不会误扫宿主机真实配置目录。
  - 新增基线用例：`PARA_ENFORCE_SECURE_TOKEN_STORAGE=1` 下，若登录成功则断言 `auth.tokens.json.secure=true`；若登录失败则断言 UI 提示“本机安全存储不可用”且 `auth.tokens.json` 不存在；两分支都要求扫描 0 命中。
  - 额外强化：把 stub 下发的 `access_token/refresh_token` 作为 literal needle 参与扫描，验证“明文 token 值不落盘”。
- 核心变更：`client/playwright/electron-login.spec.ts`。
- 遗留/约束：不引入新依赖；扫描默认只覆盖小文件；任何失败输出不得回显明文 secrets。
- 验证：`npm -C client run build:electron`；`npm -C client run e2e -- electron-login.spec.ts`。

## [2026-02-17 19:40] - 任务：Task 19（para_appenc：生产启用 + 桌面端端到端加密登录请求/响应）
- 原始需求：
  - 生产环境必须 fail-fast：`ENV=prod|production` 下若未启用 appenc（`PARA_APPENC_ENABLED=1` 且 keys 非空）禁止服务端启动，避免“忘开”。
  - 兼容：server 启用 appenc 后，明文 JSON 仍可用（middleware 旁路）。
  - 桌面端（server 模式、非 BYOK）：提供开关默认关闭；开启后至少让 `/api/v1/auth/login` 的 JSON POST 走加密 envelope（`X-Para-Enc: v1` + `X-Para-Enc-Resp: v1`），并正确解密响应。
- 实现目标/逻辑：
  - Server：在 `Settings._validate_prod_config()` 增加硬校验，prod 下要求 `para_appenc_enabled=True` 且 keys 非空；同时保持 middleware 的“header opt-in”语义不变（不带 `X-Para-Enc` 则不解密）。
  - Desktop：复用既有 `APP_ENC_CONFIG`（env 驱动，默认关闭），将 appenc 能力从 `fetchAuthedJson()` 扩展到未鉴权的 JSON POST（新增 `fetchJson()`），并让 `loginAndGetMe()` 走该路径；响应若带 `X-Para-Enc: v1` 则按 AAD 解密。
- 核心变更：
  - `server/app/core/config.py`（prod guard：要求启用 appenc）
  - `server/tests/test_task_1_4_prod_config.py`（补齐 prod guard 覆盖与 env 清理）
  - `server/tests/test_task_19_appenc_login.py`（真实 `/api/v1/auth/login` appenc 闭环）
  - `client/src/main/index.ts`（新增 `fetchJson()`，login 支持 appenc）
- 开关/参数：
  - Desktop 开关：`PARA_APPENC_ENABLED=1`（默认关闭）
  - Desktop keys：`PARA_APPENC_KEYS='kid:base64url_32bytes[,kid2:...]'` + `PARA_APPENC_PRIMARY_KID=<kid>`（必须存在于 keys 中）
  - Server keys：`PARA_APPENC_KEYS='kid:base64url_32bytes[,kid2:...]'`（prod 下必须非空）
- 已知限制：仅覆盖 `Content-Type: application/json` 且非空 body 的请求；GET/空 body 不加密。
- 验证：`cd server && uv run pytest -k task_19`；`./scripts/ci.sh`。

## [2026-02-17 20:05] - 任务：Task 19（补记：服务端 env 解析与 keys 格式）
- 背景：`para_appenc_keys` 是 dict 类型，pydantic-settings 默认会对复杂类型 env 值做 JSON decoding；这会导致 `PARA_APPENC_KEYS='k1:....'` 这种自定义格式在进入 field_validator 之前就解析失败。
- 处理：在 `server/app/core/config.py` 的 `Settings.model_config` 里设置 `enable_decoding=False`，让复杂类型的 env 值保持原样字符串，再交给自定义 `field_validator` 解析（从而支持 `kid:base64url_32bytes[,kid2:...]`）。
- 兼容：同时支持 JSON dict 字符串（`{"kid":"base64url_32bytes"}`）作为 `PARA_APPENC_KEYS` 输入，便于 compose/模板场景使用 JSON。

## [2026-02-17 18:57] - 任务：Task 26 桌面端安全基线（fuses 校验 + 禁用危险开关 + 本地数据加密/脱敏）完成勾选与证据补齐
- 原始需求：更新 `.sisyphus/plans/para-completion.md`，将 Task 26 及其验收项勾选为完成并补充最小证据；同时把完成记录追加到 notepad 与 `.ai_session.md`。
- 实现目标/逻辑：仅做文档层最小增量（checkbox + 可复查引用）；不修改任何业务代码、不改动 CI/release workflow 内容；证据引用必须能回溯到具体文件路径/step id/命令行。
- 核心变更：`.sisyphus/plans/para-completion.md`、`.sisyphus/notepads/para-completion/learnings.md`、`.ai_session.md`。
- 证据：
  - Release：`.github/workflows/release.yml` job `windows-nsis` step `Verify fuses (packaged binary)` → `npm -C client run verify:fuses`
  - CI（push main only）：`.github/workflows/ci.yml` step ids `package_linux_dir` / `verify_fuses_linux` → `npm -C client run package:linux` + `npm -C client run verify:fuses -- --platform linux --appOutDir dist-electron/linux-unpacked`
  - 明文扫描：`client/playwright/electron-login.spec.ts` 的 `scanDirsForPlaintextSecrets()` / `getDefaultSecretNeedles()`，用例 `Electron login: secure token storage baseline (CI stable: fail-closed or encrypted at rest + scan userData/appData)` 递归扫描 userData/appData，断言 `hits == []`
  - 本次验证：`./scripts/ci.sh`（已全绿）；`npm -C client run e2e -- electron-login.spec.ts`（已 4 passed）
  - 截图（仓库内现存）：`.sisyphus/evidence/task-26-login-secure-storage-fail-closed.png`

## [2026-02-17 20:20] - 任务：Task 21（聊天与 WS：从 fake 模式收口为生产可用）
- 原始需求：WS `/ws/v1` 的 chat streaming 在生产必须走“admin-managed channel + routing”（`AdminKV(namespace='llm_routing', key='global').default_chat_channel_id` -> `AdminLLMChannel(purpose='chat', enabled)`，解密 `api_key_enc`），非 prod 允许回退 env；并通过客户端心跳与/或 Nginx timeout 配置确保反代下空闲不易断。
- 实现目标/逻辑（最小增量）：
  - Server：保持 `OPENAI_MODE` 作为 fake/openai 开关，但当 `OPENAI_MODE=openai` 时优先从 admin routing 解析 chat 渠道的 `base_url/api_key/model/timeout`；仅当 routing 不可用且非 prod 才回退 `OPENAI_BASE_URL/OPENAI_API_KEY/OPENAI_MODEL`。
  - Prod 护栏：延续 `Settings` 的 prod 校验（已禁止 `OPENAI_MODE=fake`）；并在运行期对“chat routing 未配置/不可用”给出清晰错误，避免误用 env 静默上线。
  - Client：`WsV1Client` 建连后每 25s 发送一次 `PING`，断线/关闭/重连时清理定时器，避免 Nginx `proxy_read_timeout` 空闲断链。
  - Tests：复用现有 OpenAI SSE stub，但改为写入 admin channel + routing，并将 env 故意置为错误值，以证明请求的 base_url/Authorization/model 来自 admin channel 而非 env。

## [2026-02-18] - 任务：Task 17（切流 runbook 补齐）+ 生产配置现状核查（关键发现）
- 原始需求：为计划 Task 17 补齐生产切流/回滚 runbook 与可复制脚本；并对 `pscly.cc` 的当前 Settings 做“安全核查式”的只读验证，输出关键差距与后续必做项（不泄露 secrets）。
- 核心变更（Task 17）：新增/补齐 `deploy/prod/migration/cutover.sh`、新增 `deploy/prod/migration/PROD_CUTOVER_RUNBOOK.md`、更新 `deploy/prod/migration/README.md`（切流/回滚步骤与 CHECKPOINT 门禁）。
- 关键生产发现（只读安全检查，pscly.cc）：当前 Settings 显示 `ENV=dev`、`OPENAI_MODE=fake`、`KNOWLEDGE_EMBEDDING_PROVIDER=local`；未设置 `ADMIN_SECRETS_MASTER_KEY`；`PARA_APPENC_ENABLED=false` 且 appenc keys 计数为 0。
- 含义/下一步：为满足计划 Task 19/21 与真实生产可用性，需要将 `ENV` 切到 `production` 并注入必需环境变量；在服务器侧生成 `ADMIN_SECRETS_MASTER_KEY` 与 appenc keys（禁止打印/写入仓库/日志）；随后在 admin-web 创建 LLM channels 并配置 routing；最后在 Nginx 反代下执行 WS/token streaming 的 smoke（连通性/流式/超时/断线重连）。
- 安全约束：严禁把任何密钥/口令/内网地址写入仓库或粘贴进文档；核查证据仅保留在服务器侧（运维输出/配置侧可追溯），仓库仅记录结论与操作步骤。

## [2026-02-18 13:55] - 任务：计划收口（Task 17/19/21：production + openai + appenc + admin routing + cutover evidence）
- 原始需求：收口生产部署与计划文档：修复 cutover 的 DB restore 流程使其可重复执行；生产 compose 注入 `ADMIN_SECRETS_MASTER_KEY`；计划文件勾选 Task 17/19/21 并补齐证据；notepads 与 `.ai_session.md` 追加“真实生产切换与坑位”。
- 实现目标/逻辑：
  - 修复 pg_restore clean 坑：真实 cutover 中 `pg_restore --clean --if-exists` 会在 drop constraint/index 时因外键依赖顺序失败（典型为 `users_pkey` 与 `invite_redemptions_user_id_fkey` 依赖链）。策略改为 restore 前先 `DROP SCHEMA public CASCADE; CREATE SCHEMA public;`，再 `pg_restore --no-owner --no-acl --exit-on-error ...`，保证生产可重复执行。
  - 生产 prod guard：`ENV=production` 下 Settings fail-fast 的必需项（`ADMIN_SECRETS_MASTER_KEY`、OpenAI provider、`PARA_APPENC_ENABLED=1` + keys 非空、admin routing）必须由服务器侧 `.env` 注入；compose 需要显式把 `ADMIN_SECRETS_MASTER_KEY` 传入 api/worker/migrate。
- 核心变更：`deploy/prod/migration/cutover.sh`、`deploy/prod/docker-compose.yml`、`.sisyphus/plans/para-completion.md`、`.sisyphus/notepads/para-completion/learnings.md`。
- 证据：生产切流/验收证据目录（仅服务器留存，不入 git）：`/root/dockers/para/backups/evidence/task-17/20260218134822/`。
- 遗留/约束：仓库内不记录任何 DSN/IP/token/api key/密码；破坏性 restore 仍需 `--i-know-what-im-doing` gate；此处仅收口脚本与文档。

## [2026-02-18 14:23] - 任务：Task 10（生产 admin-web 可选 E2E：Channels CRUD + 测试连接）
- 原始需求：补齐 Task 10 剩余验收项的“可选运行”Playwright Web E2E：在真实 `https://para.pscly.cc/admin` 上完成登录、进入 `AI / Channels`、CRUD 临时渠道、并对现有渠道执行“测试连接”。
- 实现目标/逻辑：新增 `client/playwright/web-admin-llm-channels.prod.spec.ts`，默认 `test.skip()`；仅当 `PARA_E2E_ADMIN_WEB_ENABLED=1` 且注入 `PARA_ADMIN_EMAIL/PARA_ADMIN_PASSWORD` 才允许执行；base url 可用 `PARA_ADMIN_WEB_BASE_URL` 覆盖（默认 `https://para.pscly.cc/admin`）。
- 核心变更：`client/playwright/web-admin-llm-channels.prod.spec.ts`（选择器优先 `getByRole/getByLabel/getByText`；删除使用 `page.once('dialog', ...)` accept confirm；通过后写入 `.sisyphus/evidence/task-10-admin-channels.png`）。
- 遗留/约束：CRUD 需要 `super_admin`；“测试连接”优先断言 `ok=true`，若上游不可达则退而断言 `ok=(true|false)` 至少可见（确保操作可执行且给出结果）；严禁在日志/代码中写入或打印任何明文密码/token/key。

## [2026-02-18 14:43] - 任务：Task 10（补齐计划验收勾选与生产验证引用）
- 原始需求：补齐 Task 10 验收。
- 实现目标/逻辑：新增 opt-in prod admin-web E2E（默认跳过；仅在显式 env 开启时访问真实站点）以支持生产验收可复查。
- 核心变更：`client/playwright/web-admin-llm-channels.prod.spec.ts`、`.sisyphus/evidence/task-10-admin-channels.png`、`.sisyphus/plans/para-completion.md`。
- 遗留/约束：测试默认 `test.skip()`；生产验证时使用临时 admin（创建后已 set-inactive）；不写入任何明文密码（只允许变量名/命令模板）。

## [2026-02-18 19:17] - 任务：更新计划进度（first-user-admin-lockdown：Task 2 已完成并留证）
- 原始需求：将 `.sisyphus/plans/first-user-admin-lockdown.md` 的 Progress 中 Task 2 勾选完成，并补一条可复查的 pytest 通过证据（含时间）；不改任何代码、不运行测试。
- 实现目标/逻辑：
  - 并发互斥：bootstrap 临界区用 `AdminKV(namespace='bootstrap', key='first_user')` 哨兵行 + 行锁序列化（row lock）。
  - 注册收口：首用户可无邀请码 bootstrap；之后默认 invite-only；由 `invite_registration_enabled` gating，关闭时统一 403 `registration_closed`。
  - 错误细节：非 bootstrap 且缺邀请码 403 `invite_code_required`；开关关闭时即便带邀请码也 403 `registration_closed`。
- 核心变更：`.sisyphus/plans/first-user-admin-lockdown.md`、`.ai_session.md`（仅文档）。
- 验证（来自本机既有绿灯结果；本次仅做记录）：`cd server && uv run pytest -q` -> PASS（2026-02-18 19:17）。
